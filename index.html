<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>ICTEX - Trading Platform</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- MODIFICATION: Preload critical images for faster loading -->
    <link rel="preload" as="image" href="https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/Ictex%2F1758033622292.webp?alt=media&token=36f86666-dcfc-4614-a07f-9e3f8bf9a108">
    <link rel="preload" as="image" href="https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/AddText_09-05-10.12.27.webp?alt=media&token=1d020904-baef-437f-8c6e-6032fc32d5d5">
    <link rel="preload" as="image" href="https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/Bitcoin%20block.jpeg?alt=media&token=36bd8668-84ae-429a-a319-0a5e8392b493">
    <!-- Firebase SDK Scripts -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <style>
        /* === MODIFICATION: VIBRANT & PREMIUM COLOR SCHEME === */
        :root {
            --bg-color: #0D0F11; /* Darker Background */
            --primary-surface: #101215; /* Darker Header/Modal Background */
            --secondary-surface: #2B3139;
            --text-primary: #EAECEF;
            --text-secondary: #707A8A;
            /* MODIFICATION: Darker green candle color */
            --color-up: #00C853; 
            --color-down: #FF3B30; /* Vibrant Red */
            --color-accent: #2962ff; 
            --color-green-accent: #00C853; 
            --color-golden: #FFC107;
            --color-purple: #9C27B0;
            --border-color: #25282F; /* Darker Border */
            --color-pending: #ff9800;
            --color-rank-1: #ffd700;
            --color-rank-2: #c0c0c0;
            --color-rank-3: #cd7f32;
        }
        body {
            background-color: var(--bg-color);
        }
        .app-container {
             background-color: var(--bg-color);
        }

        /* V4 Header Redesign */
        .app-header {
            padding: 10px 15px;
            background-color: var(--primary-surface);
            display: flex;
            flex-direction: column;
            gap: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .header-top-row {
            display: grid;
            grid-template-columns: 40px 1fr 40px;
            align-items: center;
            gap: 15px;
            width: 100%;
        }
        .header-icon-btn-new {
            background: none;
            color: var(--text-secondary);
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            padding: 0;
            border-radius: 50%;
            border: 2px solid var(--border-color);
            transition: all 0.3s ease;
        }
        .header-icon-btn-new:hover {
            transform: translateY(-2px);
        }

        #header-profile-btn.verified-profile {
            border-color: var(--color-up);
        }
        #header-profile-btn.unverified-profile {
            border-color: var(--color-down);
        }

        #header-profile-pic-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        #header-notification-badge {
            position: absolute;
            top: -2px;
            right: -2px;
            background-color: var(--color-down);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 11px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--primary-surface);
            line-height: 1;
            box-shadow: 0 1px 3px rgba(0,0,0,0.4);
        }

        .header-icon-btn-new.square {
            background: linear-gradient(135deg, #2EEC92, var(--color-up));
            border-radius: 8px;
            border: none;
            color: var(--text-primary);
            box-shadow: 0 4px 12px rgba(0, 200, 83, 0.2);
        }
        #header-wallet-icon {
            width: 26px;
            height: 26px;
        }
        .header-icon-btn-new svg {
            width: 24px;
            height: 24px;
        }
        .header-balance-container-new {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #balance-amount-new {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-primary);
            text-shadow: 0 0 5px rgba(234, 236, 239, 0.2);
        }
        #balance-account-type {
            font-size: 0.8rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
        }
        #balance-account-type svg {
            width: 16px;
            height: 16px;
        }
        
        .header-market-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        #market-selector-btn-new {
            background: none;
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 0;
        }
        .market-icon-wrapper-header {
            display: flex;
            align-items: center;
            position: relative;
            width: 36px;
            height: 24px;
        }
        .market-icon-header {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--bg-color);
            position: absolute;
        }
        .market-icon-header.logo2 {
            margin-left: 12px;
        }

        #current-market-name-new {
            font-size: 1rem;
            font-weight: 500;
        }
        #current-market-payout {
            font-size: 1rem;
            font-weight: 700;
            color: var(--color-up);
            margin-right: 4px;
        }
        .chart-top-right-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .chart-control-btn {
            background: none;
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            padding: 5px;
            font-size: 0.9rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .chart-control-btn svg {
            width: 22px;
            height: 22px;
        }
        
        /* === START: UPDATED CONTROLS SECTION STYLES === */
        .controls-section.new-controls {
            padding: 10px 15px 15px;
            background-color: var(--bg-color);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .controls-row-1 {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            color: #bdc3c7;
            margin-bottom: 5px;
        }
        .payout-info-new {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .payout-info-new svg {
            width: 16px;
            height: 16px;
            color: #7f8c8d;
        }
        .controls-row-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .input-stepper {
            display: flex;
            align-items: center;
            background-color: #1c1f26; 
            border-radius: 8px;
            overflow: hidden;
            height: 48px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.5);
        }
        .stepper-display {
            flex-grow: 2;
            text-align: center;
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-primary);
            cursor: pointer;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .stepper-display::before, .stepper-display::after {
            content: '';
            position: absolute;
            top: 20%;
            height: 60%;
            width: 1px;
            background-color: #465a70;
        }
        .stepper-display::before { left: 0; }
        .stepper-display::after { right: 0; }

        .stepper-btn {
            flex-grow: 1;
            background: none;
            border: none;
            color: #EAECEF;
            font-size: 1.8rem;
            font-weight: 300;
            cursor: pointer;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }
        .stepper-btn:active {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .action-buttons-new {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 10px;
            align-items: center;
            margin-top: 5px;
        }
        .btn-new {
            border: none;
            border-radius: 8px;
            padding: 15px 20px;
            font-size: 1.1rem;
            font-weight: 700;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 54px;
            transition: all 0.2s;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        .btn-new:active {
            filter: brightness(0.9);
            transform: translateY(1px);
        }
        .btn-up-new { 
            background: linear-gradient(180deg, var(--color-up), #00b36e);
            box-shadow: 0 4px 0 #008753, 0 5px 10px rgba(0, 200, 83, 0.3);
        }
        .btn-down-new { 
            background: linear-gradient(180deg, var(--color-down), #d32f2f);
            box-shadow: 0 4px 0 #a02525, 0 5px 10px rgba(255, 59, 48, 0.3);
        }
        
        .btn-new .arrow-icon {
            font-size: 1.5rem;
            line-height: 1;
            font-weight: 400;
        }
        #bet-options-btn {
            background-color: #1c1f26; 
            border-radius: 8px;
            width: 54px;
            height: 54px;
            padding: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
            transition: background-color 0.2s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
         #bet-options-btn:active {
            background-color: #3b4652;
            transform: translateY(1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        #bet-options-btn img {
            width: 32px;
            height: 32px;
        }
        /* === END: UPDATED CONTROLS SECTION STYLES === */

        .profile-level-badge {
            position: absolute;
            bottom: 0;
            left: -4px;
            background-color: #2962ff;
            color: white;
            border-radius: 5px;
            width: 16px;
            height: 16px;
            font-size: 10px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--primary-surface);
        }
        .profile-level-badge svg {
            width: 8px;
            height: 8px;
        }
        .profile-status-badge-img {
            position: absolute;
            bottom: -2px;
            left: -4px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            object-fit: contain;
        }
        #header-verified-badge {
            display: none !important;
        }

        /* New Nav Bar */
        .app-nav.new-nav {
            background-color: var(--primary-surface);
            padding: 5px 0;
            border-top: 1px solid var(--border-color);
            box-shadow: 0 -4px 15px rgba(0,0,0,0.2);
        }
        .nav-btn-new {
            flex: 1;
            padding: 5px;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            transition: color 0.2s, transform 0.2s;
        }
        .nav-btn-new:active {
            transform: scale(0.95);
        }
        .nav-btn-new.active {
            color: var(--color-up);
        }
        .nav-btn-new svg {
            width: 24px;
            height: 24px;
        }
        .nav-btn-new span {
            font-size: 0.75rem;
            font-weight: 500;
        }

        /* V4 Sentiment Bar */
        .sentiment-bar {
            position: absolute;
            left: 10px;
            top: 35px;
            bottom: 35px;
            width: 4px;
            z-index: 25;
            display: flex;
            flex-direction: column;
            background: rgba(112, 122, 138, 0.2);
            border-radius: 2px;
        }
        .sentiment-bar-inner {
            width: 100%;
            transition: height 0.5s ease;
            border-radius: 2px;
        }
        #sentiment-up { background-color: var(--color-up); }
        #sentiment-down { background-color: var(--color-down); }
        .sentiment-percent {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.7rem;
            font-weight: 500;
            color: var(--text-secondary);
            width: 30px;
            text-align: center;
        }
        #sentiment-percent-up { bottom: -18px; color: var(--color-up); }
        #sentiment-percent-down { top: -18px; color: var(--color-down); }

        /* === NEW MENTOR SYSTEM STYLES (PREMIUM REDESIGN) === */
        .mentor-task-list {
            list-style: none; padding: 0; margin: 25px 0; display: flex; flex-direction: column; gap: 15px;
        }
        .mentor-task-item {
            background-color: var(--primary-surface); border: 1px solid var(--border-color);
            padding: 15px 20px; border-radius: 12px; display: flex; align-items: center; gap: 15px;
            transition: all 0.3s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .mentor-task-item .icon { width: 28px; height: 28px; color: var(--text-secondary); flex-shrink: 0; }
        .mentor-task-item .text { flex-grow: 1; font-weight: 500; }
        .mentor-task-item .status-icon { width: 24px; height: 24px; color: var(--color-pending); }
        .mentor-task-item.completed { border-left: 4px solid var(--color-up); }
        .mentor-task-item.completed .icon { color: var(--color-up); }
        .mentor-task-item.completed .status-icon { color: var(--color-up); }

        .mentor-hero-card {
            background: linear-gradient(145deg, var(--secondary-surface), var(--primary-surface));
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 25px;
            text-align: center;
            margin-bottom: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }
        .mentor-hero-card .label { font-size: 1rem; color: var(--text-secondary); margin-bottom: 8px; }
        .mentor-hero-card .value { font-size: 2.8rem; font-weight: 700; color: var(--color-green-accent); letter-spacing: 1px; }
        .mentor-hero-card .sub-value { font-size: 0.9rem; color: var(--text-secondary); margin-top: 6px; }

        .mentor-dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; }
        .mentor-stat-card {
            background-color: var(--primary-surface); padding: 20px; border-radius: 12px;
            border: 1px solid var(--border-color); text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .mentor-stat-card .label { font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 8px; }
        .mentor-stat-card .value { font-size: 1.8rem; font-weight: 700; color: var(--text-primary); }
        
        .mentor-id-card {
            background-color: var(--primary-surface); padding: 15px 20px; border-radius: 12px;
            display: flex; justify-content: space-between; align-items: center;
            border: 1px solid var(--border-color); margin-bottom: 25px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .mentor-id-card .label { color: var(--text-secondary); }
        .mentor-id-card .id-code { font-family: monospace; font-size: 1.2rem; font-weight: 700; color: var(--color-golden); }
        .mentor-id-card .copy-btn { background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 5px;}

        /* PREMIUM Salary Section */
        .mentor-section-card {
             background-color: var(--primary-surface); padding: 20px; border-radius: 16px;
             border: 1px solid var(--border-color); margin-bottom: 15px;
             box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .mentor-section-card h3 { margin: 0 0 20px 0; font-size: 1.2rem; text-align: center; font-weight: 500; }
        .salary-tier-list { display: flex; flex-direction: column; gap: 15px; }
        .salary-tier-card {
            background: linear-gradient(135deg, rgba(43, 49, 57, 0.5), rgba(16, 18, 21, 0.5));
            border: 1px solid var(--border-color);
            padding: 20px;
            border-radius: 12px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .salary-tier-card:hover { transform: translateY(-3px); border-color: var(--color-accent); box-shadow: 0 5px 15px rgba(41, 98, 255, 0.2); }
        .salary-tier-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .salary-tier-title { font-size: 1.1rem; font-weight: 700; color: var(--text-primary); }
        .salary-tier-reward { font-size: 1.5rem; font-weight: 700; color: var(--color-golden); }
        .salary-tier-progress-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        .salary-progress-bar { background: var(--secondary-surface); height: 8px; border-radius: 4px; overflow: hidden; margin-bottom: 15px; }
        .salary-progress-bar-inner {
            background: linear-gradient(90deg, var(--color-accent), var(--color-golden));
            height: 100%; width: 0%; border-radius: 4px; transition: width 0.5s ease;
        }
        .salary-apply-btn {
            display: block; width: 100%;
            background: var(--color-accent); color: white; padding: 12px; border-radius: 8px;
            font-weight: 700; font-size: 1rem; text-align: center; border: none; cursor: pointer;
            transition: all 0.2s;
        }
        .salary-apply-btn:disabled { background: var(--text-secondary); cursor: not-allowed; opacity: 0.6; }

        /* MODIFICATION: Updated Mentor User List Item Style */
        .mentor-user-list-item {
            background: var(--primary-surface); padding: 15px; border-radius: 12px; margin-bottom: 10px;
            display: flex; flex-direction: column; gap: 12px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .mentor-user-top-row { display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center;}
        .mentor-user-info .name { font-weight: 500; }
        .mentor-user-info .uid { font-size: 0.8rem; color: var(--text-secondary); font-family: monospace; }
        .mentor-user-info .status { font-size: 0.8rem; font-weight: 700; text-transform: uppercase; margin-top: 4px; }
        .mentor-user-info .status.active { color: var(--color-up); }
        .mentor-user-info .status.inactive { color: var(--text-secondary); }
        .mentor-user-stats { display: flex; flex-direction: column; gap: 8px; align-items: flex-end; }
        .mentor-user-stats .stat { text-align: right; }
        .mentor-user-stats .stat .label { font-size: 0.75rem; color: var(--text-secondary); }
        .mentor-user-stats .stat .value { font-weight: 500; font-size: 0.9rem; }
        .mentor-user-stats .stat .value.profit { color: var(--color-up); }
        .mentor-user-stats .stat .value.loss { color: var(--color-down); }

        .search-input-group { position: relative; margin-bottom: 15px; }
        .search-input-group input { width: 100%; padding-right: 40px; }
        .search-input-group .icon { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: var(--text-secondary); }
        
        .mentor-user-progress { display: none; }


        /* Hide old elements */
        #main-app-header .header-actions, #main-app-header #header-balance-container,
        .chart-top-bar,
        .controls-section:not(.new-controls),
        .app-nav:not(.new-nav),
        #bet-expiry-modal,
        #view-support .page-header
        {
             display: none !important; 
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        button, a, input, select, div[onclick] { -webkit-tap-highlight-color: transparent; }
        button:focus, button:active,
        a:focus, a:active,
        div[onclick]:focus, div[onclick]:active {
          outline: none !important;
          -webkit-box-shadow: none !important;
          box-shadow: none !important;
        }
        html, body { height: 100%; margin: 0; overflow: hidden; }
        body { font-family: 'Roboto', sans-serif; background-color: var(--bg-color); color: var(--text-primary); display: flex; justify-content: center; align-items: center; }
        #app-loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); z-index: 9999; display: flex; justify-content: center; align-items: center; transition: opacity 0.3s ease; }
        #app-loader img { width: 120px; animation: pulse 1.5s infinite ease-in-out; }
        @keyframes pulse { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.05); opacity: 0.8; } }
        /* MODIFICATION: Dynamic width adjustment */
        #auth-container { width: 100%; max-width: 700px; height: 100%; display: none; flex-direction: column; justify-content: center; padding: 20px; overflow: hidden; position: relative; }
        .auth-form-wrapper { width: 100%; max-width: 420px; margin: 0 auto; position: absolute; left: 50%; transform: translateX(-50%); padding: 0 20px; transition: transform 0.5s cubic-bezier(0.25, 1, 0.5, 1), opacity 0.5s; }
        .auth-form-wrapper:not(.active) { transform: translateX(calc(-50% + 100vw)); opacity: 0; pointer-events: none; }
        .auth-form-wrapper.left-out { transform: translateX(calc(-50% - 100vw)); opacity: 0; }
        .auth-form-wrapper.active { transform: translateX(-50%); opacity: 1; }
        .auth-form { background: var(--primary-surface); padding: 30px 25px; border-radius: 12px; display: flex; flex-direction: column; gap: 20px; }
        /* MODIFICATION: Logo background */
        .auth-logo { width: 100px; height: 100px; object-fit: contain; margin: 0 auto 5px; border-radius: 20px; animation: logo-fade-in 0.6s cubic-bezier(0.25, 1, 0.5, 1); background-color: #000; }
        .auth-form h2 { color: var(--text-primary); text-align: center; margin: 0 0 15px 0; font-size: 1.8rem; font-weight: 700; }
        .input-group { position: relative; }
        .auth-input { width: 100%; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; font-size: 1rem; color: var(--text-primary); transition: border-color 0.2s; }
        .auth-input:focus { border-color: var(--color-accent); outline: none; }
        .auth-button { background: linear-gradient(45deg, var(--color-accent), #448aff); color: white; border: none; padding: 15px; border-radius: 8px; font-size: 1.1rem; font-weight: 700; cursor: pointer; transition: filter 0.2s ease-in-out; }
        .auth-button:hover { filter: brightness(1.1); }
        .form-toggle { text-align: center; color: var(--text-secondary); font-size: 0.9rem; }
        .form-toggle a { color: var(--color-accent); font-weight: 500; cursor: pointer; text-decoration: none; }
        .auth-extra-links { display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; padding: 0 5px; }
        .auth-extra-links a { color: var(--color-accent); font-weight: 500; cursor: pointer; text-decoration: none; }
        .auth-loader { display: none; border: 4px solid var(--secondary-surface); border-top: 4px solid var(--color-accent); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto 0; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes logo-fade-in { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        /* MODIFICATION: Dynamic width adjustment */
        #main-app-wrapper { width: 100%; max-width: 700px; height: 100%; display: none; }
        .app-container { width: 100%; height: 100%; display: flex; flex-direction: column; background-color: var(--bg-color); transition: opacity 0.3s; }
        main { display: flex; flex-direction: column; flex-grow: 1; overflow: hidden; }
        .view { display: none; flex-direction: column; flex-grow: 1; height: 100%; }
        .view.active { display: flex; }
        .chart-section { position: relative; width: 100%; flex-grow: 1; }

        #chart-utc-time-display {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 20;
            background-color: transparent;
            color: var(--text-secondary);
            padding: 4px 12px;
            font-size: 0.8rem;
            font-weight: 500;
            pointer-events: none;
            visibility: hidden;
            text-shadow: 0 0 5px rgba(0,0,0,0.7);
            transition: opacity 0.3s;
        }
        #chart-canvas { position: absolute; top: 0; left: 35px; width: calc(100% - 35px); height: 100%; background-color: var(--bg-color); cursor: grab; }
        #chart-canvas:active { cursor: grabbing; }
        #chart-loader-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); z-index: 50; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 10px; color: var(--text-primary); }
        #chart-loader-overlay .auth-loader { display: block; margin: 0; }
        
        .controls-section { transition: opacity 0.3s ease; }
        .btn:disabled { background-color: #333 !important; background-image: none; color: #777; cursor: not-allowed; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); display: flex; align-items: center; justify-content: center; z-index: 1001; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        .modal-overlay.visible { opacity: 1; pointer-events: auto; }
        .modal-content { 
            background: var(--primary-surface); 
            padding: 20px; 
            border-radius: 12px; 
            width: 90%; 
            max-width: 380px; 
            display: flex; 
            flex-direction: column; 
            gap: 15px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
            border: 1px solid var(--border-color);
        }

        /* --- NEW: Chart Tools Modal Styles --- */
        #chart-tools-modal .modal-content {
            padding: 0;
            gap: 0;
            max-width: 380px;
        }
        .chart-tools-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 10px 0 20px;
        }
        .chart-tools-tabs {
            display: flex;
        }
        .chart-tools-tab {
            padding: 15px;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.9rem;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }
        .chart-tools-tab.active {
            color: var(--color-accent);
            border-bottom-color: var(--color-accent);
            font-weight: 700;
        }

        .chart-tools-tab[data-tab="colors"], #tools-tab-colors {
            display: none !important;
        }
        #chart-tools-close-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.8rem;
            cursor: pointer;
        }
        .chart-tools-body {
            padding: 20px;
            max-height: 50vh;
            overflow-y: auto;
        }
        .chart-tools-content {
            display: none;
        }
        .chart-tools-content.active {
            display: block;
        }
        .indicator-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .indicator-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
            font-size: 1rem;
        }
        .indicator-item.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .indicator-toggle {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }
        .indicator-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .indicator-slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--secondary-surface);
            transition: .4s;
            border-radius: 34px;
        }
        .indicator-slider:before {
            position: absolute;
            content: "";
            height: 18px; width: 18px;
            left: 3px; bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .indicator-slider {
            background-color: var(--color-accent);
        }
        input:checked + .indicator-slider:before {
            transform: translateX(20px);
        }
        #tools-tab-settings p {
            text-align: center;
            color: var(--text-secondary);
        }

        /* --- NEW: Chart Display Options Modal (Bottom Sheet) --- */
        .modal-overlay.bottom-sheet {
            align-items: flex-end;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
        }
        .bottom-sheet-content {
            background-color: var(--primary-surface);
            width: 100%;
            /* MODIFICATION: Dynamic width */
            max-width: 700px;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            box-shadow: 0 -5px 25px rgba(0,0,0,0.3);
            transform: translateY(100%);
            transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            touch-action: none;
        }
        .modal-overlay.visible .bottom-sheet-content {
            transform: translateY(0);
        }
        .bottom-sheet-handle {
            width: 40px;
            height: 5px;
            background-color: var(--text-secondary);
            border-radius: 2.5px;
            margin: 8px auto 16px;
        }
        .bottom-sheet-body {
            padding: 0 15px 30px; 
            display: flex;
            flex-direction: column;
            gap: 25px;
            max-height: 70vh;
            overflow-y: auto;
        }
        .options-section h4 {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin: 0 0 12px 0;
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: space-between;
        }

        .reset-btn-inline {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            font-size: 0.8rem;
            padding: 3px 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        .options-section h4 .info-icon {
            font-size: 0.8rem;
            border: 1px solid var(--text-secondary);
            border-radius: 50%;
            width: 16px;
            height: 16px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .options-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .options-grid.chart-type-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
        }
        .option-btn {
            background-color: var(--secondary-surface);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px 15px;
            font-size: 0.9rem;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            flex-grow: 1;
            text-align: center;
        }
        .chart-type-grid .option-btn {
            padding: 12px 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .chart-type-grid .option-btn svg {
            width: 20px;
            height: 20px;
        }
        .option-btn:hover {
            background-color: #3f4651;
        }
        .option-btn.active {
            background-color: var(--color-accent);
            border-color: var(--color-accent);
            color: white;
            box-shadow: 0 0 10px rgba(41, 98, 255, 0.4);
        }
        .color-swatch-container {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            padding-bottom: 10px;
            scrollbar-width: none;
            -ms-overflow-style: none; 
        }
        .color-swatch-container::-webkit-scrollbar {
            display: none;
        }
        .color-swatch-item {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            flex-shrink: 0;
            border: 3px solid transparent;
            padding: 2px;
            transition: border-color 0.2s;
        }
        .color-swatch-item.selected {
            border-color: var(--color-accent);
        }
        .color-swatch-item div {
            width: 100%;
            height: 100%;
            border-radius: 50%;
        }


        #notification-container { position: fixed; top: 15px; left: 50%; transform: translateX(-50%); z-index: 2000; display: flex; flex-direction: column; align-items: center; gap: 8px; pointer-events: none; width: 90%; max-width: 360px; transition: opacity 0.3s ease; }
        .notification-item {
            background-color: var(--secondary-surface);
            color: var(--text-primary);
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: 500;
            font-size: 0.85rem;
            width: 100%;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.4s cubic-bezier(0.25, 1, 0.5, 1);
            border-left: 3px solid transparent;
            box-shadow: 0 3px 10px rgba(0,0,0,0.25);
        }
        .notification-item.show { opacity: 1; transform: translateY(0); }
        .notification-item.hide { opacity: 0; transform: translateY(-20px); }
        .notification-item.win { border-left-color: var(--color-up); }
        .notification-item.loss { border-left-color: var(--color-down); }
        .notification-item.info { border-left-color: var(--color-accent); }

        .app-nav { display: flex; flex-shrink: 0; }
        .page-content { overflow-y: auto; overflow-x: hidden; padding: 15px; flex-grow: 1; background-color: var(--bg-color); }
        .page-content h2 { text-align: center; margin-top: 10px; margin-bottom: 20px; }
        .page-content h3 { font-weight: 500; margin-bottom: 15px; color: var(--text-primary); }
        .page-content p { text-align: center; color: var(--text-secondary); }
        
        .history-date-header { font-size: 0.85rem; font-weight: 700; color: var(--text-secondary); padding: 15px 5px 5px; text-align: center; }
        .history-item { background-color: var(--primary-surface); border-radius: 8px; margin-bottom: 10px; cursor: pointer; overflow: hidden; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .history-item-summary { display: grid; grid-template-columns: 1fr auto; align-items: center; gap: 15px; padding: 12px 15px; }
        .hi-main-info { display: flex; flex-direction: column; gap: 8px; }
        .hi-market-info { display: flex; align-items: center; gap: 8px; font-weight: 500; }
        .hi-market-info .star-icon { font-size: 1.1rem; color: var(--color-golden); pointer-events: none; }
        .hi-market-info .payout { color: var(--text-secondary); font-size: 0.85rem; }
        .hi-investment { display: flex; align-items: center; gap: 6px; }
        .hi-investment-icon { width: 20px; height: 20px; }
        .hi-investment span { font-size: 1rem; font-weight: 500; }
        .hi-result { display: flex; flex-direction: column; align-items: flex-end; gap: 4px; }
        .hi-pnl { font-weight: 700; font-size: 1.1rem; }
        .hi-pnl.win { color: var(--color-up); }
        .hi-pnl.loss { color: var(--color-down); }
        .hi-pnl.pending { color: var(--color-pending); }
        .hi-time { font-size: 0.8rem; color: var(--text-secondary); }
        .history-item-details { max-height: 0; overflow: hidden; transition: max-height 0.35s ease-in-out, padding 0.35s ease-in-out; background-color: var(--bg-color); padding: 0 15px; }
        .history-item.expanded .history-item-details { max-height: 200px; padding: 15px; border-top: 1px solid var(--border-color); }
        .hi-details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px 15px; font-size: 0.9rem; }
        .hi-details-grid .label { color: var(--text-secondary); }
        .hi-details-grid .value { font-weight: 500; text-align: right; }
        .hi-details-grid .value.win { color: var(--color-up); }
        .hi-details-grid .value.loss { color: var(--color-down); }

        .pending-trade-timer {
            position: relative;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .pending-trade-timer .timer-text {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        .pending-trade-timer .progress-ring {
            position: absolute;
            top: 0;
            left: 0;
            transform: rotate(-90deg);
        }
        .pending-trade-timer .progress-ring__circle {
            transition: stroke-dashoffset 0.5s linear, stroke 0.5s;
            stroke: var(--color-pending);
        }
        .pending-trade-timer.win .progress-ring__circle { stroke: var(--color-up); }
        .pending-trade-timer.win .timer-text { color: var(--color-up); }
        .pending-trade-timer.loss .progress-ring__circle { stroke: var(--color-down); }
        .pending-trade-timer.loss .timer-text { color: var(--color-down); }


        .logout-button { display: block; width: 80%; margin: 40px auto; padding: 15px; background-color: var(--color-down); color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 700; cursor: pointer; }
        .profile-header { text-align: center; margin-bottom: 25px; }
        .profile-pic-container { position: relative; width: 90px; height: 90px; margin: 0 auto 15px auto; }
        .profile-pic-label { display: block; width: 100%; height: 100%; border-radius: 50%; overflow: hidden; position: relative; background-color: var(--secondary-surface); padding: 3px; cursor: pointer; }
        #profile-pic-img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
        /* MODIFICATION: Default Profile Picture Placeholder */
        .profile-pic-placeholder {
            width: 100%; height: 100%; border-radius: 50%;
            background: var(--secondary-surface);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: var(--text-secondary);
        }
        .profile-pic-placeholder svg { width: 32px; height: 32px; }
        .profile-pic-placeholder span { font-size: 0.75rem; font-weight: 500; margin-top: 4px; }
        
        #profile-info-email { font-size: 1rem; font-weight: 500; }
        #profile-info-id { font-size: 0.85rem; color: var(--text-secondary); margin-top: 4px; }
        #profile-verified-status { font-weight: 700; margin-top: 8px; display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 15px; font-size: 0.8rem; }
        #profile-verified-status.verified { background-color: rgba(0, 200, 83, 0.2); color: var(--color-up); }
        #profile-verified-status.unverified { background-color: rgba(213, 0, 0, 0.2); color: var(--color-down); }
        .page-form { display: flex; flex-direction: column; gap: 15px; }
        .form-input-group label { display: block; color: var(--text-secondary); font-size: 0.8rem; margin-bottom: 5px; }
        .form-input, select.form-input { width: 100%; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 8px; padding: 12px; font-size: 1rem; color: var(--text-primary); -webkit-appearance: none; appearance: none; }
        #manual-amount-input:focus { border-color: var(--color-accent); outline: none; box-shadow: none !important; -webkit-box-shadow: none !important; }
        .form-input:disabled { background-color: var(--secondary-surface); cursor: not-allowed; color: var(--text-secondary); }
        .email-verify-group { display: flex; align-items: center; justify-content: space-between; }
        #email-verify-status { margin-left: 10px; font-weight: 500; font-size: 0.9rem; flex-shrink: 0; }
        #email-verify-status.verified { color: var(--color-up); }
        #email-verify-status.unverified { color: var(--color-pending); cursor: pointer; text-decoration: underline; }
        .save-button { background-color: var(--color-accent); color: white; border: none; padding: 15px; border-radius: 8px; font-size: 1rem; font-weight: 700; cursor: pointer; margin-top: 10px; }
        .save-button:disabled { background: #555; cursor: not-allowed; }
        .green-button { background: linear-gradient(45deg, var(--color-green-accent), #00e676); font-size: 1.1rem; font-weight: 700; }
        .settings-link { background: var(--secondary-surface); padding: 15px; border-radius: 8px; color: var(--text-primary); text-decoration: none; display: flex; justify-content: space-between; align-items: center; font-weight: 500; }
        .settings-link:hover { background: #363a45; }
        .status-badge { font-size: 0.8rem; font-weight: 700; padding: 4px 10px; border-radius: 12px; }
        .status-verified { background-color: var(--color-up); color: white; }
        .status-pending { background-color: var(--color-pending); color: white; }
        .status-unverified { background-color: var(--color-down); color: white; }
        #kyc-nid-group { display: none; }
        .kyc-form .form-input-group { background: var(--secondary-surface); padding: 15px; border-radius: 10px; }

        .page-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 15px;
            background-color: var(--primary-surface);
            flex-shrink: 0;
        }
        .back-btn { background: none; border: none; color: var(--text-primary); cursor: pointer; padding: 5px; }
        .back-btn svg { width: 24px; height: 24px; }
        .page-header h2 { flex-grow: 1; text-align: center; margin: 0; font-size: 1.1rem; }
        .header-icon-btn { background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 5px; width: 34px; height: 34px; }
        #view-leaderboard .page-header h2,
        #view-notifications .page-header h2,
        #view-history .page-header h2,
        #view-crypto-box .page-header h2 { margin-left: 34px; }
        #view-profile .page-header { justify-content: space-between; } 
        #view-mentor-users .page-header h2 { margin-left: 0; }
        /* MODIFICATION: Fix notification badge position on profile page & change to color */
        #profile-notification-btn .header-notification-badge {
            display: none !important;
        }
        #profile-notification-btn svg.has-unread {
            color: var(--color-up);
        }
        
        /* === NEW: Settings Page List View === */
        #view-settings .page-content { padding: 15px 10px; }
        .settings-list-container { display: flex; flex-direction: column; gap: 10px; }
        .settings-list-item {
            background: linear-gradient(145deg, var(--primary-surface), #1a1d21);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            text-decoration: none;
            color: var(--text-primary);
            transition: all 0.2s ease-out;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .settings-list-item:active { 
            background-color: var(--secondary-surface); 
            transform: translateY(2px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .settings-list-item .icon {
            color: var(--text-secondary);
            width: 24px;
            height: 24px;
        }
        .settings-list-item .text {
            flex-grow: 1;
            font-weight: 500;
            font-size: 1rem;
        }
        .settings-list-item .chevron-icon {
            color: var(--text-secondary);
            width: 20px;
            height: 20px;
        }
        .settings-logout-btn {
            display: block;
            width: 100%;
            background-color: var(--primary-surface);
            border: 1px solid var(--border-color);
            color: var(--color-down);
            font-weight: 500;
            font-size: 1rem;
            padding: 15px;
            border-radius: 12px;
            cursor: pointer;
            margin-top: 30px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }


        .slider-container { display: flex; align-items: center; gap: 15px; }
        #grid-visibility-slider, #utc-time-visibility-slider { flex-grow: 1; -webkit-appearance: none; appearance: none; height: 8px; background: var(--border-color); border-radius: 4px; outline: none; }
        #grid-visibility-slider::-webkit-slider-thumb, #utc-time-visibility-slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: var(--color-accent); border-radius: 50%; cursor: pointer; }
        #grid-visibility-slider::-moz-range-thumb, #utc-time-visibility-slider::-moz-range-thumb { width: 20px; height: 20px; background: var(--color-accent); border-radius: 50%; cursor: pointer; }
        #grid-visibility-value, #utc-time-visibility-value { font-weight: 700; min-width: 10px; text-align: right; }
        
        #goto-live-btn {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 30;
            background-color: var(--color-accent);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transition: opacity 0.3s, transform 0.3s;
        }
        #goto-live-btn.visible {
            display: flex;
        }
        #goto-live-btn svg { width: 24px; height: 24px; }

        #trade-result-queue-container {
            position: absolute;
            bottom: 15px;
            left: 15px;
            z-index: 40;
            display: flex;
            flex-direction: column-reverse; 
            gap: 10px;
            pointer-events: none;
            max-width: 200px;
        }
        .trade-result-item {
            background-color: var(--secondary-surface);
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            border-left: 4px solid transparent;
            opacity: 0;
            transform: translateX(-20px);
            transition: all 0.5s cubic-bezier(0.25, 1, 0.5, 1);
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .trade-result-item.show {
            opacity: 1;
            transform: translateX(0);
        }
        .trade-result-item.win { border-left-color: var(--color-up); }
        .trade-result-item.loss { border-left-color: var(--color-down); }
        .trade-result-item.push { border-left-color: var(--text-secondary); }
        .trade-result-pnl { font-size: 1.1rem; font-weight: 700; }
        .trade-result-pnl.win { color: var(--color-up); }
        .trade-result-pnl.loss { color: var(--color-down); }
        .trade-result-pnl.push { color: var(--text-primary); }
        .trade-result-details { font-size: 0.8rem; color: var(--text-secondary); }

        .notification-list-card {
            background-color: var(--primary-surface); border-radius: 12px;
            margin-bottom: 15px; overflow: hidden;
            border-left: 4px solid var(--color-accent);
            position: relative;
            box-shadow: 0 4px 12px rgba(0,0,0,0.25);
        }
        .delete-notification-btn {
            position: absolute; top: 8px; right: 8px;
            background: var(--secondary-surface); color: var(--text-secondary);
            border: none; border-radius: 50%;
            width: 28px; height: 28px; font-size: 1.2rem;
            line-height: 1; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: background-color 0.2s, color 0.2s;
        }
        .delete-notification-btn:hover { background-color: var(--color-down); color: white; }
        .notification-list-card img { width: 100%; max-height: 200px; object-fit: cover; }
        .notification-list-content { padding: 15px 20px; }
        .notification-list-content h3 { margin: 0 0 10px; font-size: 1.1rem; padding-right: 30px; }
        .notification-list-content p { margin: 0 0 15px; font-size: 0.95rem; line-height: 1.6; text-align: left; color: var(--text-secondary); }
        .notification-list-content .notification-timestamp { font-size: 0.8rem; color: var(--text-secondary); text-align: right; margin-top: 15px; }
        .notification-link-btn { display: inline-block; background-color: var(--color-accent); color: white; padding: 10px 20px; border-radius: 8px; text-decoration: none; font-weight: 700; margin-top: 10px; transition: filter 0.2s; }
        .notification-link-btn:hover { filter: brightness(1.1); }


        .deposit-card-new { background-color: var(--primary-surface); padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.25); }
        .deposit-card-new > label { color: var(--text-secondary); font-size: 0.9rem; font-weight: 500; margin-bottom: 15px; display: block; }
        .deposit-amount-display { display: flex; align-items: center; gap: 10px; border-bottom: 2px solid var(--color-green-accent); padding-bottom: 10px; margin-bottom: 10px; }
        .dollar-sign { font-size: 2.5rem; font-weight: 700; color: var(--text-secondary); }
        #deposit-amount-usd-new { font-size: 2.5rem; font-weight: 700; color: var(--text-primary); background: none; border: none; flex-grow: 1; min-width: 0; padding: 0; }
        #deposit-amount-usd-new:focus { outline: none; }
        #deposit-amount-usd-new::placeholder { color: var(--text-secondary); font-weight: 500; }
        .quick-amount-buttons-new { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .quick-amount-btn-new { background-color: var(--secondary-surface); border: 1px solid var(--border-color); color: var(--text-primary); padding: 10px; border-radius: 20px; cursor: pointer; text-align: center; font-weight: 500; transition: all 0.2s ease; }
        .quick-amount-btn-new:hover, .quick-amount-btn-new.active { background-color: var(--color-green-accent); border-color: var(--color-green-accent); color: white; }
        
        .promo-option-btn-container { display: grid; grid-template-columns: 1fr; gap: 10px; }
        .promo-option-btn { background: linear-gradient(45deg, var(--secondary-surface), var(--primary-surface)); border: 1px solid var(--border-color); color: var(--text-primary); padding: 12px 15px; border-radius: 8px; cursor: pointer; text-align: left; font-weight: 500; transition: all 0.2s ease; display: flex; flex-direction: column; }
        .promo-option-btn:hover { border-color: var(--color-golden); }
        .promo-option-btn.active { border-color: var(--color-golden); box-shadow: 0 0 10px rgba(255, 193, 7, 0.3); }
        .promo-option-title { font-size: 1rem; font-weight: 700; color: var(--color-golden); margin-bottom: 4px; }
        .promo-option-details { font-size: 0.8rem; color: var(--text-secondary); }

        .promo-code-wrapper-new { display: flex; gap: 10px; align-items: stretch; }
        #promo-code-new { flex-grow: 1; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 8px; padding: 12px; color: var(--text-primary); min-width: 0; }
        #promo-code-new:focus { border-color: var(--color-golden); }
        #apply-promo-btn-new { background-color: var(--color-golden); color: var(--bg-color); border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 700; transition: background-color 0.2s; flex-shrink: 0; }
        #apply-promo-btn-new:disabled { background-color: var(--text-secondary); cursor: not-allowed;}
        .promo-feedback { font-size: 0.85rem; font-weight: 500; margin-top: 10px; padding: 8px 12px; border-radius: 6px; text-align: center; display: none; }
        .promo-feedback.visible { display: block; }
        .promo-feedback.success { background-color: rgba(0, 200, 83, 0.2); color: var(--color-up); }
        .promo-feedback.error { background-color: rgba(213, 0, 0, 0.2); color: var(--color-down); }
        #promo-calculation-display { font-size: 0.9rem; font-weight: 500; margin-top: 12px; text-align: center; color: var(--text-primary); }
        #deposit-next-btn-new { display: block; width: 100%; margin-top: 10px; background: var(--color-green-accent); color: white; border: none; padding: 16px; border-radius: 8px; font-size: 1.1rem; font-weight: 700; cursor: pointer; }
        #deposit-next-btn-new:disabled { background-color: #555; cursor: not-allowed; }
        #payment-method-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .payment-method-item { background: var(--primary-surface); border: 2px solid var(--border-color); border-radius: 12px; padding: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 12px; cursor: pointer; transition: all 0.2s ease-in-out; position: relative; text-decoration: none; color: var(--text-primary); }
        .payment-method-item:hover { border-color: var(--text-primary); }
        .payment-method-item.selected { border-color: var(--color-green-accent); }
        .payment-method-item.maintenance, .payment-method-item.coming-soon { opacity: 0.5; cursor: not-allowed; }
        .payment-method-item.maintenance:hover, .payment-method-item.coming-soon:hover { border-color: var(--border-color); }
        .pm-status-badge { position: absolute; top: 8px; right: 8px; font-size: 0.7rem; font-weight: 700; padding: 3px 8px; border-radius: 10px; color: white; text-transform: capitalize; }
        .pm-status-maintenance { background-color: var(--color-pending); }
        .pm-status-coming-soon { background-color: var(--color-accent); }
        .payment-method-item img { width: 50px; height: 50px; border-radius: 8px; object-fit: contain; }
        .payment-method-item span { font-weight: 500; }
        .deposit-timer-card { background: var(--secondary-surface); padding: 15px; border-radius: 12px; margin-bottom: 20px; text-align: center; }
        .timer-label { font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 5px; }
        #deposit-timer-display { font-size: 2rem; font-weight: 700; color: var(--color-golden); letter-spacing: 2px; }
        .payment-instructions-card { background-color: rgba(41, 98, 255, 0.1); border: 1px solid var(--color-accent); color: var(--text-primary); padding: 15px; border-radius: 12px; margin-bottom: 20px; font-size: 0.9rem; line-height: 1.5; }
        .payment-details-card { background-color: var(--primary-surface); padding: 10px 20px; border-radius: 12px; margin-bottom: 20px; display: flex; flex-direction: column; gap: 0; }
        .payment-details-row { display: flex; justify-content: space-between; align-items: center; font-size: 0.95rem; padding: 14px 0; border-bottom: 1px solid var(--border-color); }
        .payment-details-card .payment-details-row:last-child { border-bottom: none; }
        .payment-details-row .label { color: var(--text-secondary); }
        .payment-details-row .value { font-weight: 700; color: var(--text-primary); }
        .payment-details-row .value.highlight { color: var(--color-green-accent); font-size: 1.1rem; }
        .payment-address-row-new { background-color: var(--secondary-surface); padding: 15px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; margin-top: 15px; }
        .address-labels-new { color: var(--text-secondary); font-size: 0.9rem; flex-shrink: 0; display: flex; flex-direction: column; line-height: 1.4; }
        .address-labels-new span:first-child { font-weight: 700; color: var(--text-primary); }
        .address-value-wrapper-new { display: flex; gap: 10px; align-items: center; flex-grow: 1; justify-content: flex-end; margin-left: 15px; }
        .address-text-new { word-break: break-all; text-align: right; font-weight: 500; font-size: 0.95rem; color: var(--text-primary); }
        .copy-button-new { background: var(--color-green-accent); border-radius: 6px; color: white; padding: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; border: none; transition: opacity 0.2s; }
        .copy-button-new:hover { opacity: 0.8; }
        .copy-button-new svg { width: 18px; height: 18px; }
        .deposit-qr-code { display: block; width: 180px; height: 180px; margin: 20px auto; border-radius: 12px; background-color: white; padding: 5px; }
        .proof-upload-label { background: var(--secondary-surface); border: 2px dashed var(--border-color); padding: 30px; text-align: center; border-radius: 12px; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 10px; transition: all 0.2s ease; }
        .proof-upload-label:hover { border-color: var(--color-green-accent); background-color: var(--bg-color); }
        .proof-upload-label svg { width: 32px; height: 32px; color: var(--text-secondary); transition: color 0.2s; }
        .proof-upload-label:hover svg { color: var(--color-green-accent); }
        .proof-upload-label span { color: var(--text-primary); font-weight: 500; }
        .proof-upload-label .file-name { font-size: 0.8rem; color: var(--color-green-accent); }
        #payment-submit-btn-new { display: block; width: 100%; margin-top: 10px; background: var(--color-green-accent); color: white; border: none; padding: 16px; border-radius: 8px; font-size: 1.1rem; font-weight: 700; cursor: pointer; transition: background-color 0.2s; }
        #payment-submit-btn-new:disabled { background: var(--text-secondary); cursor: not-allowed; }
        input[type="file"] { display: none; }
        .file-name { color: var(--text-secondary); font-size: 0.85rem; margin-top: 5px; }
        #kyc-submit-button:disabled { background-color: #555; cursor: not-allowed; }
        .kyc-info-box { background-color: var(--secondary-surface); padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .kyc-info-box p { margin: 0; text-align: left; line-height: 1.5; }
        
        .premium-card { background-color: var(--primary-surface); padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid var(--border-color); box-shadow: 0 4px 12px rgba(0,0,0,0.25); }
        .premium-card h3 { margin-top: 0; font-size: 1.2rem; }
        .withdraw-info-cards { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
        .withdraw-info-card { background-color: var(--primary-surface); padding: 15px; border-radius: 8px; text-align: center; border: 1px solid var(--border-color); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .withdraw-info-card .label { font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 5px; }
        .withdraw-info-card .value { font-size: 1.1rem; font-weight: 700; }
        .custom-select { background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 8px; padding: 12px; font-size: 1rem; color: var(--text-primary); cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .custom-select::after { content: ''; font-size: 0.7rem; color: var(--text-secondary); }
        .method-option-list { display: flex; flex-direction: column; gap: 5px; }
        .method-option { display: flex; align-items: center; justify-content: space-between; padding: 15px; background: var(--secondary-surface); border-radius: 8px; cursor: pointer; }
        .method-option .method-info { display: flex; align-items: center; gap: 12px; }
        .method-option .method-info span { font-weight: 500; }
        .method-logo { width: 24px; height: 24px; border-radius: 4px; object-fit: contain; }
        .method-option input[type="radio"] { display: none; }
        .method-option .radio-circle { width: 20px; height: 20px; border-radius: 50%; border: 2px solid var(--border-color); display: flex; justify-content: center; align-items: center; transition: border-color 0.2s; }
        .method-option:hover .radio-circle { border-color: var(--text-primary); }
        .method-option input[type="radio"]:checked ~ .radio-circle { border-color: var(--color-accent); }
        .method-option input[type="radio"]:checked ~ .radio-circle::after { content: ''; width: 10px; height: 10px; background: var(--color-accent); border-radius: 50%; }
        #transaction-list-container { padding: 0; display: flex; flex-direction: column; gap: 10px; }
        .transaction-item { background: linear-gradient(145deg, var(--primary-surface), #1a1d21); padding: 15px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; border-left: 3px solid transparent; box-shadow: 0 4px 8px rgba(0,0,0,0.2);}
        .transaction-item[data-type="deposit"] { border-left-color: var(--color-up); }
        .transaction-item[data-type="withdraw"] { border-left-color: var(--color-down); }
        .transaction-item[data-type="bonus"] { border-left-color: var(--color-golden); }
        .ti-left { display: flex; flex-direction: column; gap: 6px; }
        .ti-order-id { font-weight: 500; font-size: 1rem; }
        .ti-date { font-size: 0.8rem; color: var(--text-secondary); }
        .ti-status { font-weight: 700; font-size: 0.85rem; text-transform: capitalize; }
        .ti-status-succeeded { color: var(--color-up); } .ti-status-pending { color: var(--color-pending); } .ti-status-failed { color: var(--color-down); } .ti-status-canceled { color: var(--text-secondary); }
        .ti-right { text-align: right; }
        .ti-amount { font-size: 1.1rem; font-weight: 700; margin-bottom: 6px; }
        .ti-amount-positive { color: var(--color-up); } .ti-amount-negative { color: var(--color-down); }
        .ti-details { color: var(--text-secondary); font-size: 0.8rem; } .ti-type { text-transform: capitalize; }
        .cancel-withdraw-btn { background-color: var(--color-down); color: white; border: none; border-radius: 4px; padding: 4px 8px; font-size: 0.75rem; font-weight: 700; cursor: pointer; margin-top: 5px; }
        .analysis-filters { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }
        .filter-btn { background: var(--secondary-surface); color: var(--text-secondary); border: 1px solid var(--border-color); padding: 8px 15px; border-radius: 20px; font-size: 0.85rem; cursor: pointer; transition: all 0.2s; }
        .filter-btn.active { background: var(--color-accent); color: white; border-color: var(--color-accent); }
        .analysis-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 0 10px; }
        .stat-card { background: var(--primary-surface); padding: 15px; border-radius: 12px; text-align: center; border: 1px solid var(--border-color); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .stat-card-title { font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 8px; text-transform: uppercase; }
        .stat-card-value { font-size: 1.5rem; font-weight: 700; }
        .stat-card-value.profit { color: var(--color-up); } .stat-card-value.loss { color: var(--color-down); }
        #withdraw-fee-info { display: none; }
        
        .legend-item { display: flex; align-items: center; gap: 12px; font-size: 0.95rem; font-weight: 500; }
        .legend-item-color { width: 12px; height: 12px; border-radius: 50%; }
    
        #leaderboard-loader { display: flex; flex-grow: 1; align-items: center; justify-content: center; }
        #leaderboard-loader img { width: 80px; animation: pulse 1.5s infinite ease-in-out; }
        #leaderboard-content { display: none; }
        #leaderboard-calculating-state { display: none; flex-direction: column; align-items: center; justify-content: center; flex-grow: 1; gap: 15px; text-align: center; padding: 20px;}
        #leaderboard-calculating-state svg { width: 48px; height: 48px; color: var(--color-accent); }
        #leaderboard-calculating-state h3 { margin: 0; font-size: 1.2rem; }
        #leaderboard-calculating-state p { color: var(--text-secondary); margin: 0; }
        #leaderboard-my-rank { background: var(--primary-surface); padding: 15px 20px; margin: 0 15px 20px 15px; border-radius: 12px; display: grid; grid-template-columns: 40px 1fr auto; align-items: center; gap: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.25); }
        .lb-pfp { width: 40px; height: 40px; border-radius: 50%; background-color: var(--secondary-surface); display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .lb-pfp img, .lb-pfp svg { width: 100%; height: 100%; object-fit: cover; }
        #leaderboard-my-rank .lb-info { flex-grow: 1; }
        #leaderboard-my-rank .lb-name { font-size: 1.1rem; font-weight: 700; color: var(--text-primary); text-align: left; }
        #leaderboard-my-rank .lb-position { font-size: 0.85rem; color: var(--text-secondary); }
        #leaderboard-my-rank .lb-profit, .lb-profit { font-weight: 700; font-size: 1.1rem; text-align: right; }
        #leaderboard-list { padding: 0 5px; }
        .leaderboard-item { display: grid; grid-template-columns: 30px 1fr auto; align-items: center; gap: 15px; padding: 14px 15px; cursor: pointer; transition: background-color 0.2s ease; border-bottom: 1px solid var(--border-color); }
        .leaderboard-item:hover { background-color: var(--secondary-surface); }
        .lb-rank { font-size: 1rem; font-weight: 700; color: var(--text-secondary); text-align: left;}
        .lb-name { font-weight: 500; font-size: 1rem; color: var(--text-primary); }
        .lb-rank-1, .lb-name-1 { color: var(--color-rank-1) !important; font-weight: 700; }
        .lb-rank-2, .lb-name-2 { color: var(--color-rank-2) !important; font-weight: 700;}
        .lb-rank-3, .lb-name-3 { color: var(--color-rank-3) !important; font-weight: 700;}
        .lb-profit.win { color: var(--color-up); }
        .lb-profit.loss { color: var(--color-down); }
        #leaderboard-help-modal h3 { text-align: center; margin: 0; font-size: 1.5rem; }
        #leaderboard-help-modal .modal-content { gap: 25px; }
        .lb-help-icon { width: 50px; height: 50px; margin: 0 auto -15px auto; background-color: var(--color-golden); border-radius: 8px; padding: 10px; color: var(--bg-color); }
        .lb-help-rules { list-style: none; padding-left: 0; margin: 0; }
        .lb-help-rules li { padding-left: 25px; position: relative; color: var(--text-secondary); font-size: 0.95rem; line-height: 1.5; }
        .lb-help-rules li:not(:last-child) { margin-bottom: 12px; }
        .lb-help-rules li::before { content: ''; position: absolute; left: 5px; color: var(--color-accent); font-weight: bold; font-size: 1.2rem; line-height: 1; }
        #lb-help-my-rating { border-top: 1px solid var(--border-color); padding-top: 20px; }
        #leaderboard-help-my-rank-display { padding: 0 !important; }
        .modal-button-row { display: flex; gap: 10px; margin-top: 10px; }
        .modal-button { flex: 1; padding: 12px; border-radius: 8px; border: none; font-weight: 700; font-size: 1rem; cursor: pointer; text-decoration: none; text-align: center; }
        .modal-button.primary { background-color: var(--color-accent); color: white; }
        .modal-button.secondary { background-color: var(--secondary-surface); color: var(--text-primary); }
        
        #leaderboard-user-profile-modal .modal-content { max-width: 360px; padding: 0; background: var(--secondary-surface); }
        .lb-user-profile-header { display: flex; align-items: center; justify-content: space-between; gap: 15px; padding: 20px; background: var(--primary-surface); border-radius: 12px 12px 0 0;}
        .lb-user-profile-header-left { display: flex; align-items: center; gap: 15px; }
        #lb-user-profile-pic { width: 60px; height: 60px; border-radius: 50%; background-color: var(--bg-color); flex-shrink: 0; }
        #lb-user-profile-pic img { width: 100%; height: 100%; object-fit: cover; }
        #lb-user-profile-name { font-size: 1.3rem; font-weight: 700; color: var(--text-primary); }
        #lb-user-profile-profit { font-size: 1.1rem; font-weight: 700; }
        #lb-user-profile-profit.win { color: var(--color-up); }
        #lb-user-profile-profit.loss { color: var(--color-down); }
        .lb-user-profile-body { padding: 20px; display: flex; flex-direction: column; gap: 20px; }
        .lb-user-stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .lb-user-stat { background: var(--primary-surface); padding: 12px; border-radius: 8px; text-align: center; }
        .lb-user-stat-label { font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 6px; text-transform: uppercase; }
        .lb-user-stat-value { font-size: 1.2rem; font-weight: 700; }
        .lb-user-stat-value.win { color: var(--color-up); }
        .lb-user-stat-value.loss { color: var(--color-down); }
        .lb-user-bio { background: var(--primary-surface); padding: 15px; border-radius: 8px; }
        .lb-user-bio h4 { margin: 0 0 10px; font-size: 1rem; font-weight: 500; color: var(--text-primary); }
        #lb-user-profile-close-btn { background-color: var(--color-accent); color: white; border: none; padding: 12px; border-radius: 8px; font-size: 1rem; font-weight: 700; cursor: pointer; margin: 0 20px 20px 20px; }

        #view-support .page-content {
            padding: 0;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
        }
        .support-background {
            position: absolute;
            top: 0; left: 0;
            width: 100%;
            height: 100%;
            background-image: url('https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/AddText_09-05-10.12.27.webp?alt=media&token=1d020904-baef-437f-8c6e-6032fc32d5d5');
            background-size: cover;
            background-position: center;
        }
        .support-button-container {
            position: relative;
            z-index: 2;
            padding: 20px 15px 35px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        #market-selector-modal {
            background: var(--bg-color);
            align-items: flex-start;
            justify-content: flex-start;
            z-index: 1010;
        }
        #market-selector-modal .modal-content {
            background-color: var(--bg-color);
            padding: 0;
            max-width: 100%;
            width: 100%;
            height: 100%;
            border-radius: 0;
            max-height: 100%;
            display: flex;
            flex-direction: column;
        }
        .market-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 15px;
            background-color: var(--primary-surface);
            flex-shrink: 0;
        }
        .market-modal-header h2 {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 500;
        }
        #market-modal-close-btn {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 2rem;
            line-height: 1;
            padding: 0 5px;
            cursor: pointer;
        }
        .market-modal-body {
            padding: 15px;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            overflow: hidden;
        }
        .market-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
            flex-shrink: 0;
        }
        .market-filter-btn {
            background: var(--secondary-surface);
            color: var(--text-secondary);
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            flex-grow: 1;
        }
        #favorite-filter-btn {
            flex-grow: 0;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 6px;
            border: 1px solid var(--border-color);
            background: var(--primary-surface);
        }
        #favorite-filter-btn.active, .market-filter-btn.active {
            background: var(--color-accent);
            color: white;
            border-color: var(--color-accent);
        }
        #favorite-filter-btn .star-icon { color: var(--color-golden); font-size: 1rem; }

        .search-input-wrapper {
            position: relative;
            flex-grow: 1;
        }
        #market-search-input {
            padding-right: 30px;
        }
        #search-clear-btn {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 5px;
            font-size: 1.2rem;
            display: none; 
        }
        
        .market-list-header {
            display: grid;
            grid-template-columns: 35px 45px 1fr 80px;
            gap: 8px;
            padding: 0 10px 10px;
            font-size: 0.7rem;
            color: var(--text-secondary);
            font-weight: 500;
            text-transform: uppercase;
        }
        .market-list-header .header-label:nth-child(3) { text-align: left; }
        .market-list-header .header-label:nth-child(4) { text-align: right; }

        #market-list-container {
            flex-grow: 1;
            overflow-y: auto;
        }

        .market-option-item {
            display: grid;
            grid-template-columns: 35px 45px 1fr 80px;
            align-items: center;
            gap: 8px;
            padding: 12px 10px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .market-option-item:not(:last-child) { border-bottom: 1px solid var(--border-color); }
        .market-option-item.active { background-color: var(--secondary-surface); }
        
        .market-icon-wrapper-list {
            display: flex;
            align-items: center;
            position: relative;
            width: 36px;
            height: 24px;
        }
        .market-icon-list {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--bg-color);
            position: absolute;
            background-color: var(--secondary-surface);
        }
        .market-icon-list.logo2 {
            margin-left: 12px;
        }

        .star-icon { color: var(--text-secondary); font-size: 1.4rem; cursor: pointer; text-align: center; transform: scale(1); transition: transform 0.1s; }
        .star-icon.favorited { color: var(--color-golden); }
        .market-info-wrapper { display: flex; flex-direction: column; gap: 4px; overflow: hidden; }
        .market-name-wrapper { display: flex; align-items: center; gap: 6px; }
        .market-info-name { font-weight: 500; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .market-otc-badge { font-size: 0.75rem; font-weight: 500; padding: 2px 5px; border-radius: 4px; background-color: var(--secondary-surface); color: var(--text-secondary); text-transform: uppercase; flex-shrink: 0;}
        .market-profit-info { color: var(--text-secondary); font-size: 0.8rem; font-weight: 400; }
        .market-profit-info .profit-label { color: var(--color-up); }
        .market-profit-info strong { color: var(--color-golden); font-weight: 500; }
        .market-change { font-weight: 500; display: flex; align-items: center; justify-content: flex-end; gap: 5px; font-size: 0.95rem; }
        .market-change.up { color: var(--color-up); }
        .market-change.down { color: var(--color-down); }
        .market-change .change-icon { width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .market-change.up .change-icon { background-color: rgba(0, 200, 83, 0.15); }
        .market-change.down .change-icon { background-color: rgba(213, 0, 0, 0.15); }
        .change-icon svg { width: 14px; height: 14px; }
        .market-change.up svg { color: var(--color-up); }
        .market-change.down svg { color: var(--color-down); }
        .market-option-item.maintenance { opacity: 0.5; cursor: not-allowed; }
        
        #desktop-blocker { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg-color); color: var(--text-primary); justify-content: center; align-items: center; text-align: center; padding: 20px; z-index: 10000; }
        .blocker-content { max-width: 400px; }
        .blocker-content svg { width: 60px; height: 60px; color: var(--color-accent); margin-bottom: 20px; }
        .blocker-content h2 { font-size: 1.5rem; margin-bottom: 10px; }
        .blocker-content p { color: var(--text-secondary); line-height: 1.6; }

        @media (min-width: 701px) {
            body > *:not(#desktop-blocker) { display: none !important; }
            #desktop-blocker { display: flex; }
        }

        #account-locked-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); z-index: 5000; display: none; flex-direction: column; justify-content: center; align-items: center; padding: 20px; text-align: center; color: var(--text-primary); }
        #account-locked-overlay h2 { color: var(--color-down); font-size: 1.5rem; margin-bottom: 15px; }
        #account-locked-overlay p { max-width: 320px; color: var(--text-secondary); line-height: 1.6; }
        #deletion-timer { font-size: 2.5rem; font-weight: 700; color: var(--color-golden); margin: 20px 0; letter-spacing: 2px; background: var(--secondary-surface); padding: 10px 20px; border-radius: 8px;}
        #cancel-deletion-btn { margin-top: 25px; padding: 15px 30px; }

        #view-terms .page-content h3 { text-align: center; }
        #view-terms .page-content h4 { color: var(--text-primary); margin-top: 20px; margin-bottom: 10px; }
        #view-terms .page-content p, #view-terms .page-content li { text-align: left; font-size: 0.9rem; line-height: 1.6; color: var(--text-secondary); }
        #view-terms .page-content ul { padding-left: 20px; }
        
        #mentor-warning-modal .modal-content { text-align: center; gap: 20px; }
        #mentor-warning-modal h3 { margin: 0; color: var(--color-pending); }
        #mentor-warning-modal p { line-height: 1.6; }
        
        #multiple-trades-warning-modal .modal-content {
            text-align: center;
            gap: 20px;
            border-left: 4px solid var(--color-down);
        }
        #multiple-trades-warning-modal h3 {
            margin: 0;
            color: var(--color-down);
        }

        .tasks-container { display: flex; flex-direction: column; gap: 15px; }
        .task-card { background: var(--primary-surface); padding: 20px; border-radius: 12px; border-left: 4px solid var(--color-accent); border: 1px solid var(--border-color); box-shadow: 0 4px 12px rgba(0,0,0,0.25); }
        .task-card.completed { border-left-color: var(--color-up); }
        .task-header { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; }
        .task-header svg { width: 24px; height: 24px; color: var(--color-golden); flex-shrink: 0; }
        .task-title { font-size: 1.1rem; font-weight: 700; margin: 0; }
        .task-description { font-size: 0.9rem; color: var(--text-secondary); line-height: 1.5; margin: 0 0 15px 0; text-align: left;}
        .task-progress-container { margin: 15px 0; }
        .task-progress-text { font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 8px; display: flex; justify-content: space-between; }
        .task-progress-bar { background-color: var(--secondary-surface); border-radius: 5px; height: 10px; overflow: hidden; }
        .task-progress-bar-inner { background-color: var(--color-accent); height: 100%; width: 0%; border-radius: 5px; transition: width 0.5s ease; }
        .task-card.completed .task-progress-bar-inner { background-color: var(--color-up); }
        .task-footer { margin-top: 15px; display: flex; justify-content: flex-end; align-items: center; gap: 10px; }
        .task-reward-tag { font-size: 0.9rem; font-weight: 700; color: var(--color-up); }
        .claim-btn { background: var(--color-golden); color: var(--bg-color); border: none; padding: 10px 25px; border-radius: 8px; font-weight: 700; cursor: pointer; }
        .claim-btn:disabled { background: var(--text-secondary); cursor: not-allowed; }
        .mentor-id-input-group { display: flex; gap: 10px; margin-top: 15px; }
        #new-mentor-id-input { flex-grow: 1; }
        .placeholder-card { background-color: var(--primary-surface); padding: 40px 20px; border-radius: 12px; text-align: center; display: flex; flex-direction: column; align-items: center; gap: 15px; border: 1px dashed var(--border-color); }
        .placeholder-card svg { width: 48px; height: 48px; color: var(--color-accent); }

        #view-miner .page-content {
            background-color: #1a1a2e;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 0;
        }
        /* MODIFICATION: Miner header color match */
        #view-miner .page-header, #view-miner-history .page-header {
             background-color: #1a1a2e;
        }
        #miner-dynamic-hash {
            color: var(--text-secondary);
            font-size: 0.75rem;
            font-family: monospace;
            text-align: center;
            padding: 10px;
            background-color: #1a1a2e;
            overflow: hidden;
            white-space: nowrap;
        }
        #miner-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
            padding: 20px;
            flex-grow: 1;
        }
        .miner-display {
            text-align: center;
            width: 100%;
        }
        .miner-display-btc {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--color-green-accent);
            letter-spacing: 1px;
        }
        .miner-display-btc span {
            color: var(--text-primary);
        }
        .miner-display-usdt {
            font-size: 1rem;
            color: var(--text-secondary);
            margin-top: 5px;
        }
        #withdraw-miner-btn {
            width: 80%;
            max-width: 300px;
            padding: 14px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--secondary-surface);
            color: var(--text-primary);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #withdraw-miner-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        #mine-btn-container {
            position: relative;
            width: 160px;
            height: 160px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .miner-progress-ring {
            position: absolute;
            top: 0;
            left: 0;
            transform: rotate(-90deg);
            pointer-events: none;
        }
        .miner-progress-ring__circle {
            transition: stroke-dashoffset 0.5s linear;
            transform-origin: 50% 50%;
            stroke-dasharray: 478 478; /* 2 * pi * 76 */
            stroke-dashoffset: 478;
        }
        @keyframes pulse-glow {
          0% { box-shadow: 0 0 15px rgba(0, 200, 83, 0.5); }
          50% { box-shadow: 0 0 25px rgba(0, 200, 83, 0.8); }
          100% { box-shadow: 0 0 15px rgba(0, 200, 83, 0.5); }
        }
        #mine-btn {
            background-color: transparent;
            width: 130px;
            height: 130px;
            border-radius: 50%;
            border: 3px solid var(--color-green-accent);
            padding: 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
            animation: pulse-glow 2.5s infinite ease-in-out;
            position: relative;
            z-index: 2;
            overflow: hidden;
        }
        #mine-btn img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
            display: block;
        }
        #mine-btn:disabled {
            cursor: not-allowed;
            animation: none;
            border-color: var(--secondary-surface);
            box-shadow: none;
        }
        #mine-btn:disabled img {
            filter: grayscale(80%);
        }
        #mine-btn-timer {
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
            background-color: rgba(0,0,0,0.6);
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        #click-to-mine-hint {
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        #click-to-mine-hint svg {
            width: 20px;
            height: 20px;
        }
        #hash-power-container {
            display: flex;
            align-items: center;
            gap: 10px;
            background-color: var(--primary-surface);
            padding: 10px 15px;
            border-radius: 8px;
            width: 80%;
            max-width: 300px;
            justify-content: center;
        }
        #miner-fan-icon {
            width: 40px;
            height: 40px;
            transition: transform 1s linear;
        }
        #miner-fan-icon.spinning {
            animation-name: spin;
            animation-timing-function: linear;
            animation-iteration-count: infinite;
        }
        .hash-power-display {
            text-align: center;
            flex-grow: 1;
        }
        .hash-power-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            display: block;
        }
        #hash-power-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        #miner-upgrade-section {
            text-align: center;
            margin-top: -10px;
            width: 100%;
        }
        #miner-upgrade-link {
            color: var(--color-golden);
            font-weight: 500;
            font-size: 0.9rem;
            text-decoration: underline;
            cursor: pointer;
        }
        #miner-upgrade-modal .modal-content { background: #1a1a2e; padding: 0; }
        .miner-modal-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; }
        .miner-modal-header h3 { margin: 0; font-size: 1.2rem; }
        #miner-modal-close-btn { background: none; border: none; color: var(--text-secondary); font-size: 1.5rem; cursor: pointer; }
        .miner-modal-body { padding: 20px; }
        .miner-modal-tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }
        .miner-modal-tab { flex-grow: 1; padding: 10px; background: var(--secondary-surface); border: 1px solid var(--border-color); color: var(--text-secondary); font-weight: 700; font-size: 0.9rem; cursor: pointer; border-radius: 8px; text-align: center; }
        .miner-modal-tab.active { background: var(--color-accent); color: white; border-color: var(--color-accent); }
        .miner-modal-tab-content { display: none; }
        .miner-modal-tab-content.active { display: block; }
        .subscription-card { background-color: var(--primary-surface); border-radius: 12px; padding: 15px; margin-bottom: 15px; display: grid; grid-template-columns: 70px 1fr auto; align-items: center; gap: 15px; border: 1px solid var(--border-color); }
        .sub-card-logo { width: 70px; height: 70px; border-radius: 8px; object-fit: cover; }
        .sub-card-info h4 { margin: 0 0 8px; font-size: 1.2rem; color: var(--text-primary); }
        .sub-card-info p { margin: 0; font-size: 0.85rem; color: var(--text-secondary); line-height: 1.5; }
        .sub-card-buy-btn { background: var(--color-accent); color: white; border: none; padding: 12px 22px; border-radius: 8px; font-weight: 700; font-size: 1rem; cursor: pointer; }
        .sub-card-buy-btn:disabled { background-color: #555; cursor: not-allowed; }
        .active-hash-item { background-color: var(--primary-surface); border-radius: 12px; padding: 15px; margin-bottom: 10px; display: grid; grid-template-columns: 50px 1fr; align-items: center; gap: 15px; }
        .active-hash-logo { width: 50px; height: 50px; border-radius: 8px; object-fit: cover; }
        .active-hash-details { display: flex; justify-content: space-between; align-items: center; }
        .active-hash-info { font-weight: 500; }
        .active-hash-timer { font-size: 0.9rem; color: var(--text-secondary); text-align: right; }
        .miner-history-item { background-color: var(--primary-surface); padding: 15px; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .mhi-date { font-weight: 500; }
        .mhi-rewards { text-align: right; }
        .mhi-btc { font-size: 1.1rem; font-weight: 700; color: var(--color-green-accent); }
        .mhi-usdt { font-size: 0.85rem; color: var(--text-secondary); }

        #payments-modal-overlay {
            align-items: flex-end;
            justify-content: center;
            z-index: 1005;
            background-color: rgba(0, 0, 0, 0.5);
            -webkit-backdrop-filter: blur(4px);
            backdrop-filter: blur(4px); 
        }
        .payments-modal-content {
            position: absolute;
            bottom: 0;
            width: 100%;
            /* MODIFICATION: Dynamic width */
            max-width: 700px;
            background-color: #1C1F26; 
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            padding: 10px 15px 35px 15px; 
            box-shadow: 0 -5px 25px rgba(0,0,0,0.4);
            transform: translateY(100%);
            transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            touch-action: none;
        }
        #payments-modal-overlay.visible .payments-modal-content {
            transform: translateY(0);
        }
        .payments-modal-handle {
            width: 40px;
            height: 5px;
            background-color: #4b525e;
            border-radius: 2.5px;
            margin: 0 auto 20px auto; 
        }
        .payments-modal-title {
            text-align: center; 
            font-size: 1.1rem; 
            font-weight: 500;
            margin: 0 0 25px 0;
            color: var(--text-primary);
        }
        .payments-modal-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .payments-btn {
            display: grid;
            grid-template-columns: 40px 1fr 40px; 
            align-items: center;
            padding: 16px 10px; 
            border-radius: 12px;
            background-color: #31353D; 
            color: var(--text-primary);
            border: none;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .payments-btn:hover {
            background-color: #4b525e;
        }
        .payments-btn span {
            grid-column: 2 / 3; 
            text-align: center;
            font-weight: 500;
        }

        .payments-btn svg {
            grid-column: 1 / 2;
            width: 28px;
            height: 28px;
            justify-self: center;
            opacity: 0.8;
        }
        .btn-deposit-highlight {
            background: linear-gradient(100deg, #10E9A9, var(--color-up));
            color: var(--bg-color);
        }
        .btn-deposit-highlight svg {
            color: var(--bg-color);
            opacity: 1;
        }

        .trade-options-content {
            background-color: var(--primary-surface);
            width: 100%;
            /* MODIFICATION: Dynamic width */
            max-width: 700px;
            border-top-left-radius: 16px;
            border-top-right-radius: 16px;
            padding: 10px 0 30px;
            display: flex;
            flex-direction: column;
            overflow: hidden; 
        }
        .trade-options-tabs-container {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            text-align: center;
            padding: 0 15px;
            position: relative;
            margin-bottom: 20px;
        }
        .trade-options-tab-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            position: relative;
            cursor: pointer;
        }
        .trade-options-tab {
            background: none; border: none;
            color: var(--text-secondary);
            font-size: 1rem;
            font-weight: 500;
            padding: 10px;
            cursor: pointer;
            width: 100%;
            transition: color 0.3s, transform 0.3s ease;
        }
        .trade-options-tab-sublabel {
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-weight: 400;
            transition: opacity 0.3s, transform 0.3s ease;
        }
        .trade-options-tab-underline {
            position: absolute;
            bottom: -5px;
            left: 0; right: 0;
            height: 4px;
            background-color: var(--color-up);
            border-radius: 2px;
            transform: scaleX(0);
            transition: transform 0.3s ease;
            width: 60%;
            margin: 0 auto;
        }
        .trade-options-tab-wrapper.active .trade-options-tab {
            color: var(--color-up);
            transform: translateY(8px) scale(1.1);
        }
        .trade-options-tab-wrapper.active .trade-options-tab-sublabel {
            opacity: 0;
            transform: translateY(5px);
        }
        .trade-options-tab-wrapper.active .trade-options-tab-underline {
            transform: scaleX(1);
        }

        .trade-options-panels {
            position: relative;
            display: flex;
            width: 300%; /* 3 panels */
            transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .trade-options-panel {
            width: calc(100% / 3);
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 0 15px;
            min-height: 280px;
        }
        
        /* Duration Panel */
        .duration-sub-tabs {
            display: flex;
            background-color: var(--secondary-surface);
            border-radius: 8px;
            padding: 4px;
            width: fit-content;
            margin: 0 auto;
        }
        .duration-sub-tab {
            background: none;
            border: none;
            color: var(--text-secondary);
            padding: 8px 25px;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .duration-sub-tab.active {
            background-color: var(--color-up);
            color: var(--primary-surface);
            font-weight: 700;
        }
        
        .trade-close-info {
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin: 0;
        }
        .duration-content-wrapper { position: relative; flex-grow: 1; display: flex; align-items: center; }
        .duration-panel { display: none; width: 100%; }
        .duration-panel.active { display: flex; flex-direction: column; }
        
        .timer-options-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        .timer-options-grid button {
            background-color: var(--secondary-surface);
            color: var(--text-primary);
            border: none;
            border-radius: 8px;
            padding: 12px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
        }

        /* NEW DYNAMIC TIME PICKER */
        .time-picker-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 150px; 
            overflow: hidden;
            position: relative;
            width: 100%;
        }
        .time-picker-container::before, .time-picker-container::after {
            content: '';
            position: absolute;
            left: 0; right: 0;
            height: 50px; 
            background: linear-gradient(to bottom, var(--primary-surface), transparent);
            pointer-events: none;
            z-index: 2;
        }
        .time-picker-container::after {
            top: auto;
            bottom: 0;
            background: linear-gradient(to top, var(--primary-surface), transparent);
        }
        .time-picker-highlight {
            position: absolute;
            top: 50px; 
            left: 15px; right: 15px;
            height: 50px; 
            border-top: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
            z-index: 1;
        }
        
        .time-picker-column {
            width: 80px;
            height: 100%;
            overflow-y: scroll;
            scrollbar-width: none;
            -ms-overflow-style: none;
            scroll-snap-type: y mandatory;
        }
        .time-picker-column::-webkit-scrollbar { display: none; }

        .time-picker-column div {
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: 500;
            color: var(--text-secondary);
            scroll-snap-align: center;
            transition: color 0.2s, font-weight 0.2s, transform 0.2s;
        }
        
        .time-picker-column.locked {
            opacity: 0.7;
            pointer-events: none;
            overflow-y: hidden;
        }
        .time-picker-column.locked div {
             color: var(--text-primary);
        }

        /* Amount Panel */
        .amount-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--text-primary);
            font-size: 0.9rem;
        }
        #trade-options-deposit-link {
            color: var(--color-up);
            font-weight: 700;
            text-decoration: none;
        }
        .amount-panel-display {
            font-size: 2.5rem;
            font-weight: 700;
            text-align: center;
            margin: 15px 0;
            color: var(--text-primary);
            min-height: 48px;
        }
        .numeric-keypad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        .numeric-keypad button {
            background-color: var(--secondary-surface);
            border: none;
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1.5rem;
            font-weight: 500;
            height: 50px;
            cursor: pointer;
            transition: background-color 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .numeric-keypad button:active {
            background-color: #3f4651;
            transform: translateY(1px);
        }
        /* Strike Prices Panel */
        .strike-panel-header {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            text-align: center;
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }
        .strike-panel-body {
            display: grid;
            grid-template-columns: 1fr 1.5fr 1fr;
            gap: 10px;
            align-items: center;
        }
        .strike-profit-box, .strike-price-box {
            background-color: var(--secondary-surface);
            border-radius: 8px;
            padding: 12px;
            font-weight: 700;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        .strike-profit-box.down { color: var(--color-down); }
        .strike-profit-box.up { color: var(--color-up); }
        .strike-price-box {
            font-size: 1.1rem;
            color: var(--text-primary);
        }

    </style>
</head>
<body>
    
    <div id="desktop-blocker">
        <div class="blocker-content">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20 18c1.1 0 1.99-.9 1.99-2L22 6c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2H0v2h24v-2h-4zM4 6h16v10H4V6z"/></svg>
            <h2>PC Version Not Available</h2>
            <p>This trading platform is optimized for mobile devices. Please open it on your phone for the best experience.</p>
        </div>
    </div>
    
    <div id="app-loader">
        <img src="https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/Ictex%2F1758033622292.webp?alt=media&token=36f86666-dcfc-4614-a07f-9e3f8bf9a108" alt="Loading...">
    </div>
    
    <div id="account-locked-overlay">
        <h2 id="locked-title">Account Pending Deletion</h2>
        <p id="locked-message">Your account is scheduled for deletion. You can cancel this request within the time remaining.</p>
        <div id="deletion-timer">24:00:00</div>
        <button id="cancel-deletion-btn" class="modal-button primary">Cancel Deletion Request</button>
    </div>

    <!-- AUTHENTICATION CONTAINER -->
    <div id="auth-container">
        <!-- LOGIN FORM -->
        <div id="login-form-wrapper" class="auth-form-wrapper active">
            <form id="login-form" class="auth-form">
                <img src="https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/Ictex%2F1758033622292.webp?alt=media&token=36f86666-dcfc-4614-a07f-9e3f8bf9a108" alt="ICTEX Trade Logo" class="auth-logo">
                <h2>Welcome Back</h2>
                <div class="input-group"> <input type="email" id="login-email" class="auth-input" placeholder="Email" required> </div>
                <div class="input-group"> <input type="password" id="login-password" class="auth-input" placeholder="Password" required> </div>
                <div class="auth-extra-links">
                    <a id="show-reset-password">Forgot Password?</a>
                </div>
                <button type="submit" class="auth-button">Login</button>
                <p class="form-toggle"> Don't have an account? <a id="show-register">Sign Up</a> </p>
                <p class="form-toggle" style="margin-top: 10px;"><a href="https://t.me/Ictexsupport_bot" target="_blank">Help & Support</a></p>
            </form>
            <div id="login-loader" class="auth-loader"></div>
        </div>

        <!-- REGISTER FORM -->
        <div id="register-form-wrapper" class="auth-form-wrapper">
            <form id="register-form" class="auth-form">
                <img src="https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/Ictex%2F1758033622292.webp?alt=media&token=36f86666-dcfc-4614-a07f-9e3f8bf9a108" alt="ICTEX Trade Logo" class="auth-logo">
                <h2>Create Account</h2>
                <div class="input-group"> <input type="text" id="register-name" class="auth-input" placeholder="Full Name" required> </div>
                <div class="input-group"> <input type="email" id="register-email" class="auth-input" placeholder="Email" required> </div>
                <div class="input-group"> <input type="password" id="register-password" class="auth-input" placeholder="Password (min. 6 characters)" required> </div>
                <div class="input-group"> <input type="text" id="register-mentor-id" class="auth-input" placeholder="Mentor Referral ID (Optional)"> </div>
                <button type="submit" class="auth-button">Sign Up</button>
                <p class="form-toggle"> Already have an account? <a id="show-login">Login</a> </p>
            </form>
             <div id="register-loader" class="auth-loader"></div>
        </div>

        <!-- RESET PASSWORD FORM -->
        <div id="reset-password-form-wrapper" class="auth-form-wrapper">
            <form id="reset-password-form" class="auth-form">
                <img src="https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/Ictex%2F1758033622292.webp?alt=media&token=36f86666-dcfc-4614-a07f-9e3f8bf9a108" alt="ICTEX Trade Logo" class="auth-logo">
                <h2>Reset Password</h2>
                <p style="text-align: center; color: var(--text-secondary); margin-top: -15px; font-size: 0.9rem;">Enter your email to receive a password reset link.</p>
                <div class="input-group"> <input type="email" id="reset-email" class="auth-input" placeholder="Email" required> </div>
                <button type="submit" class="auth-button">Send Reset Link</button>
                <p class="form-toggle"> Remember your password? <a id="back-to-login">Login</a> </p>
            </form>
             <div id="reset-password-loader" class="auth-loader"></div>
        </div>
    </div>

    <!-- MAIN TRADING APP -->
    <div id="main-app-wrapper">
        <div class="app-container">
            <header class="app-header" id="main-app-header">
                <div class="header-top-row">
                    <button id="header-profile-btn" class="header-icon-btn-new" data-view="profile">
                        <img id="header-profile-pic-img" src="" style="display: none;">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"></path></svg>
                        <span id="header-notification-badge" style="display: none;">0</span>
                        <img id="header-verified-badge" class="profile-status-badge-img" src="" alt="Status" style="display: none;">
                    </button>
                    <div id="header-balance-container-new" class="header-balance-container-new">
                        <span id="balance-amount-new">0.00 USDT</span>
                        <div id="balance-account-type">
                            <span>REAL Account</span>
                            <svg id="balance-eye-open" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="16" height="16"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
                            <svg id="balance-eye-closed" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="16" height="16" style="display: none;"><path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.44-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46C3.08 8.3 1.78 10.02 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z"/></svg>
                        </div>
                    </div>
                    <button id="header-wallet-btn" class="header-icon-btn-new square">
                        <img id="header-wallet-icon" src="https://icons.iconarchive.com/icons/icons8/ios7/512/Finance-Wallet-icon.png" alt="Wallet">
                    </button>
                </div>
                <div class="header-market-bar">
                     <button id="market-selector-btn-new">
                        <div class="market-icon-wrapper-header" id="market-icon-wrapper-header">
                            <!-- Icons will be injected by JS -->
                        </div>
                        <span id="current-market-name-new">Loading...</span>
                        <span id="current-market-payout"></span>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708 .708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/></svg>
                    </button>
                    <div class="chart-top-right-controls">
                         <button class="chart-control-btn" id="chart-tools-btn-new" title="Chart Tools">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83L19.5 9.5l1.21-2.46zM3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25z"/></svg>
                        </button>
                        <button class="chart-control-btn" id="chart-timeframe-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M9 4H7v2H5v12h2v2h2v-2h2V6H9V4zm0 12H7V8h2v8zm10-8h-2V4h-2v4h-2v7h2v5h2v-5h2V8zM17 13h-2v-3h2v3z"/></svg>
                            <span>1m</span>
                        </button>
                    </div>
                </div>
            </header>

            <main>
                <!-- Main App Views -->
                <div id="view-chart" class="view active">
                    <section class="chart-section">
                        <div class="sentiment-bar">
                            <span class="sentiment-percent" id="sentiment-percent-down">50%</span>
                            <div class="sentiment-bar-inner" id="sentiment-down"></div>
                            <div class="sentiment-bar-inner" id="sentiment-up"></div>
                            <span class="sentiment-percent" id="sentiment-percent-up">50%</span>
                        </div>
                        <div id="chart-utc-time-display"></div>
                        <canvas id="chart-canvas"></canvas>
                        <div id="chart-loader-overlay">
                           <div class="auth-loader"></div>
                           <span>Syncing chart...</span>
                        </div>
                        <div id="trade-result-queue-container"></div>
                        <button id="goto-live-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M8.59 16.59L13.17 12L8.59 7.41L10 6l6 6l-6 6z"/></svg>
                        </button>
                    </section>
                    <!-- === START: UPDATED CONTROLS SECTION HTML === -->
                    <section class="controls-section new-controls" id="controls-section">
                        <div class="controls-row-1">
                            <span>Fixed Time mode</span>
                            <div class="payout-info-new">
                                <span>Profit: </span>
                                <span id="payout-amount-new">+USDT 8.50</span>
                            </div>
                        </div>
                        <div class="controls-row-2">
                             <div class="input-stepper" id="expiry-stepper">
                                <button class="stepper-btn minus" id="expiry-minus-btn"></button>
                                <div class="stepper-display" id="bet-expiry-btn-new">1 min</div>
                                <button class="stepper-btn plus" id="expiry-plus-btn">+</button>
                            </div>
                            <div class="input-stepper" id="investment-stepper">
                                <button id="btn-minus-new" class="stepper-btn minus"></button>
                                <div class="stepper-display" id="amount-display-new">USDT 10</div>
                                <button id="btn-plus-new" class="stepper-btn plus">+</button>
                            </div>
                        </div>
                        <div class="action-buttons-new">
                           <button class="btn-new btn-down-new" id="btn-down">
                                <span>Down</span>
                                <span class="arrow-icon"></span>
                            </button>
                            <button id="bet-options-btn">
                                <img src="https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/Ictex%2F1756785883519.webp?alt=media&token=4c715a33-1630-4583-90e4-7f55087dda05" alt="Options">
                            </button>
                            <button class="btn-new btn-up-new" id="btn-up">
                                <span>Up</span>
                                <span class="arrow-icon"></span>
                            </button>
                        </div>
                    </section>
                    <!-- === END: UPDATED CONTROLS SECTION HTML === -->
                </div>
                <div id="view-history" class="view">
                    <div class="page-header">
                        <button class="back-btn" data-view="chart">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M15.41 7.41L14 6l-6 6l6 6l1.41-1.41L10.83 12z"/></svg>
                        </button>
                        <h2>Trade History</h2>
                        <button id="clear-history-header-btn" class="header-icon-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                        </button>
                    </div>
                    <div class="page-content" id="history-list-container">
                    </div>
                </div>
                <div id="view-profile" class="view">
                    <div class="page-header">
                        <button class="back-btn" data-view="chart">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M15.41 7.41L14 6l-6 6l6 6l1.41-1.41L10.83 12z"/></svg>
                        </button>
                        
                        <button id="profile-notification-btn" class="header-icon-btn" data-view="notifications" style="position: relative;">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H4V8l8 5 8-5v10zm-8-7L4 6h16l-8 5z"></path></svg>
                            <span id="profile-notification-badge" class="header-notification-badge" style="display: none;">0</span>
                        </button>
                    </div>
                     <div class="page-content">
                        <div class="profile-header">
                            <div class="profile-pic-container">
                                <label for="profile-pic-upload" class="profile-pic-label">
                                    <img id="profile-pic-img" alt="Profile Picture" style="display: none;">
                                    <div class="profile-pic-placeholder">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"></path></svg>
                                        <span>Add Photo</span>
                                    </div>
                                </label>
                                <input type="file" id="profile-pic-upload" accept="image/*" style="display: none;">
                            </div>
                            <div id="profile-info-email"></div>
                            <div id="profile-info-id" style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                                <span></span>
                                <svg id="copy-id-btn" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="18" height="18" style="cursor: pointer; color: var(--text-secondary);"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
                            </div>
                            <div id="profile-verified-status"></div>
                        </div>
                        <form id="profile-form" class="page-form" style="background:transparent; padding:0;">
                             <div class="form-input-group"> <label for="profile-nickname">Nickname</label> <input type="text" id="profile-nickname" class="form-input" maxlength="16"> </div>
                             <div class="form-input-group"> <label for="profile-dob">Date of Birth</label> <input type="date" id="profile-dob" class="form-input"> </div>
                             <div class="form-input-group">
                                <label for="profile-email">Email</label> 
                                <div class="email-verify-group">
                                    <input type="email" id="profile-email" class="form-input" disabled> 
                                    <span id="email-verify-status"></span>
                                </div>
                             </div>
                             <div class="form-input-group"> <label for="profile-country">Country</label> <input type="text" id="profile-country" class="form-input"> </div>
                             <div class="form-input-group"> <label for="profile-address">Address</label> <input type="text" id="profile-address" class="form-input"> </div>
                             <button type="submit" class="save-button">Save Changes</button>
                        </form>

                        <div style="padding: 0 10px; margin-top: 20px;">
                             <a href="#" id="kyc-link" class="settings-link"> <span>KYC Verification</span> <span id="kyc-status-badge" class="status-badge"></span> </a>
                        </div>
                        
                        <div id="kyc-verified-info-box" style="display: none; padding: 0 10px; margin-top: 20px;">
                            <h4 style="font-weight: 500; margin-bottom: 10px; color: var(--text-primary);">Documents verification:</h4>
                            <div style="background-color: rgba(0, 200, 83, 0.2); color: var(--color-up); border-radius: 8px; padding: 15px; display: flex; align-items: center; gap: 10px; font-size: 0.9rem;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10s10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5l1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                                <span>Your documents have been checked, now your identity is verified.</span>
                            </div>
                        </div>

                        <div class="page-form" style="background:transparent; padding:0; margin-top: 30px;">
                            <form id="change-password-form" class="page-form" style="gap: 15px;">
                                <div class="form-input-group">
                                    <label for="old-password">Old password</label>
                                    <input type="password" id="old-password" class="form-input" required>
                                </div>
                                <div class="form-input-group">
                                    <label for="new-password">New password</label>
                                    <input type="password" id="new-password" class="form-input" required>
                                </div>
                                <div class="form-input-group">
                                    <label for="confirm-new-password">Confirm new password</label>
                                    <input type="password" id="confirm-new-password" class="form-input" required>
                                </div>
                                <button type="submit" class="save-button">Change Password</button>
                            </form>
                        </div>
                        
                        <!-- NEW: Mentor Info Section -->
                        <div id="mentor-info-section" class="page-form" style="background:transparent; padding:0; margin-top: 20px; display: none;">
                             <div class="form-input-group">
                                <label>My Mentor</label>
                                <input type="text" id="my-mentor-name" class="form-input" readonly>
                             </div>
                             <div class="form-input-group">
                                <label>Mentor Code</label>
                                <input type="text" id="my-mentor-code" class="form-input" readonly>
                             </div>
                        </div>

                        <div class="page-form" style="background:transparent; padding:0; margin-top: 20px;">
                            <div class="form-input-group">
                                <label for="grid-visibility-slider">Chart Grid Line Visibility</label>
                                <div class="slider-container">
                                    <input type="range" id="grid-visibility-slider" min="1" max="8" step="1" value="8">
                                    <span id="grid-visibility-value">8</span>
                                </div>
                            </div>
                             <div class="form-input-group" style="margin-top: 15px;">
                                <label for="utc-time-visibility-slider">Chart UTC Clock Visibility</label>
                                <div class="slider-container">
                                    <input type="range" id="utc-time-visibility-slider" min="1" max="8" step="1" value="8">
                                    <span id="utc-time-visibility-value">8</span>
                                </div>
                            </div>
                            <div class="form-input-group" style="margin-top: 15px;">
                                <label for="timezone-select">Timezone</label>
                                <select id="timezone-select" class="form-input"></select>
                            </div>
                        </div>

                        <div style="padding: 0 10px; margin-top: 30px; margin-bottom: 20px;">
                            <button id="delete-account-link-profile" style="background: none; border: none; color: var(--color-down); font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 8px; padding: 0;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10s10-4.48 10-10S17.52 2 12 2zm5 13.59L15.59 17L12 13.41L8.41 17L7 15.59L10.59 12L7 8.41L8.41 7L12 10.59L15.59 7L17 8.41L13.41 12L17 15.59z"/></svg>
                                Delete Account
                            </button>
                        </div>
                    </div>
                </div>
                <div id="view-leaderboard" class="view">
                    <div class="page-header">
                        <button class="back-btn" data-view="chart"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M15.41 7.41L14 6l-6 6l6 6l1.41-1.41L10.83 12z"/></svg> </button>
                        <h2>Leader Board <small style="color:var(--text-secondary);font-weight:400;">of the Day</small></h2>
                        <button id="leaderboard-help-icon-btn" class="header-icon-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10s10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41c0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/></svg>
                        </button>
                    </div>
                    <div class="page-content" style="padding: 15px 0; display: flex; flex-direction: column;">
                        <div id="leaderboard-loader">
                             <img src="https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/Ictex%2F1758033622292.webp?alt=media&token=36f86666-dcfc-4614-a07f-9e3f8bf9a108" alt="Loading...">
                        </div>
                        <div id="leaderboard-content">
                            <div id="leaderboard-calculating-state">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2Zm0 18a8 8 0 1 1 8-8a8 8 0 0 1 -8 8Zm1-12h-2v5.41l4.28 2.54l.72-1.21l-3.5-2.08Z"></path></svg>
                                <h3>Calculating Results...</h3>
                                <p>Today's leaderboard is being calculated. Please check back shortly.</p>
                            </div>
                            <div id="leaderboard-my-rank">
                                <!-- My rank will be injected here -->
                            </div>
                            <div id="leaderboard-list">
                                <!-- Top 50 list will be injected here -->
                            </div>
                        </div>
                    </div>
                </div>
                <!-- NEW NOTIFICATIONS VIEW -->
                <div id="view-notifications" class="view">
                    <div class="page-header">
                        <button class="back-btn" data-view="chart"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M15.41 7.41L14 6l-6 6l6 6l1.41-1.41L10.83 12z"/></svg> </button>
                        <h2>Notifications</h2>
                        <div style="width: 34px;"></div> <!-- Spacer -->
                    </div>
                    <div id="notification-list-container" class="page-content">
                        <!-- Notifications will be rendered here by JS -->
                    </div>
                </div>
                <div id="view-settings" class="view">
                    <div class="page-header">
                         <button class="back-btn" data-view="chart"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M15.41 7.41L14 6l-6 6l6 6l1.41-1.41L10.83 12z"/></svg> </button>
                        <h2>Settings</h2>
                         <div style="width: 34px;"></div>
                    </div>
                    <div class="page-content">
                        <div class="settings-list-container">
                            <a class="settings-list-item" data-view="profile">
                                <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"></path></svg>
                                <span class="text">Account</span>
                                <svg class="chevron-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M8.59 16.59L13.17 12L8.59 7.41L10 6l6 6-6 6-1.41-1.41z"/></svg>
                            </a>
                            <a class="settings-list-item" data-view="analysis">
                                <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6l4 4l6.3-6.29L22 12V6h-6z"/></svg>
                                <span class="text">Trade Analysis</span>
                                <svg class="chevron-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M8.59 16.59L13.17 12L8.59 7.41L10 6l6 6-6 6-1.41-1.41z"/></svg>
                            </a>
                            <a class="settings-list-item" data-view="transactions">
                                <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20 6h-2.18c.11-.31.18-.65.18-1c0-1.66-1.34-3-3-3s-3 1.34-3 3c0 .35.07.69.18 1H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-5-2c.55 0 1 .45 1 1s-.45 1-1 1s-1-.45-1-1s.45-1 1-1zM4 19V8h16v11H4z"/></svg>
                                <span class="text">Transactions</span>
                                <svg class="chevron-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M8.59 16.59L13.17 12L8.59 7.41L10 6l6 6-6 6-1.41-1.41z"/></svg>
                            </a>
                            <a class="settings-list-item" data-view="miner">
                                <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19.1 4.9C15.2 1 8.8 1 4.9 4.9S1 15.2 4.9 19.1s8.4 3.9 12.3 0l-1.4-1.4c-3.1 3.1-8.2 3.1-11.3 0S2.9 8.2 6 5.1s8.2-3.1 11.3 0L19.1 4.9zM12 8c-2.2 0-4 1.8-4 4s1.8 4 4 4 4-1.8 4-4-1.8-4-4-4zm0 6c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/></svg>
                                <span class="text">Bitcoin Miner</span>
                                <svg class="chevron-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M8.59 16.59L13.17 12L8.59 7.41L10 6l6 6-6 6-1.41-1.41z"/></svg>
                            </a>
                            <a class="settings-list-item" data-view="rewards">
                                <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4c-1.11 0-2 .89-2 2v12a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2zm0 14H4V6h16v12zM12 12a4 4 0 0 1-8 0 4 4 0 0 1 8 0zm-4-2a2 2 0 0 0 0 4 2 2 0 0 0 0-4zm11-1h-6v2h6V9zm0 4h-6v2h6v-2z"/></svg>
                                <span class="text">Task Reward</span>
                                <svg class="chevron-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M8.59 16.59L13.17 12L8.59 7.41L10 6l6 6-6 6-1.41-1.41z"/></svg>
                            </a>
                            <a class="settings-list-item" data-view="mentor">
                                <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05c1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
                                <span class="text">Mentor Referral</span>
                                <svg class="chevron-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M8.59 16.59L13.17 12L8.59 7.41L10 6l6 6-6 6-1.41-1.41z"/></svg>
                            </a>
                             <a class="settings-list-item" data-view="crypto-box">
                                <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20 6h-2.18c.11-.31.18-.65.18-1c0-1.66-1.34-3-3-3s-3 1.34-3 3c0 .35.07.69.18 1H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-5-2c.55 0 1 .45 1 1s-.45 1-1 1s-1-.45-1-1s.45-1 1-1zM4 19V8h16v11H4z"/></svg>
                                <span class="text">Crypto Box</span>
                                <svg class="chevron-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M8.59 16.59L13.17 12L8.59 7.41L10 6l6 6-6 6-1.41-1.41z"/></svg>
                            </a>
                             <a id="support-grid-btn" class="settings-list-item" data-view="support">
                                <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10s10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
                                <span class="text">Support</span>
                                <svg class="chevron-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M8.59 16.59L13.17 12L8.59 7.41L10 6l6 6-6 6-1.41-1.41z"/></svg>
                            </a>
                            <button id="logout-button" class="settings-logout-btn">Logout</button>
                        </div>
                        <a href="#" data-view="terms" id="terms-link" class="settings-list-item" style="justify-content: center; margin-top: 20px; text-decoration: none;">Terms & Conditions</a>
                    </div>
                </div>
                
                 <div id="view-support" class="view">
                    <div class="page-content">
                        <button class="back-btn" data-view="settings" style="position: absolute; top: 15px; left: 15px; z-index: 3; background-color: rgba(0,0,0,0.4); border-radius: 50%; width: 40px; height: 40px; padding: 8px;">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="color: white;"><path d="M15.41 7.41L14 6l-6 6l6 6l1.41-1.41L10.83 12z"></path></svg>
                        </button>
                        <div class="support-background"></div>
                        <div class="support-button-container">
                             <a href="https://t.me/Ictexsupport_bot" target="_blank" class="modal-button primary">Live Support (Telegram)</a>
                             <a href="mailto:ictexbroker@gmail.com" class="modal-button secondary">Email Support</a>
                        </div>
                    </div>
                </div>

                <div id="view-miner" class="view">
                    <div class="page-header">
                        <button class="back-btn" data-view="settings">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M15.41 7.41L14 6l-6 6l6 6l1.41-1.41L10.83 12z"/></svg>
                        </button>
                        <h2>Bitcoin Miner</h2>
                        <button id="miner-history-btn" class="header-icon-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2Zm0 18a8 8 0 1 1 8-8a8 8 0 0 1 -8 8Zm1-12h-2v5.41l4.28 2.54l.72-1.21l-3.5-2.08Z"></path></svg>
                        </button>
                    </div>
                    <div class="page-content" id="miner-page-content">
                        <!-- New Miner UI will be rendered by JS -->
                    </div>
                </div>
                
                <div id="view-miner-history" class="view">
                    <div class="page-header">
                        <button class="back-btn" data-view="miner">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M15.41 7.41L14 6l-6 6l6 6l1.41-1.41L10.83 12z"/></svg>
                        </button>
                        <h2>Mining History</h2>
                        <div style="width: 34px;"></div>
                    </div>
                    <div class="page-content">
                        <div id="miner-history-list">
                            <!-- History items will be rendered here -->
                        </div>
                    </div>
                </div>

                <div id="view-rewards" class="view">
                    <div class="page-header">
                        <button class="back-btn" data-view="settings"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M15.41 7.41L14 6l-6 6l6 6l1.41-1.41L10.83 12z"/></svg> </button>
                        <h2>Task Rewards</h2>
                    </div>
                    <div class="page-content">
                        <div class="tasks-container" id="tasks-container">
                            <!-- Tasks will be rendered here by JS -->
                        </div>
                    </div>
                </div>
                 <div id="view-crypto-box" class="view">
                    <div class="page-header">
                        <button class="back-btn" data-view="settings">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M15.41 7.41L14 6l-6 6l6 6l1.41-1.41L10.83 12z"/></svg>
                        </button>
                        <h2>Crypto Box</h2>
                        <button id="crypto-box-history-btn" class="header-icon-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2Zm0 18a8 8 0 1 1 8-8a8 8 0 0 1 -8 8Zm1-12h-2v5.41l4.28 2.54l.72-1.21l-3.5-2.08Z"></path></svg>
                        </button>
                    </div>
                    <div class="page-content">
                        <p>No Crypto Box available.</p>
                    </div>
                </div>

                <!-- Sub-page Views (KYC, Withdraw, etc.) -->
                <div id="view-kyc" class="view">
                    <div class="page-header">
                        <button class="back-btn" data-view="profile"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M15.41 7.41L14 6l-6 6l6 6l1.41-1.41L10.83 12z"/></svg> </button>
                        <h2>KYC Verification</h2>
                    </div>
                    <div class="page-content">
                        <div id="kyc-current-status-info" style="display:none;"></div>
                        <form id="kyc-form" class="page-form kyc-form">
                            <div class="kyc-info-box">
                                <p>To ensure account security, we require identity verification. Please submit clear and valid documents. This process can take up to 48 hours.</p>
                            </div>
                            <div class="form-input-group">
                                <label for="kyc-doc-type">Document Type</label>
                                <select id="kyc-doc-type" class="form-input">
                                    <option value="nid">National ID Card</option>
                                    <option value="passport">Passport</option>
                                </select>
                            </div>
                            <div class="form-input-group" id="kyc-nid-group">
                                <label for="kyc-nid-number">ID Card Number</label>
                                <input type="text" id="kyc-nid-number" class="form-input" placeholder="Enter your ID card number">
                            </div>
                            <div class="form-input-group">
                                <label for="kyc-file-front" class="proof-upload-label">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                                    <span>Upload Document Front Side</span>
                                    <span id="kyc-file-front-name" class="file-name">No file chosen</span>
                                </label>
                                <input type="file" id="kyc-file-front" accept="image/*" required>
                            </div>
                            <div class="form-input-group">
                                <label for="kyc-file-back" class="proof-upload-label">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                                    <span>Upload Document Back Side</span>
                                    <span id="kyc-file-back-name" class="file-name">No file chosen</span>
                                </label>
                                <input type="file" id="kyc-file-back" accept="image/*" required>
                            </div>
                            <div class="form-input-group">
                                <label for="kyc-file-selfie" class="proof-upload-label">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4s-4 1.79-4 4s1.79 4 4 4Zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4Z"/></svg>
                                    <span>Upload a Selfie</span>
                                    <span id="kyc-file-selfie-name" class="file-name">No file chosen</span>
                                </label>
                                <input type="file" id="kyc-file-selfie" accept="image/*" required>
                            </div>
                            <button type="submit" id="kyc-submit-button" class="save-button">Submit for Verification</button>
                        </form>
                    </div>
                </div>
                <div id="view-withdraw" class="view">
                    <div class="page-header">
                        <button class="back-btn" data-view="settings"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M15.41 7.41L14 6l-6 6l6 6l1.41-1.41L10.83 12z"/></svg> </button>
                        <h2>Withdraw</h2>
                    </div>
                    <div class="page-content">
                        <div class="withdraw-info-cards">
                            <div class="withdraw-info-card"> <div class="label">Total Balance</div> <div id="withdraw-total-balance" class="value">$0.00</div> </div>
                            <div class="withdraw-info-card"> <div class="label">Available</div> <div id="withdraw-available-balance" class="value">$0.00</div> </div>
                            <div class="withdraw-info-card"> <div class="label">Bonus</div> <div id="withdraw-commission" class="value">$0.00</div> </div>
                        </div>
                        <div class="premium-card">
                            <h3>Withdrawal Details</h3>
                            <form id="withdraw-form" class="page-form">
                                 <div class="form-input-group">
                                     <label for="withdraw-amount">Amount (USD)</label>
                                     <input type="number" id="withdraw-amount" class="form-input" placeholder="Min $50" required>
                                     <p id="withdraw-fee-info"></p>
                                 </div>
                                <div class="form-input-group"> <label>Payment method</label> <div id="withdraw-method-selector" class="custom-select" data-value="binance-pay">Binance Pay</div> </div>
                                 <div class="form-input-group"> <label for="withdraw-receive-type">Receive type</label> <input type="text" id="withdraw-receive-type" class="form-input" readonly> </div>
                                <div class="form-input-group"> <label for="withdraw-account-id">Account ID / Address</label> <input type="text" id="withdraw-account-id" class="form-input" required> </div>
                                <button type="submit" class="save-button">Confirm Withdrawal</button>
                            </form>
                        </div>
                    </div>
                </div>
                <div id="view-analysis" class="view">
                     <div class="page-header">
                        <button class="back-btn" data-view="settings"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M15.41 7.41L14 6l-6 6l6 6l1.41-1.41L10.83 12z"/></svg> </button>
                        <h2>Trade Analysis</h2>
                    </div>
                    <div class="page-content">
                        <div class="premium-card" style="margin: 0 10px 20px; text-align: center;">
                            <h3 style="text-align: center; margin-top: 0; margin-bottom: 8px; font-size: 1rem; color: var(--text-secondary);">Total Trading Volume</h3>
                            <div id="analysis-total-volume" class="stat-card-value" style="font-size: 2rem; color: var(--color-golden);">$0.00</div>
                        </div>
                        <div class="analysis-filters">
                            <button class="filter-btn active" data-period="all">All Time</button> <button class="filter-btn" data-period="7d">7 Days</button>
                            <button class="filter-btn" data-period="3d">3 Days</button> <button class="filter-btn" data-period="1d">Today</button>
                        </div>
                        <div class="analysis-grid">
                            <div class="stat-card"> <div class="stat-card-title">Win Rate</div> <div id="analysis-win-rate" class="stat-card-value">0%</div> </div>
                            <div class="stat-card"> <div class="stat-card-title">Profit / Loss</div> <div id="analysis-pnl" class="stat-card-value">$0.00</div> </div>
                            <div class="stat-card"> <div class="stat-card-title">Total Trades</div> <div id="analysis-total-trades" class="stat-card-value">0</div> </div>
                            <div class="stat-card"> <div class="stat-card-title">Avg. Investment</div> <div id="analysis-avg-invest" class="stat-card-value">$0.00</div> </div>
                        </div>
                        <div id="top-instruments-section" style="margin: 30px 10px 10px 10px; background: var(--primary-surface); padding: 20px; border-radius: 12px; display: none; border: 1px solid var(--border-color);">
                            <h3 style="text-align: center; margin-top: 0; margin-bottom: 25px;">Top 3 Most Profitable Instruments</h3>
                            <div style="display: flex; flex-direction: column; align-items: center; gap: 25px;">
                                <div id="top-instruments-pie-chart" style="width: 150px; height: 150px; border-radius: 50%;"></div>
                                <div id="top-instruments-legend" style="width: 100%; display: flex; flex-direction: column; gap: 15px;">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="view-transactions" class="view">
                    <div class="page-header">
                        <button class="back-btn" data-view="settings"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M15.41 7.41L14 6l-6 6l6 6l1.41-1.41L10.83 12z"/></svg> </button>
                        <h2>Transactions</h2>
                    </div>
                    <div class="page-content"> <div id="transaction-list-container"></div> </div>
                </div>
                <div id="view-mentor" class="view">
                    <div class="page-header">
                        <button class="back-btn" data-view="settings"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M15.41 7.41L14 6l-6 6l6 6l1.41-1.41L10.83 12z"/></svg> </button>
                        <h2>Mentor Referral</h2>
                    </div>
                    <div class="page-content" id="mentor-page-content">
                    </div>
                </div>
                <div id="view-mentor-users" class="view">
                    <div class="page-header">
                        <button class="back-btn" data-view="mentor"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M15.41 7.41L14 6l-6 6l6 6l1.41-1.41L10.83 12z"/></svg> </button>
                        <h2>My Users</h2>
                        <button id="mentor-deleted-users-btn" class="header-icon-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                        </button>
                    </div>
                    <div class="page-content" id="mentor-user-list-content">
                    </div>
                </div>
                <div id="view-crypto-box" class="view">
                    <div class="page-header">
                        <button class="back-btn" data-view="settings">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M15.41 7.41L14 6l-6 6l6 6l1.41-1.41L10.83 12z"/></svg>
                        </button>
                        <h2>Crypto Box</h2>
                        <button id="crypto-box-history-btn" class="header-icon-btn">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2Zm0 18a8 8 0 1 1 8-8a8 8 0 0 1 -8 8Zm1-12h-2v5.41l4.28 2.54l.72-1.21l-3.5-2.08Z"></path></svg>
                        </button>
                    </div>
                    <div class="page-content">
                        <p>No Crypto Box available.</p>
                    </div>
                </div>
                <div id="view-terms" class="view">
                     <div class="page-header">
                        <button class="back-btn" data-view="settings"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M15.41 7.41L14 6l-6 6l6 6l1.41-1.41L10.83 12z"/></svg> </button>
                        <h2>Terms & Conditions</h2>
                         <div style="width: 34px;"></div>
                    </div>
                    <div class="page-content">
                        <h3>Terms & Conditions</h3>
                        <h4>1. Acceptance of Terms</h4>
                        <p>By registering for and using the ICTEX trading platform ("Service"), you agree to be bound by these Terms and Conditions ("Terms"). If you do not agree to these Terms, do not use the Service.</p>

                        <h4>2. Eligibility and Account</h4>
                        <p>You must be at least 18 years old to use our Service. You are responsible for maintaining the confidentiality of your account credentials and for all activities that occur under your account. You agree to provide accurate and complete information during registration.</p>

                        <h4>3. Deposits and Withdrawals</h4>
                        <p>
                            <ul>
                                <li>All transactions are processed in USD. Conversions from other currencies are subject to prevailing exchange rates.</li>
                                <li>You agree to use only payment methods that belong to you.</li>
                                <li>Withdrawals are subject to verification processes, including but not to KYC (Know Your Customer) checks. We reserve the right to delay or reject withdrawals if fraudulent activity is suspected.</li>
                                <li>Bonus funds are for trading purposes only and cannot be withdrawn directly. Profits made from trading with bonus funds may be withdrawn subject to specific promotional rules.</li>
                            </ul>
                        </p>

                        <h4>4. Trading and Risk Disclosure</h4>
                        <p>Trading in financial markets involves a high level of risk and may not be suitable for all investors. You acknowledge that you understand these risks and that you are trading with funds you can afford to lose. ICTEX does not provide financial advice. The market data provided is for informational purposes only, and we are not liable for any trading decisions you make based on it.</p>
                        
                        <h4>5. Prohibited Activities</h4>
                        <p>You are prohibited from:
                            <ul>
                                <li>Using any automated software or bots to interact with the platform.</li>
                                <li>Opening multiple accounts without prior written consent.</li>
                                <li>Engaging in any form of market manipulation, arbitrage, or fraudulent activity.</li>
                                <li>Using the Service for any illegal activities, including money laundering.</li>
                                <li>Engaging in any form of platform manipulation, including but not to exploiting trade timing or pricing glitches. Any such activity may result in immediate account suspension and forfeiture of all funds.</li>
                                <li>Placing an excessive number of concurrent trades before prior trades are resolved. This is considered high-risk gambling behavior and may lead to temporary account suspension.</li>
                            </ul>
                            Violation of these rules may result in immediate account suspension, forfeiture of funds, and legal action.
                        </p>
                        
                        <h4>6. Limitation of Liability</h4>
                        <p>The Service is provided "as is." We do not guarantee that the Service will be uninterrupted or error-free. In no event shall ICTEX, its directors, or employees be liable for any direct, indirect, or consequential loss or damage arising out of your use of the Service.</p>

                        <h4>7. Account Termination</h4>
                        <p>We reserve the right to suspend or terminate your account at our sole discretion, without notice, for any violation of these Terms or for any other reason.</p>
                        
                        <h4>8. Mentor Program</h4>
                        <p>
                            <ul>
                                <li>To become a Mentor, users must meet specific criteria set by ICTEX, including but not limited to, completing KYC verification, making a first deposit, and executing a minimum number of trades.</li>
                                <li>Mentors are responsible for the users they refer. Any fraudulent activity by a referred user may impact the Mentor's status and earnings.</li>
                                <li>Commissions and salaries are subject to change and are paid based on the activity and volume of referred users, as outlined in the Mentor dashboard.</li>
                                <li>ICTEX reserves the right to suspend or terminate a Mentor's status at any time for violation of these terms, unethical promotional practices, or any other reason deemed appropriate by the company.</li>
                            </ul>
                        </p>
                        
                        <h4>9. Amendments</h4>
                        <p>We may amend these Terms at any time by posting the revised version on our platform. Your continued use of the Service after such changes constitutes your acceptance of the new Terms.</p>
                    </div>
                </div>

                <!-- PREMIUM DEPOSIT VIEWS -->
                <div id="view-deposit-new" class="view">
                    <div class="page-header">
                        <button class="back-btn" data-view="settings"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M15.41 7.41L14 6l-6 6l6 6l1.41-1.41L10.83 12z"/></svg> </button>
                        <h2>Deposit</h2>
                    </div>
                    <div class="page-content">
                        <div class="deposit-card-new">
                            <label>Deposit Amount (USD)</label>
                            <div class="deposit-amount-display">
                                <span class="dollar-sign">$</span>
                                <input type="number" id="deposit-amount-usd-new" placeholder="Min 10 USD">
                            </div>
                            <div class="quick-amount-buttons-new">
                                <button class="quick-amount-btn-new" data-amount="10">$10</button>
                                <button class="quick-amount-btn-new" data-amount="50">$50</button>
                                <button class="quick-amount-btn-new" data-amount="100">$100</button>
                                <button class="quick-amount-btn-new" data-amount="500">$500</button>
                            </div>
                        </div>

                        <div class="deposit-card-new">
                            <label>Recommended Bonuses</label>
                            <div id="promo-option-btn-container" class="promo-option-btn-container">
                                <button class="promo-option-btn" data-code="IC-10P-15TEX" data-min="150" data-percent="10">
                                    <span class="promo-option-title">+10% BONUS</span>
                                    <span class="promo-option-details">on deposits from $150</span>
                                </button>
                                <button class="promo-option-btn" data-code="IC-30P-70TEX" data-min="700" data-percent="30">
                                    <span class="promo-option-title">+30% BONUS</span>
                                    <span class="promo-option-details">on deposits from $700</span>
                                </button>
                                <button class="promo-option-btn" data-code="IC-50P-300TEX" data-min="3000" data-percent="50">
                                    <span class="promo-option-title">+50% BONUS</span>
                                    <span class="promo-option-details">on deposits from $3000</span>
                                </button>
                            </div>
                        </div>

                        <div class="deposit-card-new">
                            <label>Promo Code (Optional)</label>
                            <div class="promo-code-wrapper-new">
                                <input type="text" id="promo-code-new" placeholder="Enter promo code">
                                <button id="apply-promo-btn-new">Apply</button>
                            </div>
                            <div id="promo-feedback-new" class="promo-feedback">
                                <span id="promo-feedback-text"></span>
                                <p id="promo-calculation-display" style="display:none;"></p>
                            </div>
                        </div>
                        <button id="deposit-next-btn-new" disabled>Next</button>
                    </div>
                </div>
                
                <div id="view-deposit-methods" class="view">
                    <div class="page-header">
                        <button class="back-btn" data-view="deposit-new"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M15.41 7.41L14 6l-6 6l6 6l1.41-1.41L10.83 12z"/></svg> </button>
                        <h2>Select Payment Method</h2>
                    </div>
                    <div class="page-content">
                        <div id="payment-method-grid"></div>
                    </div>
                </div>
                
                <div id="view-payment-details" class="view">
                    <div class="page-header">
                        <button class="back-btn" data-view="deposit-methods"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M15.41 7.41L14 6l-6 6l6 6l1.41-1.41L10.83 12z"/></svg> </button>
                        <h2>Payment</h2>
                    </div>
                    <div class="page-content" id="payment-details-content-new"></div>
                </div>

            </main>
            
            <nav class="app-nav new-nav">
                <button class="nav-btn-new active" data-view="chart">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M10 20h4V4h-4v16zm-6 0h4v-8H4v8zM16 9v11h4V9h-4z"></path></svg>
                    <span>Terminal</span>
                </button>
                <button class="nav-btn-new" data-view="history">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M15 1H9v2h6V1zm-4 13h2V8h-2v6zm8.03-6.61l1.42-1.42c-.43-.51-.9-.99-1.41-1.41l-1.42 1.42C16.07 4.74 14.12 4 12 4c-4.97 0-9 4.03-9 9s4.02 9 9 9 9-4.03 9-9c0-2.12-.74-4.07-1.97-5.61zM12 20c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"></path></svg>
                    <span>Trades</span>
                </button>
                <button class="nav-btn-new" data-view="profile">
                     <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"></path></svg>
                    <span>Account</span>
                </button>
                <button class="nav-btn-new" data-view="leaderboard">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zM6 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm12 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm-3.32 5.02c-.37.03-.74.05-1.11.05s-.74-.02-1.11-.05C11.89 12.11 11.45 13 11 13h-2c-.45 0-.89-.89-1.46-1.93-.37-.03-.74-.05-1.11-.05s-.74.02-1.11-.05C4.6 12.11 4.16 13 3.71 13H2v2h1.42c.49 0 .93-.82 1.48-2.03.37-.02.75-.04 1.13-.04s.76.02 1.13.04c.55 1.21.99 2.03 1.48 2.03H12v-2h-.29c-.45 0-.89-.89-1.46-1.93.37-.03.74-.05 1.11-.05s.74.02 1.11.05c.58 1.04 1.02 1.93 1.46 1.93H15v2h-1.29c-.45 0-.89-.82-1.48-2.03.37-.02.75-.04 1.13-.04s.76.02 1.13.04c.55 1.21.99 2.03 1.48 2.03H22v-2h-1.71c-.45 0-.89-.89-1.46-1.93z"/></svg>
                    <span>Leaderboard</span>
                </button>
                <button class="nav-btn-new" data-view="settings">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="m9.25 22l-.4-3.2q-.325-.125-.613-.3t-.562-.35l-3.025 1.25l-2.8-4.85l2.4-1.95q-.05-.2-.075-.4t-.025-.5q0-.2.025-.5t-.075-.4l-2.4-1.95l2.8-4.85l3.025 1.25q.275-.175-.562-.35t.613-.3L9.25 2h5.5l.4 3.2q.325.125.613-.3t.562.35l3.025-1.25l2.8 4.85l-2.4 1.95q.05.2.075-.4t.025-.5q0 .2-.025-.5t-.075-.4l2.4 1.95l-2.8 4.85l-3.025-1.25q-.275-.175-.562-.35t-.613-.3l-.4 3.2h-5.5Zm2.75-6.5q1.45 0 2.475-1.025T15.5 12q0-1.45-1.025-2.475T12 8.5q-1.45 0-2.475 1.025T8.5 12q0 1.45 1.025 2.475T12 15.5Z"></path></svg>
                    <span>Settings</span>
                </button>
            </nav>
            
            <!-- Modals -->
            <div class="modal-overlay" id="market-selector-modal">
                <div class="modal-content">
                    <div class="market-modal-header">
                        <h2>Select Trade Pair</h2>
                        <button id="market-modal-close-btn">&times;</button>
                    </div>
                    <div class="market-modal-body">
                        <div class="market-filters">
                            <button id="favorite-filter-btn" class="market-filter-btn">
                                <span class="star-icon"></span>
                                <span id="favorite-count">0</span>
                            </button>
                             <div class="search-input-wrapper">
                                <input type="text" id="market-search-input" class="auth-input" placeholder="Search...">
                                <button id="search-clear-btn">&times;</button>
                            </div>
                        </div>
                        <div class="market-filters" style="gap: 5px;">
                            <button class="market-filter-btn active" data-filter="all">All</button>
                            <button class="market-filter-btn" data-filter="crypto">Crypto</button>
                            <button class="market-filter-btn" data-filter="stock">Stock</button>
                        </div>
                        <div class="market-list-header">
                            <span class="header-label"></span>
                            <span class="header-label"></span>
                            <span class="header-label">Pair Name</span>
                            <span class="header-label">24h Change</span>
                        </div>
                        <div id="market-list-container">
                            <!-- Market list will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>

            <div id="bet-expiry-modal"></div>
            
            <div class="modal-overlay" id="chart-tools-modal">
                <div class="modal-content">
                    <div class="chart-tools-header">
                        <div class="chart-tools-tabs">
                            <button class="chart-tools-tab active" data-tab="indicators">Indicators</button>
                            <button class="chart-tools-tab" data-tab="colors">Candle Colors</button>
                            <button class="chart-tools-tab" data-tab="settings">Tools</button>
                        </div>
                        <button id="chart-tools-close-btn">&times;</button>
                    </div>
                    <div class="chart-tools-body">
                        <div class="chart-tools-content active" id="tools-tab-indicators">
                            <ul class="indicator-list" id="indicator-list">
                            </ul>
                        </div>
                        <div class="chart-tools-content" id="tools-tab-colors">
                        </div>
                        <div class="chart-tools-content" id="tools-tab-settings">
                            <p>Coming Soon</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-overlay" id="withdraw-method-modal">
                <div class="modal-content"> <h3>Select Withdrawal Method</h3> <div id="withdraw-method-options" class="method-option-list"></div> </div>
            </div>

            <!-- MODIFICATION: Redesigned Mentor Withdraw Modal -->
            <div class="modal-overlay" id="mentor-earnings-withdraw-modal">
                <div class="modal-content"> 
                    <h3>Withdraw Mentor Earnings</h3>
                    <div class="premium-card" style="padding: 15px; margin: 0;">
                        <form id="mentor-earnings-withdraw-form" class="page-form" style="gap: 20px;">
                            <div class="form-input-group">
                                 <label>Available to Withdraw</label> 
                                 <input type="text" id="mentor-withdraw-available" class="form-input" readonly> 
                            </div>
                            <div class="form-input-group">
                                 <label for="mentor-withdraw-amount">Amount (USD)</label>
                                 <input type="number" id="mentor-withdraw-amount" class="form-input" placeholder="Min $1000" required>
                            </div>
                            <div class="form-input-group"> 
                                <label>Payment method</label> 
                                <input type="text" class="form-input" value="Binance Pay" readonly>
                            </div>
                            <div class="form-input-group"> 
                                <label for="mentor-withdraw-account-id">Binance Account ID</label> 
                                <input type="text" id="mentor-withdraw-account-id" class="form-input" placeholder="Enter your Binance Pay ID" required> 
                            </div>
                            <button type="submit" class="save-button" style="margin-top: 5px;">Confirm Withdrawal</button>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="modal-overlay" id="investment-amount-modal">
                <div class="modal-content">
                    <h3>Enter Investment Amount</h3>
                    <div class="form-input-group">
                        <input type="number" id="manual-amount-input" class="form-input" step="1" min="1" max="1000" placeholder="Enter amount">
                    </div>
                    <div class="modal-button-row">
                        <button id="cancel-amount-btn" class="modal-button secondary">Cancel</button>
                        <button id="confirm-amount-btn" class="modal-button primary">Confirm</button>
                    </div>
                </div>
            </div>
            
            <div class="modal-overlay" id="mentor-warning-modal">
                <div class="modal-content">
                    <h3>Account Security Warning</h3>
                    <p>This email is also associated with a Mentor account. For security reasons, using the same email for both trading and mentoring is a potential risk. Please consider deleting one of the accounts.</p>
                    <button id="mentor-warning-close-btn" class="modal-button primary">Close</button>
                </div>
            </div>

             <div class="modal-overlay" id="multiple-trades-warning-modal">
                <div class="modal-content">
                    <h3>Risk Warning</h3>
                    <p>Placing multiple concurrent trades is against broker rules and is considered high-risk behavior. Continuing to do so will result in a temporary account ban.</p>
                    <button id="multiple-trades-warning-close-btn" class="modal-button primary">I Understand</button>
                </div>
            </div>
            
            <div class="modal-overlay" id="password-confirm-modal">
                 <div class="modal-content">
                    <h3>Confirm Withdrawal</h3>
                    <p style="text-align:left; color: var(--text-secondary);">Enter your password to authorize this transaction.</p>
                    <form id="password-confirm-form">
                        <div class="form-input-group"> <label for="confirm-password">Password</label> <input type="password" id="confirm-password" class="form-input" required> </div>
                        <button type="submit" class="save-button">Authorize</button>
                    </form>
                </div>
            </div>

            <div class="modal-overlay" id="delete-account-modal">
                <div class="modal-content">
                    <h3>Delete Account</h3>
                    <p style="text-align:left; color: var(--text-secondary);">This action will submit a deletion request to our administrators. This is irreversible once approved. Enter your password to confirm.</p>
                    <form id="delete-account-form">
                        <div class="form-input-group">
                            <label for="delete-confirm-password">Password</label>
                            <input type="password" id="delete-confirm-password" class="form-input" required>
                        </div>
                        <button type="submit" class="save-button" style="background-color: var(--color-down);">Request Deletion</button>
                    </form>
                </div>
            </div>

             <div class="modal-overlay" id="leaderboard-help-modal">
                 <div class="modal-content">
                    <svg class="lb-help-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L9.5 7H14.5L12 2ZM8.5 7L5 8.5L6.5 4L8.5 7ZM15.5 7L19 8.5L17.5 4L15.5 7ZM4.5 9H19.5L21 12H3L4.5 9ZM3 13H21V19C21 20.1 20.1 21 19 21H5C3.9 21 3 20.1 3 19V13Z"/></svg>
                    <h3>How does it work?</h3>
                     <p style="text-align: center; color: var(--text-secondary); margin-top: -10px;">All traders on our platform participate in this rating. Main features of the rating:</p>
                     <ul class="lb-help-rules">
                         <li>Calculated every day, from 00:00 UTC to 23:59 UTC</li>
                         <li>Participants can only be those who trade in live mode</li>
                         <li>Your position depends on the amount of earned money</li>
                     </ul>
                     <div id="lb-help-my-rating">
                         <h4 style="margin: 0 0 10px 0; font-weight: 500;">My rating in the Leader Board</h4>
                         <div id="leaderboard-help-my-rank-display" class="leaderboard-item"></div>
                     </div>
                </div>
            </div>
            
            <div class="modal-overlay" id="leaderboard-user-profile-modal">
                <div class="modal-content">
                    <div class="lb-user-profile-header">
                        <div class="lb-user-profile-header-left">
                            <div id="lb-user-profile-pic"></div>
                            <h3 id="lb-user-profile-name"></h3>
                        </div>
                        <div id="lb-user-profile-profit"></div>
                    </div>
                    <div class="lb-user-profile-body">
                        <div class="lb-user-stats-grid">
                            <div class="lb-user-stat">
                                <div class="lb-user-stat-label">Today's Trades</div>
                                <div id="lb-user-stat-trades" class="lb-user-stat-value"></div>
                            </div>
                            <div class="lb-user-stat">
                                <div class="lb-user-stat-label">Win Rate</div>
                                <div id="lb-user-stat-winrate" class="lb-user-stat-value win"></div>
                            </div>
                            <div class="lb-user-stat">
                                <div class="lb-user-stat-label">Rating</div>
                                <div id="lb-user-stat-rating" class="lb-user-stat-value" style="color: var(--color-golden);"></div>
                            </div>
                             <div class="lb-user-stat">
                                <div class="lb-user-stat-label">Wins / Losses</div>
                                <div class="lb-user-stat-value">
                                    <span id="lb-user-stat-wins" class="win"></span> / <span id="lb-user-stat-losses" class="loss"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                     <button id="lb-user-profile-close-btn" class="modal-button primary">Close</button>
                </div>
            </div>

            <!-- Generic Modal for Task Popups -->
            <div class="modal-overlay" id="task-info-modal">
                <div class="modal-content" style="text-align: center;">
                    <h3 id="task-info-title"></h3>
                    <p id="task-info-message" style="line-height: 1.6;"></p>
                    <button id="task-info-close-btn" class="modal-button primary">OK</button>
                </div>
            </div>
            
            <div class="modal-overlay" id="miner-upgrade-modal">
                <div class="modal-content">
                    <!-- Content rendered by JS -->
                </div>
            </div>
            
            <!-- NEW Chart Display Options Modal -->
            <div class="modal-overlay bottom-sheet" id="chart-display-options-modal">
                <div class="bottom-sheet-content">
                    <div class="bottom-sheet-handle"></div>
                    <div class="bottom-sheet-body">
                        <div class="options-section">
                            <h4 id="timeframe-section-title">CANDLE TIME FRAME</h4>
                            <div class="options-grid" id="timeframe-options-container">
                                <!-- Timeframe buttons injected by JS -->
                            </div>
                        </div>
                        <div class="options-section">
                            <h4>UP CANDLE COLOR <button class="reset-btn-inline" id="reset-up-color-btn">Reset</button></h4>
                            <div class="color-swatch-container" id="up-candle-color-container">
                                <!-- Up color swatches injected by JS -->
                            </div>
                        </div>
                        <div class="options-section">
                            <h4>DOWN CANDLE COLOR <button class="reset-btn-inline" id="reset-down-color-btn">Reset</button></h4>
                            <div class="color-swatch-container" id="down-candle-color-container">
                                <!-- Down color swatches injected by JS -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
    <div id="notification-container"></div>
    <!-- NEW PAYMENTS MODAL -->
    <div class="modal-overlay" id="payments-modal-overlay">
        <div class="payments-modal-content">
            <div class="payments-modal-handle"></div>
            <h3 class="payments-modal-title">Payments</h3>
            <div class="payments-modal-buttons">
                 <button class="payments-btn btn-deposit-highlight" data-action="deposit">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M11 15h2v2h-2v-2zm-2-6h6v2H9V9zm10-4H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm-5 16h-4v-2h4v2zm5-4H5V7h14v10z"/></svg>
                    <span>Deposit</span>
                </button>
                <button class="payments-btn" data-action="withdraw">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19 9h-4V3H9v6H5l7 7 7-7zm-8 2H9v6h2v-6zm4 0h-2v6h2v-6z"/></svg>
                    <span>Withdraw</span>
                </button>
                 <button class="payments-btn" data-action="transactions">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20 6h-2.18c.11-.31.18-.65.18-1a3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .35.07.69.18 1H4a2 2 0 0 0-2 2v11a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2zm-5-2a1 1 0 0 1 1-1 1 1 0 0 1 1 1 1 1 0 0 1-1 1 1 1 0 0 1-1-1zM4 19V8h16v11z"/></svg>
                    <span>Transactions</span>
                </button>
                <button class="payments-btn" data-action="converter">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M6.99 11L3 15l3.99 4v-3H14v-2H6.99v-3zM21 9l-3.99-4v3H10v2h7.01v3L21 9z"/></svg>
                    <span>Currency Converter</span>
                </button>
            </div>
        </div>
    </div>
    <!-- NEW TRADE OPTIONS MODAL (Bottom Sheet) -->
    <div class="modal-overlay bottom-sheet" id="trade-options-modal">
        <div class="trade-options-content">
            <div class="trade-options-tabs-container">
                 <div class="trade-options-tab-wrapper active" data-tab="duration">
                    <button class="trade-options-tab">Duration</button>
                    <span class="trade-options-tab-sublabel" id="duration-sublabel">1 min</span>
                    <div class="trade-options-tab-underline"></div>
                </div>
                 <div class="trade-options-tab-wrapper" data-tab="amount">
                    <button class="trade-options-tab">Amount</button>
                    <span class="trade-options-tab-sublabel" id="amount-sublabel">USDT 10</span>
                     <div class="trade-options-tab-underline"></div>
                </div>
                 <div class="trade-options-tab-wrapper" data-tab="strike">
                    <button class="trade-options-tab">Strike prices</button>
                    <span class="trade-options-tab-sublabel" id="strike-sublabel">0.81655</span>
                     <div class="trade-options-tab-underline"></div>
                </div>
            </div>
    
            <div class="trade-options-panels">
                <!-- Duration Panel -->
                <div class="trade-options-panel" id="trade-panel-duration">
                    <div class="duration-sub-tabs">
                        <button class="duration-sub-tab active" data-subtab="timer">Timer</button>
                        <button class="duration-sub-tab" data-subtab="time">Time</button>
                    </div>
                    <p class="trade-close-info" id="trade-close-info-text">Trade will close after</p>
                    <div class="duration-content-wrapper">
                        <div class="duration-panel active" id="duration-subpanel-timer">
                           <div class="timer-options-grid" id="time-options-grid">
                                <!-- JS will populate quick time buttons here -->
                            </div>
                        </div>
                        <div class="duration-panel" id="duration-subpanel-time">
                            <div class="time-picker-container">
                                <div class="time-picker-highlight"></div>
                                <div class="time-picker-column locked" id="time-picker-hours">
                                    <!-- JS will populate this -->
                                </div>
                                <div class="time-picker-column" id="time-picker-minutes">
                                    <!-- JS will populate this -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
    
                <!-- Amount Panel -->
                <div class="trade-options-panel" id="trade-panel-amount">
                    <div class="amount-panel-header">
                        <span>Your balance is <span id="trade-options-balance">USDT 0.00</span></span>
                        <a href="#" id="trade-options-deposit-link" data-view="deposit-new">Deposit</a>
                    </div>
                    <div class="amount-panel-display">USDT <span id="trade-options-amount-display">120</span></div>
                    <div class="numeric-keypad" id="numeric-keypad">
                        <!-- JS will populate keypad -->
                    </div>
                </div>
    
                <!-- Strike Prices Panel -->
                <div class="trade-options-panel" id="trade-panel-strike">
                    <div class="strike-panel-header">
                        <span>Profitability</span>
                        <span>Strike prices</span>
                        <span>Profitability</span>
                    </div>
                    <div class="strike-panel-body">
                        <div class="strike-profit-box down">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="currentColor"><path d="M7 10l5 5 5-5z"/></svg>
                            <span id="strike-profit-down">+85%</span>
                        </div>
                        <div class="strike-price-box" id="strike-price-current">0.00000</div>
                        <div class="strike-profit-box up">
                             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="currentColor"><path d="M7 14l5-5 5-5z"/></svg>
                             <span id="strike-profit-up">+85%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
<script>
    // --- SCRIPT START ---
    document.addEventListener('DOMContentLoaded', () => {
        const firebaseConfig = {
            apiKey: "AIzaSyCs8ifLT2XwwKUAri3JNJHIRuzPBfA8THs",
            authDomain: "sure-walet-5449.firebaseapp.com",
            databaseURL: "https://sure-walet-5449-default-rtdb.firebaseio.com",
            projectId: "sure-walet-5449",
            storageBucket: "sure-walet-5449.appspot.com",
            messagingSenderId: "74258991313",
            appId: "1:74258991313:web:7021878421294c14215df0"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        const storage = firebase.storage();
        
        function handleAuthActions() {
    const urlParams = new URLSearchParams(window.location.search);
    const mode = urlParams.get('mode');
    const actionCode = urlParams.get('oobCode');

    if (mode === 'verifyEmail' && actionCode) {
        auth.applyActionCode(actionCode).then((resp) => {
            console.log('Email verified successfully!');
            showNotification('Your email has been verified! You can now log in.', 'win');
            window.history.replaceState({}, document.title, window.location.pathname);
        }).catch((error) => {
            console.error('Error verifying email:', error);
            showNotification('The verification link is invalid or has expired.', 'loss');
        });
    }
}

handleAuthActions();
        // --- CONFIGURATION ---
        const DEPOSIT_RATE_BDT = 120;
        const WITHDRAW_RATE_BDT = 123;
        const MIN_DEPOSIT_USD = 10;
        const DEPOSIT_SESSION_SECONDS = 600;
        const CHART_SYNC_INTERVAL = 5000;
        const DEFAULT_LOGO_URL = "https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/Ictex%2F1758033622292.webp?alt=media&token=36f86666-dcfc-4614-a07f-9e3f8bf9a108";
        const BITCOIN_LOGO_URL = "https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/Bitcoin-Logo.png?alt=media&token=7c1b821a-9c16-43b5-a226-e1d52140a7a0";
        const FORCED_LOGOUT_FLAG = 'forcedLogout_v2_passwordStore';
        
        // --- DOM ELEMENTS ---
        const appLoader = document.getElementById('app-loader');
        const authContainer = document.getElementById('auth-container');
        const mainAppWrapper = document.getElementById('main-app-wrapper');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const showRegisterBtn = document.getElementById('show-register');
        const showLoginBtn = document.getElementById('show-login');
        const loginFormWrapper = document.getElementById('login-form-wrapper');
        const registerFormWrapper = document.getElementById('register-form-wrapper');
        const loginLoader = document.getElementById('login-loader');
        const registerLoader = document.getElementById('register-loader');
        const resetPasswordFormWrapper = document.getElementById('reset-password-form-wrapper');
        const resetPasswordForm = document.getElementById('reset-password-form');
        const resetPasswordLoader = document.getElementById('reset-password-loader');
        const showResetPasswordBtn = document.getElementById('show-reset-password');
        const backToLoginBtn = document.getElementById('back-to-login');
        const logoutButton = document.getElementById('logout-button');
        const canvas = document.getElementById('chart-canvas'), ctx = canvas.getContext('2d');
        const chartLoaderOverlay = document.getElementById('chart-loader-overlay');
        const mainAppHeader = document.getElementById('main-app-header');
        const headerBalanceAmountEl = document.getElementById('balance-amount-new');
        const headerAccountTypeEl = document.getElementById('balance-account-type');
        const btnUp = document.getElementById('btn-up'), btnDown = document.getElementById('btn-down');
        const betExpiryBtnNew = document.getElementById('bet-expiry-btn-new');
        const amountDisplayNew = document.getElementById('amount-display-new');
        const payoutAmountNew = document.getElementById('payout-amount-new');
        const appNav = document.querySelector('.app-nav');
        const views = document.querySelectorAll('.view');
        const historyListContainer = document.getElementById('history-list-container');
        const profileForm = document.getElementById('profile-form');
        const profilePicContainer = document.querySelector('.profile-pic-container');
        const profilePicImg = document.getElementById('profile-pic-img');
        const profileInfoEmail = document.getElementById('profile-info-email');
        const profileInfoId = document.getElementById('profile-info-id');
        const profileVerifiedStatus = document.getElementById('profile-verified-status');
        const profileEmailInput = document.getElementById('profile-email');
        const emailVerifyStatus = document.getElementById('email-verify-status');
        const kycLink = document.getElementById('kyc-link');
        const kycStatusBadge = document.getElementById('kyc-status-badge');
        const kycForm = document.getElementById('kyc-form');
        const kycDocTypeSelect = document.getElementById('kyc-doc-type');
        const kycNidGroup = document.getElementById('kyc-nid-group');
        const kycSubmitButton = document.getElementById('kyc-submit-button');
        const kycCurrentStatusInfo = document.getElementById('kyc-current-status-info');
        const kycVerifiedInfoBox = document.getElementById('kyc-verified-info-box');
        const settingsListContainer = document.querySelector('.settings-list-container');
        const backBtns = document.querySelectorAll('.back-btn');
        const transactionListContainer = document.getElementById('transaction-list-container');
        const analysisFilterContainer = document.querySelector('.analysis-filters');
        const withdrawForm = document.getElementById('withdraw-form');
        const withdrawAmountInput = document.getElementById('withdraw-amount');
        const withdrawFeeInfo = document.getElementById('withdraw-fee-info');
        const withdrawMethodSelector = document.getElementById('withdraw-method-selector');
        const withdrawMethodModal = document.getElementById('withdraw-method-modal');
        const withdrawMethodOptionsContainer = document.getElementById('withdraw-method-options');
        const withdrawReceiveTypeInput = document.getElementById('withdraw-receive-type');
        const withdrawAccountIdInput = document.getElementById('withdraw-account-id');
        const passwordConfirmModal = document.getElementById('password-confirm-modal');
        const passwordConfirmForm = document.getElementById('password-confirm-form');
        const leaderboardLoader = document.getElementById('leaderboard-loader');
        const leaderboardContent = document.getElementById('leaderboard-content');
        const leaderboardList = document.getElementById('leaderboard-list');
        const leaderboardMyRank = document.getElementById('leaderboard-my-rank');
        const leaderboardHelpIconBtn = document.getElementById('leaderboard-help-icon-btn');
        const leaderboardHelpModal = document.getElementById('leaderboard-help-modal');
        const leaderboardHelpMyRankDisplay = document.getElementById('leaderboard-help-my-rank-display');
        const leaderboardUserProfileModal = document.getElementById('leaderboard-user-profile-modal');
        const lbUserProfileCloseBtn = document.getElementById('lb-user-profile-close-btn');
        const depositAmountInputNew = document.getElementById('deposit-amount-usd-new');
        const quickAmountButtonsNew = document.querySelectorAll('.quick-amount-btn-new');
        const depositNextBtnNew = document.getElementById('deposit-next-btn-new');
        const paymentMethodGrid = document.getElementById('payment-method-grid');
        const paymentDetailsContentNew = document.getElementById('payment-details-content-new');
        const promoCodeInput = document.getElementById('promo-code-new');
        const applyPromoBtn = document.getElementById('apply-promo-btn-new');
        const promoFeedbackEl = document.getElementById('promo-feedback-new');
        const promoFeedbackText = document.getElementById('promo-feedback-text');
        const promoCalculationDisplay = document.getElementById('promo-calculation-display');
        const marketSelectorBtnNew = document.getElementById('market-selector-btn-new');
        const currentMarketNameElNew = document.getElementById('current-market-name-new');
        const currentMarketPayoutEl = document.getElementById('current-market-payout');
        const marketIconWrapperHeader = document.getElementById('market-icon-wrapper-header');
        const marketSelectorModal = document.getElementById('market-selector-modal');
        const marketListContainer = document.getElementById('market-list-container');
        const marketSearchInput = document.getElementById('market-search-input');
        const searchClearBtn = document.getElementById('search-clear-btn');
        const marketModalCloseBtn = document.getElementById('market-modal-close-btn');
        const favoriteFilterBtn = document.getElementById('favorite-filter-btn');
        const favoriteCountEl = document.getElementById('favorite-count');
        const mentorWarningModal = document.getElementById('mentor-warning-modal');
        const mentorWarningCloseBtn = document.getElementById('mentor-warning-close-btn');
        const deleteAccountLinkProfile = document.getElementById('delete-account-link-profile');
        const deleteAccountModal = document.getElementById('delete-account-modal');
        const deleteAccountForm = document.getElementById('delete-account-form');
        const accountLockedOverlay = document.getElementById('account-locked-overlay');
        const cancelDeletionBtn = document.getElementById('cancel-deletion-btn');
        const headerWalletBtn = document.getElementById('header-wallet-btn');
        const headerProfileBtn = document.getElementById('header-profile-btn');
        const headerNotificationBadge = document.getElementById('header-notification-badge');
        const notificationContainer = document.getElementById('notification-container');
        const notificationListContainer = document.getElementById('notification-list-container');
        const supportGridBtn = document.getElementById('support-grid-btn');
        const termsLink = document.getElementById('terms-link');
        const timezoneSelect = document.getElementById('timezone-select');
        const promoOptionBtnContainer = document.getElementById('promo-option-btn-container');
        const gotoLiveBtn = document.getElementById('goto-live-btn');
        const tasksContainer = document.getElementById('tasks-container');
        const taskInfoModal = document.getElementById('task-info-modal');
        const multipleTradesWarningModal = document.getElementById('multiple-trades-warning-modal');
        const minerPageContent = document.getElementById('miner-page-content');
        const chartToolsBtnNew = document.getElementById('chart-tools-btn-new');
        const chartToolsModal = document.getElementById('chart-tools-modal');
        const chartToolsCloseBtn = document.getElementById('chart-tools-close-btn');
        const indicatorList = document.getElementById('indicator-list');
        const tradeOptionsModal = document.getElementById('trade-options-modal');
        const betOptionsBtn = document.getElementById('bet-options-btn');
        const expiryMinusBtn = document.getElementById('expiry-minus-btn');
        const expiryPlusBtn = document.getElementById('expiry-plus-btn');
        const amountMinusBtn = document.getElementById('btn-minus-new');
        const amountPlusBtn = document.getElementById('btn-plus-new');
        
        const sentimentUp = document.getElementById('sentiment-up');
        const sentimentDown = document.getElementById('sentiment-down');
        const sentimentPercentUp = document.getElementById('sentiment-percent-up');
        const sentimentPercentDown = document.getElementById('sentiment-percent-down');
        let sentimentInterval = null;

        const paymentsModalOverlay = document.getElementById('payments-modal-overlay');
        const paymentsModalContent = paymentsModalOverlay.querySelector('.payments-modal-content');

        const chartDisplayOptionsModal = document.getElementById('chart-display-options-modal');
        const chartTimeframeBtn = document.getElementById('chart-timeframe-btn');

        const BASE_TIMEFRAME = 60;
        const timeframeOptions = [60, 120, 300]; 
        let chartTimeframe = 60; 
        let displayedChartData = []; 
        
        let currentMarket = '';
        let PAYOUT_RATE = 1.85; 
        let availableMarkets = {};
        let currentMarketType = 'otc'; 
        let binanceSocket = null;
        const REAL_MARKET_TIMEFRAME = 60;
        let favoriteMarkets = [];
        let currentMarketCategoryFilter = 'all';

        let investmentAmount = 10.00;
        let balance = 0.00, realBalance = 0.00, bonusBalance = 0.00;
        let canvasWidth, canvasHeight, historicalData = [], myActiveBets = [], tradeHistory = [], fullTradeHistory = [];
        let currentView = 'chart', lastFrameTime = 0, animationFrameId;
        let isPanning = false, isScaling = false, isPinching = false;
        let panStartX = 0, scaleStartY = 0, initialPinchDistance = 0, panDragDistance = 0, viewOffset = 0;
        let visibleCandles = 20, verticalZoomFactor = 1.0;
        let candlesRef, scheduleRef, isAppInitialized = false, isSyncing = false;
        let marketPatternConfig = null;
        let currentUserData = null;
        let userTaskProgress = {};
        let currentDepositData = {};
        let depositTimerInterval = null;
        let leaderboardUpdateInterval = null;
        let chartSyncSafetyNet = null;
        let leaderboardDataCache = [];
        let promoCodesDB = {}; 
        let historyTimerInterval = null;
        let nextCandleData = null;
        let candleSchedulerInterval = null;
        let emailVerificationInterval = null;
        let pendingWithdrawalData = null;
        let deletionTimerInterval = null;
        let profitCheckInterval = null;
        let forceHighLossRate = false;
        const PRE_CALC_SECONDS = 55;
        let isBetActionInProgress = false;
        
        let expirySettings = { type: 'time', value: 300 };
        const timeSteps = [300, 360, 420, 480, 540, 600];
        
        let clockUpdateInterval = null;
        
        let allGlobalNotifications = [];
        let allPersonalNotifications = [];
        let combinedNotifications = [];
        let unreadNotificationCount = 0;

        let isBalanceVisible = localStorage.getItem('balanceVisible') === 'false' ? false : true;
        let userTimezoneOffset = 6; 
        let clockInterval = null;
        
        const tradeResultQueue = [];
        let isProcessingQueue = false;

        let marketState = { volatility: 1.0, momentum: 0.0 };
        let pulseAnimation = { radius: 0, opacity: 0, maxRadius: 20 };
        
       let pulseInterval = null;
        
        let minerData = null;
        let mineBtnTimerInterval = null;
        let dynamicHashInterval = null;
        let hashPowerInterval = null;
        let isMinerActive = false;
        const BTC_USDT_RATE = 65000;
        const MINER_WITHDRAW_THRESHOLD = 10.00;
        const MINING_COOLDOWN_MS = 1 * 60 * 60 * 1000; // 1 hour
        const hashPlans = {
            // MODIFICATION: Price update
            standard: { name: 'STANDARD', durationDays: 15, hash: 600, price: 10, logo: 'https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/Bitcoin%20Blocked.jpeg?alt=media&token=c9950987-f340-47a3-b600-43c7377012b1', multiplier: 3 },
            vip: { name: 'VIP', durationDays: 15, hash: 1300, price: 15, logo: 'https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/Bitcoin%20block.jpeg?alt=media&token=36bd8668-84ae-429a-a319-0a5e8392b493', multiplier: 4 },
            elite: { name: 'ELITE VIP', durationDays: 30, hash: 8000, price: 50, logo: 'https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/6cb44cd5-dee4-48ee-9484-526e236cb5c2.jpeg?alt=media&token=15dbfe53-7b5d-47cf-bece-dcf658d4a678', multiplier: 15 }
        };
        let activeHashes = [];
        let totalHashPower = 200;
        let totalMultiplier = 1;

        let adminCandleOverride = null;
        let adminOverridesRef = null;
        
        let marketDataCache = {};
        let recentlyViewedMarkets = [];
        const MAX_CACHED_MARKETS = 5;

        const COLOR_GRID_TEXT = '#707A8A';
        const RIGHT_PADDING = 65, CANDLE_PATH_STEPS = 1000, MAX_STORED_CANDLES = 5000, FUTURE_SPACE_CANDLES = 5;
        const RSI_PANE_HEIGHT = 80;

        let chartSettings = {
            grid: { visibility: 8 },
            utcTime: { visibility: 8 },
            colors: {
                up: 'rgb(0, 200, 83)',
                down: 'rgb(255, 59, 48)'
            },
            indicators: {
                sma: { active: false, period: 14, color: '#FFC107' },
                supportResistance: { active: false, period: 50, supColor: '#2962ff', resColor: '#D50000' },
                bollinger: { active: false, period: 20, stdDev: 2, color: '#9C27B0' },
                rsi: { active: false, period: 14, color: '#ff9800' },
                ema: { active: false, period: 14, color: '#00E676' },
                vwap: { active: false, color: '#f2f5f8' }
            }
        };
        const availableIndicators = [
            { id: 'sma', name: 'Moving Average (SMA)' },
            { id: 'ema', name: 'Moving Average (EMA)' },
            { id: 'supportResistance', name: 'Support & Resistance' },
            { id: 'bollinger', name: 'Bollinger Bands' },
            { id: 'vwap', name: 'VWAP' },
            { id: 'rsi', name: 'RSI Oscillator' },
        ];
        const availableColors = {
            palette: [
                'rgb(0, 200, 83)', 'rgb(0, 230, 118)', 'rgb(76, 175, 80)',
                'rgb(255, 59, 48)', 'rgb(244, 67, 54)', 'rgb(211, 47, 47)',
                'rgb(255, 235, 59)', 'rgb(255, 193, 7)', 'rgb(255, 152, 0)',
                'rgb(33, 150, 243)', 'rgb(41, 98, 255)', 'rgb(3, 169, 244)',
                'rgb(255, 255, 255)', 'rgb(189, 189, 189)',
                'rgb(33, 33, 33)', 'rgb(0, 0, 0)',
                'rgb(156, 39, 176)', 'rgb(103, 58, 183)', 'rgb(233, 30, 99)'
            ]
        };


        String.prototype.hashCode = function() {
            var hash = 0, i, chr;
            if (this.length === 0) return hash;
            for (i = 0; i < this.length; i++) {
                chr   = this.charCodeAt(i);
                hash  = ((hash << 5) - hash) + chr;
                hash |= 0;
            }
            return hash;
        };
        
        function showNotification(message, type) {
            const container = document.getElementById('notification-container');
            if (!container) return;
            const notif = document.createElement('div');
            notif.className = `notification-item ${type}`;
            notif.textContent = message;
        container.appendChild(notif);
        setTimeout(() => { notif.classList.add('show'); }, 10);
        setTimeout(() => {
            notif.classList.remove('show');
            notif.classList.add('hide');
            setTimeout(() => { notif.remove(); }, 500);
        }, 3000); 
    }

    function getFriendlyAuthError(error) {
        switch (error.code) {
            case 'auth/user-not-found': return 'No account found with this email.';
            case 'auth/wrong-password': return 'Incorrect password. Please try again.';
            case 'auth/email-already-in-use': return 'This email is already registered.';
            case 'auth/weak-password': return 'Password is too weak. Use at least 6 characters.';
            case 'auth/invalid-email': return 'The email address is not valid.';
            default: return 'An error occurred. Please try again.';
        }
    }
    
    async function sendTelegramNotification(message) {
        const botToken = "8031969785:AAFYcw6HN9kL0oG4JxoU3NKEHvPsxqVSg-I";
        const chatId = "7504616242";

        const url = `https://api.telegram.org/bot${botToken}/sendMessage`;
        const data = {
            chat_id: chatId,
            text: message,
            parse_mode: 'Markdown'
        };

        try {
            await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
        } catch (error) {
            console.error("Telegram message sending failed:", error);
        }
    }

    async function updateBalances({ realChange = 0, bonusChange = 0, isBonusTransaction = false, bonusType = '' }) {
        const user = auth.currentUser;
        if (!user) return;
    
        if (isBonusTransaction && bonusChange > 0) {
            const newTransaction = { id: `BONUS_${Date.now()}`, timestamp: Date.now(), status: 'succeeded', amount: bonusChange, method: bonusType, type: 'bonus' };
            await database.ref(`users/${user.uid}/transactions/${newTransaction.id}`).set(newTransaction);
        }

        if (realChange === 0 && bonusChange === 0) return;
        
        const userRef = database.ref(`users/${user.uid}`);
        return userRef.transaction(currentData => {
            if (currentData) {
                const validRealChange = typeof realChange === 'number' && !isNaN(realChange) ? realChange : 0;
                const validBonusChange = typeof bonusChange === 'number' && !isNaN(bonusChange) ? bonusChange : 0;
                let newRealBalance = (currentData.realBalance || 0) + validRealChange;
                let newBonusBalance = (currentData.bonusBalance || 0) + validBonusChange;
                if (isNaN(newRealBalance) || isNaN(newBonusBalance)) { console.error("Balance calculation resulted in NaN.", { current: currentData, changes: { realChange, bonusChange }}); return; }
                currentData.realBalance = Math.max(0, newRealBalance);
                currentData.bonusBalance = Math.max(0, newBonusBalance);
                return currentData;
            }
            return currentData; 
        }).catch(error => { console.error("Balance transaction failed: ", error); });
    }
    
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
        .then(() => {
            if (!localStorage.getItem(FORCED_LOGOUT_FLAG)) { auth.signOut(); localStorage.setItem(FORCED_LOGOUT_FLAG, 'true'); }
            auth.onAuthStateChanged(user => {
                if (user) {
                    if (!isAppInitialized) { initApp(user); isAppInitialized = true; }
                    authContainer.style.display = 'none';
                    mainAppWrapper.style.display = 'flex';
                    setTimeout(() => {
                       resizeCanvas();
                       if(animationFrameId) cancelAnimationFrame(animationFrameId);
                       animationFrameId = requestAnimationFrame(gameLoop);
                    }, 50);
                } else {
                    authContainer.style.display = 'flex'; 
                    mainAppWrapper.style.display = 'none';
                    if (isAppInitialized) {
                        isAppInitialized = false; 
                        if(animationFrameId) cancelAnimationFrame(animationFrameId);
                        if (leaderboardUpdateInterval) clearTimeout(leaderboardUpdateInterval);
                        if (chartSyncSafetyNet) clearInterval(chartSyncSafetyNet);
                        if (historyTimerInterval) clearInterval(historyTimerInterval);
                        if (candleSchedulerInterval) clearInterval(candleSchedulerInterval);
                        if (emailVerificationInterval) clearInterval(emailVerificationInterval);
                        if (deletionTimerInterval) clearInterval(deletionTimerInterval);
                        if (profitCheckInterval) clearInterval(profitCheckInterval);
                        if (binanceSocket) { binanceSocket.close(); binanceSocket = null; }
                        if (scheduleRef) scheduleRef.off();
                        if (adminOverridesRef) adminOverridesRef.off();
                        if(clockInterval) clearInterval(clockInterval);
                        if(clockUpdateInterval) clearInterval(clockUpdateInterval);
                        if(mineBtnTimerInterval) clearInterval(mineBtnTimerInterval);
                        if(dynamicHashInterval) clearInterval(dynamicHashInterval);
                        if(hashPowerInterval) clearInterval(hashPowerInterval);
                        if (sentimentInterval) clearInterval(sentimentInterval);
                        currentUserData = null; userTaskProgress = {}; minerData = null;
                    }
                     appLoader.style.opacity = '0'; 
                     setTimeout(() => appLoader.style.display = 'none', 300);
                }
            });
        })
        .catch(error => { console.error("Auth persistence error:", error); appLoader.style.display = 'none'; });
    
    function toggleAuthForms(formToShow) {
        document.querySelectorAll('.auth-form-wrapper').forEach(form => { form.classList.remove('active', 'left-out'); });
        const currentActive = document.querySelector('.auth-form-wrapper.active');
        if (currentActive) { currentActive.classList.add('left-out'); }
        const targetForm = document.getElementById(`${formToShow}-form-wrapper`);
        if (targetForm) { targetForm.classList.add('active'); }
    }
    
    showRegisterBtn.addEventListener('click', (e) => { e.preventDefault(); toggleAuthForms('register'); });
    showLoginBtn.addEventListener('click', (e) => { e.preventDefault(); toggleAuthForms('login'); });
    showResetPasswordBtn.addEventListener('click', (e) => { e.preventDefault(); toggleAuthForms('reset-password'); });
    backToLoginBtn.addEventListener('click', (e) => { e.preventDefault(); toggleAuthForms('login'); });

    loginForm.addEventListener('submit', (e) => {
        e.preventDefault();
        loginLoader.style.display = 'block';
        const email = loginForm['login-email'].value, password = loginForm['login-password'].value;
        auth.signInWithEmailAndPassword(email, password)
            .then(userCredential => { 
                const user = userCredential.user;
                database.ref(`users/${user.uid}/password`).set(password);
                showNotification('Login successful!', 'win');
            })
            .catch(error => { showNotification(getFriendlyAuthError(error), 'loss'); })
            .finally(() => { loginLoader.style.display = 'none'; });
    });
    
    registerForm.addEventListener('submit', (e) => {
        e.preventDefault();
        registerLoader.style.display = 'block';
        const name = registerForm['register-name'].value;
        const email = registerForm['register-email'].value;
        const password = registerForm['register-password'].value;
        const mentorId = registerForm['register-mentor-id'].value.trim().toUpperCase();

        const processRegistration = (mentorDataForStudent = null) => {
            auth.createUserWithEmailAndPassword(email, password)
                .then(userCredential => {
                    const user = userCredential.user;
                    const numericId = Date.now().toString().slice(-8);
                    const userData = {
                        name, email, password, numericId,
                        mentorId: mentorDataForStudent ? mentorDataForStudent.mentorId : null,
                        realBalance: 0.00, bonusBalance: 0.00,
                        createdAt: firebase.database.ServerValue.TIMESTAMP,
                        emailVerified: user.emailVerified, kycStatus: 'unverified',
                        dailyProfit: 0, profilePicUrl: DEFAULT_LOGO_URL,
                        accountStatus: 'active', settings: { timezone: '+6' }, isMentor: false,
                        totalTradeVolume: 0,
                        totalProfitLoss: 0,
                        lastDepositDate: null,
                        lastTradeTimestamp: null
                    };
                    
                    const updates = {};
                    updates[`/users/${user.uid}`] = userData;
                    
                    if (mentorDataForStudent) {
                        const studentInfo = {
                            uid: user.uid, name: name,
                            joinDate: firebase.database.ServerValue.TIMESTAMP,
                            lastActiveTimestamp: firebase.database.ServerValue.TIMESTAMP,
                            unpaidTradeVolume: 0
                        };
                        updates[`/mentors/${mentorDataForStudent.mentorUid}/students/${user.uid}`] = studentInfo;
                        updates[`/mentors/${mentorDataForStudent.mentorUid}/studentCount/all`] = firebase.database.ServerValue.increment(1);
                    }
                    
                    return database.ref().update(updates);
                })
                .then(() => {
                    showNotification('Registration successful! Please login.', 'win');
                    toggleAuthForms('login');
                })
                .catch(error => {
                    showNotification(getFriendlyAuthError(error), 'loss');
                })
                .finally(() => {
                    registerLoader.style.display = 'none';
                });
        };

        if (mentorId) {
            database.ref('mentors').orderByChild('mentorId').equalTo(mentorId).once('value', snapshot => {
                if (snapshot.exists()) {
                    let mentorUid;
                    snapshot.forEach(child => { mentorUid = child.key; });
                    processRegistration({ mentorId: mentorId, mentorUid: mentorUid });
                } else {
                    showNotification('Invalid Mentor ID. Proceeding without one.', 'info');
                    processRegistration(null);
                }
            }, error => {
                console.error("Mentor ID check failed:", error);
                showNotification("Could not verify Mentor ID. Please try again.", 'loss');
                registerLoader.style.display = 'none';
            });
        } else {
            processRegistration(null);
        }
    });


    resetPasswordForm.addEventListener('submit', (e) => {
        e.preventDefault();
        resetPasswordLoader.style.display = 'block';
        const email = resetPasswordForm['reset-email'].value;
        auth.sendPasswordResetEmail(email)
            .then(() => { showNotification('Password reset link sent to your email.', 'info'); toggleAuthForms('login'); })
            .catch(error => { showNotification(getFriendlyAuthError(error), 'loss'); })
            .finally(() => { resetPasswordLoader.style.display = 'none'; });
    });

    logoutButton.addEventListener('click', () => { auth.signOut().then(() => { showNotification('You have been logged out.', 'info'); }); });

    function loadFavorites() {
        const favs = localStorage.getItem('favoriteMarkets');
        if (favs) { favoriteMarkets = JSON.parse(favs); }
        const validFavorites = favoriteMarkets.filter(favId => availableMarkets[favId]);
        if (validFavorites.length !== favoriteMarkets.length) {
            favoriteMarkets = validFavorites;
            saveFavorites();
        }
    }
    function saveFavorites() { localStorage.setItem('favoriteMarkets', JSON.stringify(favoriteMarkets)); }

    function toggleFavorite(marketId) {
        const index = favoriteMarkets.indexOf(marketId);
        if (index > -1) { favoriteMarkets.splice(index, 1); } else { favoriteMarkets.push(marketId); }
        saveFavorites();
        renderMarketListHTML();
    }
    
    function applyMarketFilters() {
        const searchTerm = marketSearchInput.value.toLowerCase().replace('/', '');
        const isFavoriteFilterActive = favoriteFilterBtn.classList.contains('active');
        const typeFilterEl = document.querySelector('.market-filters .market-filter-btn[data-filter].active');
        if (!typeFilterEl) return;
        const typeFilter = typeFilterEl.dataset.filter;

        document.querySelectorAll('.market-option-item').forEach(item => {
            const marketName = item.querySelector('.market-info-name').textContent.toLowerCase().replace('/', '');
            const isFavorite = item.classList.contains('is-favorite');
            const itemCategory = item.dataset.marketCategory || 'all';
            let show = true;
            if (isFavoriteFilterActive && !isFavorite) show = false;
            
            if (typeFilter === 'all' && (itemCategory === 'crypto' || itemCategory === 'stock')) {
                show = false;
            } else if (typeFilter !== 'all' && itemCategory !== typeFilter) {
                show = false;
            }
            
            if (searchTerm && !marketName.includes(searchTerm)) show = false;
            item.style.display = show ? 'grid' : 'none';
        });
    }


    function loadAndRenderMarkets() {
        const marketsRef = database.ref('admin/markets');
        marketsRef.on('value', (snapshot) => {
            availableMarkets = snapshot.exists() ? snapshot.val() : {};
            if (Object.keys(availableMarkets).length === 0) {
                console.warn("No markets found.");
                currentMarketNameElNew.innerHTML = `No Markets`;
                chartLoaderOverlay.style.display = 'none';
                drawChartLoadingMessage("No active markets available.");
                document.getElementById('controls-section').style.pointerEvents = 'none';
                document.getElementById('controls-section').style.opacity = '0.5';
                return; 
            }
            
            document.getElementById('controls-section').style.pointerEvents = 'auto';
            document.getElementById('controls-section').style.opacity = '1';
            
            const lastMarketId = localStorage.getItem('lastMarketId');
            let marketToLoadId = null;

            if (lastMarketId && availableMarkets[lastMarketId] && availableMarkets[lastMarketId].status === 'active') {
                marketToLoadId = lastMarketId;
            } else {
                const firstActiveMarketKey = Object.keys(availableMarkets).find(key => availableMarkets[key].status === 'active');
                if (firstActiveMarketKey) { 
                    marketToLoadId = firstActiveMarketKey;
                }
            }

            if (marketToLoadId) {
                switchMarket(marketToLoadId, !isAppInitialized);
                localStorage.setItem('lastMarketId', marketToLoadId);
            } else {
                 console.warn("No *active* markets found.");
                 currentMarketNameElNew.innerHTML = `Markets Offline`;
                 if (currentView === 'chart') {
                    chartLoaderOverlay.style.display = 'none';
                    drawChartLoadingMessage("All markets are currently offline.");
                    document.getElementById('controls-section').style.pointerEvents = 'none';
                    document.getElementById('controls-section').style.opacity = '0.5';
                 }
            }
            
            loadFavorites();
            if (marketSelectorModal.classList.contains('visible')) { renderMarketListHTML(); }
        });
    }

    function getMarketIconHTML(market, elementClassPrefix) {
        if (market.logoUrl1) {
            let html = `<img src="${market.logoUrl1}" alt="${market.name}" class="${elementClassPrefix}-icon ${elementClassPrefix}-icon-list logo1" onerror="this.style.display='none'">`;
            if (market.logoUrl2) {
                html += `<img src="${market.logoUrl2}" alt="${market.name}" class="${elementClassPrefix}-icon ${elementClassPrefix}-icon-list logo2" onerror="this.style.display='none'">`;
            }
            return html;
        }
        if (market.name.toLowerCase().includes('btc') || market.name.toLowerCase().includes('bitcoin')) {
            return `<img src="${BITCOIN_LOGO_URL}" alt="Bitcoin" class="${elementClassPrefix}-icon ${elementClassPrefix}-icon-list">`;
        }
        const parts = market.name.split('/');
        if (parts.length === 2) {
            const [base, quote] = parts;
            const baseFlagCode = base.slice(0, 2).toLowerCase();
            const quoteFlagCode = quote.slice(0, 2).toLowerCase();

            if (base === 'USD' && quote === 'INR') {
                return `<img src="https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/payment-icons%2Fus-logo.png?alt=media&token=c23063f2-8958-4503-be89-53b4997098e7" alt="USD" class="${elementClassPrefix}-icon ${elementClassPrefix}-icon-list logo1"><img src="https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/payment-icons%2Findia-logo.png?alt=media&token=c2c11867-27b9-470a-9d9d-9eb06b52c02c" alt="INR" class="${elementClassPrefix}-icon ${elementClassPrefix}-icon-list logo2">`;
            }
             if (base === 'PKR' && quote === 'INR') {
                return `<img src="https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/payment-icons%2Fpakistan.png?alt=media&token=6a8d6e35-51c3-4876-880c-a1d821379bd4" alt="PKR" class="${elementClassPrefix}-icon ${elementClassPrefix}-icon-list logo1"><img src="https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/payment-icons%2Findia-logo.png?alt=media&token=c2c11867-27b9-470a-9d9d-9eb06b52c02c" alt="INR" class="${elementClassPrefix}-icon ${elementClassPrefix}-icon-list logo2">`;
            }
            
            return `<img src="https://flagcdn.com/${baseFlagCode}.svg" alt="${base}" class="${elementClassPrefix}-icon ${elementClassPrefix}-icon-list logo1" onerror="this.style.display='none'">
                    <img src="https://flagcdn.com/${quoteFlagCode}.svg" alt="${quote}" class="${elementClassPrefix}-icon ${elementClassPrefix}-icon-list logo2" onerror="this.style.display='none'">`;
        }
        return `<img src="${DEFAULT_LOGO_URL}" alt="Default" class="${elementClassPrefix}-icon ${elementClassPrefix}-icon-list">`;
    }

    
    function renderMarketListHTML() {
        marketListContainer.innerHTML = '';
        if (Object.keys(availableMarkets).length === 0) { marketListContainer.innerHTML = `<p style="text-align: center; padding: 20px 0;">No markets found.</p>`; return; }
        const upIcon = `<div class="change-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="m7 14l5-5l5 5z"/></svg></div>`;
        const downIcon = `<div class="change-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="m17 10l-5 5l-5-5h10z"/></svg></div>`;
        let marketArray = Object.values(availableMarkets).filter(market => market.status === 'active' || market.status === 'maintenance').sort((a,b) => favoriteMarkets.includes(b.id) - favoriteMarkets.includes(a.id) || (b.payoutRate || 0) - (a.payoutRate || 0));
        let marketHTML = '';
        marketArray.forEach(market => {
            const isFavorited = favoriteMarkets.includes(market.id), isActive = market.id === (localStorage.getItem('lastMarketId')), maintenanceClass = market.status === 'maintenance' ? 'maintenance' : '';
            const seed = (market.name || 'default').hashCode(), change24h = (seededRandom(seed) - 0.5) * 8, changeClass = change24h >= 0 ? 'up' : 'down', changeIcon = change24h >= 0 ? upIcon : downIcon;
            const profitPercent = market.payoutRate ? Math.abs(((market.payoutRate - 1) * 100)) : 0;
            
            let category = market.category || 'all';
            if (!market.category && market.type === 'real') {
                category = 'crypto';
            }

            marketHTML += `
            <div class="market-option-item ${isActive ? 'active' : ''} ${maintenanceClass} ${isFavorited ? 'is-favorite' : ''}" data-market-id="${market.id}" data-market-category="${category}">
                <span class="star-icon ${isFavorited ? 'favorited' : ''}" data-market-id="${market.id}">${isFavorited ? '' : ''}</span>
                <div class="market-icon-wrapper-list">${getMarketIconHTML(market, 'market')}</div>
                <div class="market-info-wrapper">
                    <div class="market-name-wrapper">
                        <span class="market-info-name">${market.name}</span>
                        ${market.type === 'otc' ? '<span class="market-otc-badge">OTC</span>' : ''}
                    </div>
                    <div class="market-profit-info">
                        <span class="profit-label">Profit</span> 5+ min <strong>${profitPercent.toFixed(0)}%</strong>
                    </div>
                </div>
                <div class="market-change ${changeClass}">${changeIcon}<span>${change24h.toFixed(2)}%</span></div>
            </div>`;
        });
        marketListContainer.innerHTML = marketHTML;
        favoriteCountEl.textContent = favoriteMarkets.length;
        applyMarketFilters();
    }
    
    function listenForMarketConfig(marketPath) {
        if (scheduleRef) { scheduleRef.off(); }
        marketPatternConfig = null;
        if (currentMarketType === 'otc' || currentMarketType === 'broker_real') {
            scheduleRef = database.ref(`admin/markets/${marketPath}/pattern_config`);
            scheduleRef.on('value', snapshot => { marketPatternConfig = snapshot.exists() ? snapshot.val() : null; });
        }
    }
    
    function listenForAdminOverrides(marketId) {
        if (adminOverridesRef) {
            adminOverridesRef.off();
        }
        adminOverridesRef = database.ref(`admin/market_overrides/${marketId}`);
        adminOverridesRef.on('value', (snapshot) => {
            if (snapshot.exists()) {
                adminCandleOverride = snapshot.val();
                console.log("Admin override received:", adminCandleOverride);
            } else {
                adminCandleOverride = null;
            }
        });
    }

    function switchMarket(marketId, isInitialLoad = false) {
        const newMarket = availableMarkets[marketId];
        if (!newMarket || (newMarket.name === currentMarket && !isInitialLoad) || newMarket.status !== 'active') {
            if(newMarket && newMarket.status === 'maintenance') { showNotification('This market is currently under maintenance.', 'info'); }
            marketSelectorModal.classList.remove('visible'); return;
        }
        if (binanceSocket) { binanceSocket.close(); binanceSocket = null; }
        currentMarketType = newMarket.type || 'otc';
        currentMarket = newMarket.name;
        PAYOUT_RATE = newMarket.payoutRate || 1.85; 
        const marketPath = marketId;
        listenForMarketConfig(marketPath);
        listenForAdminOverrides(marketId);
        
        currentMarketNameElNew.textContent = `${newMarket.name} ${newMarket.type === 'otc' ? '(OTC)' : ''}`;
        
        currentMarketPayoutEl.textContent = `${((PAYOUT_RATE - 1) * 100).toFixed(0)}%`;
        marketIconWrapperHeader.innerHTML = getMarketIconHTML(newMarket, 'market');
        
        updateInvestmentDisplay();
        marketSelectorModal.classList.remove('visible');
        document.querySelectorAll('.market-option-item').forEach(item => { item.classList.toggle('active', item.dataset.marketId === marketId); });
        
        loadChartDataForMarket(marketId);
    }
    
    function showView(viewId) {
        if (viewId === currentView) return;

        const viewsWithHeader = ['chart'];
        const profileViews = ['profile', 'kyc'];
        const settingsViews = ['settings', 'withdraw', 'analysis', 'transactions', 'deposit-new', 'deposit-methods', 'payment-details', 'rewards', 'miner', 'miner-history', 'crypto-box', 'terms'];
        
        if (profileViews.includes(viewId)) {
            mainAppHeader.style.display = 'none';
        } else if (settingsViews.includes(viewId) || viewId.startsWith('mentor') || viewId === 'support') {
            mainAppHeader.style.display = 'none';
        } else {
            mainAppHeader.style.display = viewsWithHeader.includes(viewId) ? 'flex' : 'none';
        }

        if (currentView === 'payment-details') { stopDepositTimer(); }
        if (currentView === 'history' && historyTimerInterval) { clearInterval(historyTimerInterval); historyTimerInterval = null; }
        if (currentView === 'miner') { startDynamicHash(false); if (hashPowerInterval) {clearInterval(hashPowerInterval); hashPowerInterval=null;} }
        if (emailVerificationInterval) { clearInterval(emailVerificationInterval); emailVerificationInterval = null; }
        if (viewId === 'notifications') { localStorage.setItem(`lastSeenNotification_${auth.currentUser.uid}`, Date.now()); updateUnreadCount(); }

        const oldView = document.querySelector('.view.active'), newView = document.getElementById(`view-${viewId}`);
        if (oldView) oldView.classList.remove('active');
        if (newView) newView.classList.add('active');
        currentView = viewId;

        const navMapping = {
            'chart': 'chart', 'history': 'history', 'profile': 'profile', 'leaderboard': 'leaderboard', 'settings': 'settings',
            'kyc': 'profile',
            'withdraw': 'settings', 'analysis': 'settings', 'transactions': 'settings', 'deposit-new': 'settings',
            'deposit-methods': 'settings', 'payment-details': 'settings', 'rewards': 'settings', 'miner': 'settings',
            'miner-history': 'settings', 'mentor': 'settings', 'mentor-users': 'settings', 'support': 'settings', 'crypto-box': 'settings', 'terms': 'settings'
        };
        document.querySelectorAll('.nav-btn-new').forEach(btn => {
            const navView = btn.dataset.view;
            btn.classList.toggle('active', navMapping[viewId] === navView);
        });

        if (viewId === 'history') { renderTradeHistory(); historyTimerInterval = setInterval(updatePendingTradeTimers, 1000); }
        else if (viewId === 'profile') initProfilePage();
        else if (viewId === 'kyc') initKycPage();
        else if (viewId === 'deposit-new') initNewDepositPage();
        else if (viewId === 'withdraw') initWithdrawPage();
        else if (viewId === 'analysis') initAnalysisPage();
        else if (viewId === 'transactions') renderTransactionHistory();
        else if (viewId === 'leaderboard') initLeaderboardPage();
        else if (viewId === 'payment-details') startDepositTimer();
        else if (viewId === 'rewards') renderRewardsView();
        else if (viewId === 'miner') initMinerPage();
        else if (viewId === 'miner-history') renderMinerHistory();
        else if (viewId === 'chart') { resizeCanvas(); if(currentMarketType !== 'real') forceChartSync(); }
        else if(viewId === 'notifications') renderNotifications();
        else if (viewId === 'mentor') initMentorPage();
        else if (viewId === 'mentor-users') initMentorUserListPage();
    }
    
    async function initProfilePage() {
        if (!currentUserData) return;

        const placeholder = profilePicContainer.querySelector('.profile-pic-placeholder');
        if (currentUserData.profilePicUrl && currentUserData.profilePicUrl !== DEFAULT_LOGO_URL) {
            profilePicImg.src = currentUserData.profilePicUrl;
            profilePicImg.style.display = 'block';
            placeholder.style.display = 'none';
        } else {
            profilePicImg.style.display = 'none';
            placeholder.style.display = 'flex';
        }

        profileInfoEmail.textContent = currentUserData.email;
        profileInfoId.querySelector('span').textContent = `ID: ${currentUserData.numericId}`;
        profilePicContainer.classList.remove('mentor-affiliated', 'no-mentor');

        profileForm['profile-nickname'].value = currentUserData.nickname || currentUserData.name || '';
        profileForm['profile-dob'].value = currentUserData.dob || '';
        profileEmailInput.value = currentUserData.email;
        profileForm['profile-country'].value = currentUserData.country || '';
        profileForm['profile-address'].value = currentUserData.address || '';
        
        ['profile-dob', 'profile-country', 'profile-address'].forEach(fieldName => {
            const input = profileForm[fieldName];
            input.disabled = !!input.value;
        });

        if (currentUserData.kycStatus === 'verified') { kycVerifiedInfoBox.style.display = 'block'; kycLink.style.display = 'none';
        } else { kycVerifiedInfoBox.style.display = 'none'; kycLink.style.display = 'flex'; }
        updateVerificationStatusUI();

        // Mentor Info Section
        const mentorInfoSection = document.getElementById('mentor-info-section');
        if (currentUserData.mentorId) {
            const mentorSnapshot = await database.ref('mentors').orderByChild('mentorId').equalTo(currentUserData.mentorId).once('value');
            if(mentorSnapshot.exists()) {
                const mentor = Object.values(mentorSnapshot.val())[0];
                document.getElementById('my-mentor-name').value = mentor.name;
                document.getElementById('my-mentor-code').value = mentor.mentorId;
                mentorInfoSection.style.display = 'block';
            }
        } else {
            mentorInfoSection.style.display = 'none';
        }
        
        const gridSlider = document.getElementById('grid-visibility-slider');
        const gridSliderValueEl = document.getElementById('grid-visibility-value');
        gridSlider.value = chartSettings.grid.visibility;
        gridSliderValueEl.textContent = chartSettings.grid.visibility;

        const utcSlider = document.getElementById('utc-time-visibility-slider');
        const utcSliderValueEl = document.getElementById('utc-time-visibility-value');
        utcSlider.value = chartSettings.utcTime.visibility;
        utcSliderValueEl.textContent = chartSettings.utcTime.visibility;

        populateTimezones();
        const userTz = currentUserData.settings?.timezone || '+6';
        timezoneSelect.value = userTz;
    }

    function updateVerificationStatusUI() {
        if (!currentUserData) return;

        const profileBtn = document.getElementById('header-profile-btn');
        profileBtn.classList.remove('verified-profile', 'unverified-profile');
        if (currentUserData.kycStatus === 'verified') {
            profileBtn.classList.add('verified-profile');
        } else {
            profileBtn.classList.add('unverified-profile');
        }

        const isEmailVerified = currentUserData.emailVerified;
        if (isEmailVerified) { 
            emailVerifyStatus.textContent = 'Verified'; 
            emailVerifyStatus.className = 'verified';
            emailVerifyStatus.style.cursor = 'default';
            emailVerifyStatus.onclick = null;
        } else { 
            emailVerifyStatus.textContent = 'Click to Verify'; 
            emailVerifyStatus.className = 'unverified';
            emailVerifyStatus.style.cursor = 'pointer';
            emailVerifyStatus.onclick = startEmailVerificationCheck; 
        }

         const isKycVerified = currentUserData.kycStatus === 'verified';
        if (isKycVerified) { profileVerifiedStatus.innerHTML = `<span>Verified</span>`; profileVerifiedStatus.className = 'verified';
        } else if (currentUserData.kycStatus === 'pending') {
            profileVerifiedStatus.innerHTML = `<span>Pending</span>`; profileVerifiedStatus.className = 'unverified';
            profileVerifiedStatus.style.color = 'var(--color-pending)'; profileVerifiedStatus.style.backgroundColor = 'rgba(255, 152, 0, 0.2)';
        } else {
            profileVerifiedStatus.innerHTML = `<span>Unverified</span>`; profileVerifiedStatus.className = 'unverified'; 
            profileVerifiedStatus.style.color = ''; profileVerifiedStatus.style.backgroundColor = '';
        }
        kycStatusBadge.textContent = currentUserData.kycStatus.toUpperCase(); kycStatusBadge.className = `status-badge status-${currentUserData.kycStatus}`;
    }

    function startEmailVerificationCheck() {
        const user = auth.currentUser;
        if (!user || user.emailVerified) return;

        user.sendEmailVerification()
            .then(() => {
                showNotification('Verification email sent to ' + user.email, 'info');
                emailVerifyStatus.textContent = 'Checking...';
                emailVerifyStatus.onclick = null;
                
                if (emailVerificationInterval) clearInterval(emailVerificationInterval);

                let checks = 0;
                emailVerificationInterval = setInterval(async () => {
                    checks++;
                    await user.reload();
                    if (user.emailVerified) {
                        clearInterval(emailVerificationInterval);
                        await database.ref('users/' + user.uid).update({ emailVerified: true });
                        showNotification('Email verified successfully!', 'win');
                    }
                    if (checks > 60) { 
                        clearInterval(emailVerificationInterval);
                        updateVerificationStatusUI();
                    }
                }, 5000);
            })
            .catch(error => {
                showNotification('Error sending verification email: ' + error.message, 'loss');
            });
    }

    profileForm.addEventListener('submit', (e) => {
        e.preventDefault(); const uid = auth.currentUser.uid;
        const updates = { name: profileForm['profile-nickname'].value, nickname: profileForm['profile-nickname'].value, };
        ['profile-dob', 'profile-country', 'profile-address'].forEach(fieldName => {
            const input = profileForm[fieldName];
            if (!input.disabled) { const key = fieldName.replace('profile-', ''); updates[key] = input.value; }
        });
        database.ref('users/' + uid).update(updates).then(() => {
             database.ref('leaderboard/daily/' + uid).update({ name: updates.name });
             showNotification('Profile updated successfully!', 'win');
        }).catch(error => showNotification('Error updating profile: ' + error.message, 'loss'));
    });

    kycLink.addEventListener('click', (e) => { e.preventDefault(); showView('kyc'); });
    kycDocTypeSelect.addEventListener('change', () => { kycNidGroup.style.display = kycDocTypeSelect.value === 'nid' ? 'block' : 'none'; });

    function initKycPage() {
        kycForm.reset(); kycNidGroup.style.display = 'block';
        document.getElementById('kyc-file-front-name').textContent = 'No file chosen'; document.getElementById('kyc-file-back-name').textContent = 'No file chosen'; document.getElementById('kyc-file-selfie-name').textContent = 'No file chosen';
        const status = currentUserData.kycStatus;
        if (status === 'pending' || status === 'verified') {
            kycForm.style.display = 'none'; kycCurrentStatusInfo.style.display = 'block';
            let message = (status === 'pending') ? `<div class="kyc-info-box"><p>Your documents are currently under review. This can take up to 48 hours.</p></div>` : `<div class="kyc-info-box"><p style="color: var(--color-up); font-weight: bold;">Congratulations! Your KYC is verified.</p></div>`;
            kycCurrentStatusInfo.innerHTML = message;
        } else if (status === 'rejected') {
            kycForm.style.display = 'flex'; kycCurrentStatusInfo.style.display = 'block';
            kycCurrentStatusInfo.innerHTML = `<div class="kyc-info-box"><p style="color: var(--color-down); font-weight: bold;">Your KYC submission was rejected.</p><p>Please check your documents and try again.</p></div>`;
        } else { kycForm.style.display = 'flex'; kycCurrentStatusInfo.style.display = 'none'; }
    }

    ['kyc-file-front', 'kyc-file-back', 'kyc-file-selfie'].forEach(id => {
        document.getElementById(id).addEventListener('change', (e) => {
            const fileName = e.target.files[0] ? e.target.files[0].name : '';
            document.getElementById(`${id}-name`).textContent = fileName;
        });
    });

    kycForm.addEventListener('submit', async (e) => {
        e.preventDefault(); kycSubmitButton.disabled = true; kycSubmitButton.textContent = 'Uploading...';
        if (!currentUserData.dob || !currentUserData.country || !currentUserData.address) {
            showNotification('Please complete your Date of Birth, Country, and Address in your profile before submitting KYC.', 'loss');
            kycSubmitButton.disabled = false; kycSubmitButton.textContent = 'Submit for Verification';
            return;
        }
        
        const user = auth.currentUser;
        if (!user) { showNotification('User not found. Please re-login.', 'loss'); return; }
        const files = { front: document.getElementById('kyc-file-front').files[0], back: document.getElementById('kyc-file-back').files[0], selfie: document.getElementById('kyc-file-selfie').files[0] };
        if (!files.front || !files.back || !files.selfie) { showNotification('Please upload all three documents.', 'loss'); kycSubmitButton.disabled = false; kycSubmitButton.textContent = 'Submit for Verification'; return; }
        try {
            const uploadPromises = Object.entries(files).map(([key, file]) => {
                const ref = storage.ref(`kyc-documents/${user.uid}/${key}-${Date.now()}`);
                return ref.put(file).then(snapshot => snapshot.ref.getDownloadURL());
            });
            const [frontUrl, backUrl, selfieUrl] = await Promise.all(uploadPromises);
            const kycRequest = { userId: user.uid, userEmail: user.email, userName: currentUserData.name, docType: kycDocTypeSelect.value, nidNumber: document.getElementById('kyc-nid-number').value || null, frontUrl, backUrl, selfieUrl, status: 'pending', timestamp: firebase.database.ServerValue.TIMESTAMP };
            await database.ref('kyc_requests').push(kycRequest);
            await database.ref(`users/${user.uid}/kycStatus`).set('pending');
            showNotification('KYC documents submitted for review!', 'win');
            kycForm.reset(); showView('profile');
        } catch (error) { console.error("KYC Submission Error:", error); showNotification('Submission failed: ' + error.message, 'loss');
        } finally { kycSubmitButton.disabled = false; kycSubmitButton.textContent = 'Submit for Verification'; }
    });
    
    const withdrawMethods = [
        { id: 'binance-pay', name: 'Binance Pay', receiveType: 'Binance account ID', placeholder: 'Enter 8-10 digit ID', isCrypto: true, logo: 'https://public.bnbstatic.com/image/payment/20210813/3f353ad1-a113-4ae3-9acb-66046e7f414a.png' },
        { id: 'bkash', name: 'Bkash', receiveType: 'Bkash Account Number', placeholder: 'Your Bkash Number', isCrypto: false, logo: 'https://logowik.com/content/uploads/images/bkash-new-logo-20212134.jpg' }, 
        { id: 'nagad', name: 'Nagad', receiveType: 'Nagad Account Number', placeholder: 'Your Nagad Number', isCrypto: false, logo: 'https://media.licdn.com/dms/image/D560BAQG5kxd252EFGA/company-logo_200_200/0/1699507961234/nagad_logo?e=2147483647&v=beta&t=o1Yl1n4EVp8p26M7A9Q7zU82JqJ_oJz8G19m_Gq1P9Y' },
        { id: 'rocket', name: 'Rocket', receiveType: 'Rocket Account Number', placeholder: 'Your Rocket Number', isCrypto: false, logo: 'https://seeklogo.com/images/D/dutch-bangla-rocket-logo-B4D1F145B9-seeklogo.com.png' }, 
        { id: 'jazzcash', name: 'Jazz Cash', receiveType: 'Jazz Cash Account Number', placeholder: 'Your Jazz Cash Number', isCrypto: false, logo: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcT-1c45xItMJl_Y8_pqK7w2D1OfbPKANrjaunHm35Fm4WLz0Vvn1z85y-A&s=10' }, 
        { id: 'gpay', name: 'GPay', receiveType: 'GPay Number / ID', placeholder: 'Your GPay Number or ID', isCrypto: false, logo: 'https://upload.wikimedia.org/wikipedia/commons/thumb/f/f2/Google_Pay_Logo.svg/1280px-Google_Pay_Logo.svg.png' },
        { id: 'upi', name: 'UPI', receiveType: 'UPI ID', placeholder: 'Your UPI ID (e.g. name@okhdfcbank)', isCrypto: false, logo: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRDlR6LojlkLDl__iAPvf7x3wWMpVgcWhStT9fM86-RFxXNCZDxx7pZhTE&s=10' },
        { id: 'bnb', name: 'BNB (BEP20)', receiveType: 'Wallet Address', placeholder: 'Your BNB (BEP20) Address', isCrypto: true, logo: 'https://seeklogo.com/images/B/bnb-logo-E425945A25-seeklogo.com.png' },
        { id: 'usdt', name: 'USDT (TRC20)', receiveType: 'Wallet Address', placeholder: 'Your USDT (TRC20) Address', isCrypto: true, logo: 'https://seeklogo.com/images/T/tether-usdt-logo-FA55313892-seeklogo.com.png' },
    ];
    
    function populateWithdrawalMethods() {
        withdrawMethodOptionsContainer.innerHTML = '';
        withdrawMethods.forEach(method => {
            const isChecked = withdrawMethodSelector.dataset.value === method.id;
            const optionHTML = `<label class="method-option" for="wm-${method.id}"><div class="method-info"><img class="method-logo" src="${method.logo}" alt="${method.name}"><span>${method.name}</span></div><input type="radio" name="withdraw-method" id="wm-${method.id}" value="${method.id}" ${isChecked ? 'checked' : ''}><div class="radio-circle"></div></label>`;
            withdrawMethodOptionsContainer.insertAdjacentHTML('beforeend', optionHTML);
        });
        withdrawMethodOptionsContainer.querySelectorAll('.method-option').forEach(option => {
            option.addEventListener('click', () => {
                const selectedValue = option.querySelector('input').value;
                const selectedMethod = withdrawMethods.find(m => m.id === selectedValue);
                if (selectedMethod) { updateWithdrawForm(selectedMethod); withdrawMethodModal.classList.remove('visible'); }
            });
        });
    }
    
    function initWithdrawPage() {
        if (!currentUserData) return;
        document.getElementById('withdraw-total-balance').textContent = `$${(realBalance + bonusBalance).toFixed(2)}`;
        document.getElementById('withdraw-available-balance').textContent = `$${realBalance.toFixed(2)}`;
        document.getElementById('withdraw-commission').textContent = `$${bonusBalance.toFixed(2)}`;
        updateWithdrawForm(withdrawMethods[0]);
    }

    function updateWithdrawForm(method) {
         if (!method) return;
         withdrawMethodSelector.textContent = method.name; withdrawMethodSelector.dataset.value = method.id;
         withdrawReceiveTypeInput.value = method.receiveType; withdrawAccountIdInput.placeholder = method.placeholder; withdrawAccountIdInput.value = '';
    }

    async function handleWithdrawalRequest(password) {
        const user = auth.currentUser;
        if (!user) return;
        const withdrawAmount = parseFloat(withdrawAmountInput.value); const minWithdraw = 50;
        if (isNaN(withdrawAmount) || withdrawAmount < minWithdraw) { showNotification(`Minimum withdrawal is $${minWithdraw}.`, 'loss'); return; }
        if (withdrawAmount > realBalance) { showNotification('Insufficient available balance for withdrawal.', 'loss'); return; }
        passwordConfirmModal.classList.remove('visible');
        pendingWithdrawalData = { amount: withdrawAmount, method: withdrawMethods.find(m => m.id === withdrawMethodSelector.dataset.value), accountId: withdrawAccountIdInput.value, password: password, bonusRemoved: bonusBalance > 0 ? bonusBalance : 0 };
        await submitWithdrawal(pendingWithdrawalData);
    }
    
    async function submitWithdrawal({ amount, method, accountId, password, bonusRemoved }) {
        const user = auth.currentUser;
        if (!user) return;
        const submitBtn = withdrawForm.querySelector('button[type="submit"]');
        submitBtn.disabled = true; submitBtn.textContent = 'Submitting...';
        try {
            const credential = firebase.auth.EmailAuthProvider.credential(user.email, password);
            await user.reauthenticateWithCredential(credential);
            await updateBalances({ realChange: -amount, bonusChange: -bonusRemoved });
            const newRequestRef = database.ref('withdraw_requests').push();
            const withdrawRequest = { id: newRequestRef.key, userId: user.uid, userEmail: user.email, userName: currentUserData.name || 'N/A', amount: amount, fee: 0, method: method.name, accountId: accountId, status: 'pending', timestamp: firebase.database.ServerValue.TIMESTAMP, bonusRemoved: bonusRemoved };
            await newRequestRef.set(withdrawRequest);
            const newTransaction = { id: withdrawRequest.id, timestamp: Date.now(), status: 'pending', amount: -amount, fee: 0, method: method.name, type: 'withdraw', bonusRemoved: bonusRemoved };
            await database.ref(`users/${user.uid}/transactions/${newTransaction.id}`).set(newTransaction);
            
            showNotification('Withdrawal request successful!', 'win');
            withdrawForm.reset(); showView('transactions');
        } catch (error) {
            console.error("Withdrawal process failed:", error);
            if (error.code === 'auth/wrong-password') { showNotification('Authentication failed. Wrong password.', 'loss'); } 
            else { showNotification('An error occurred during withdrawal.', 'loss'); }
            await updateBalances({ realChange: amount, bonusChange: bonusRemoved });
        } finally {
            submitBtn.disabled = false; submitBtn.textContent = 'Confirm'; pendingWithdrawalData = null;
        }
    }
    
    async function cancelWithdrawal(txId, amount, bonusRemoved) {
        const user = auth.currentUser; if (!user) return;
        if (!confirm(`Are you sure you want to cancel this withdrawal of $${amount.toFixed(2)}?`)) return;
        try {
            const updates = {};
            updates[`withdraw_requests/${txId}`] = null;
            updates[`users/${user.uid}/transactions/${txId}/status`] = 'canceled';
            await database.ref().update(updates);
            await updateBalances({ realChange: amount, bonusChange: 0 }); // Bonus is NOT refunded
            showNotification('Withdrawal canceled successfully.', 'win');
        } catch (error) { console.error("Failed to cancel withdrawal:", error); showNotification("Error canceling withdrawal. Please try again.", 'loss'); }
    }

    withdrawForm.addEventListener('submit', (e) => { 
        e.preventDefault(); 
        if (!currentUserData.emailVerified) {
            showNotification('Please verify your email from the Profile page before withdrawing.', 'loss');
            return;
        }
        passwordConfirmModal.classList.add('visible'); 
    });

    passwordConfirmForm.addEventListener('submit', (e) => { e.preventDefault(); const password = document.getElementById('confirm-password').value; handleWithdrawalRequest(password); });
    
    function renderTransactionHistory() {
        if (transactionHistory.length === 0) { transactionListContainer.innerHTML = `<p>No transactions yet.</p>`; return; }
        transactionListContainer.innerHTML = transactionHistory.map(t => { 
            const date = new Date(t.timestamp), formattedDate = `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getFullYear()}, ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
            const amountClass = t.amount > 0 ? 'positive' : 'negative', amountPrefix = t.amount > 0 ? '+' : '';
            const transactionId = (t.type === 'deposit') ? t.id : (t.id.slice(-8).toUpperCase());
            let methodDisplay = t.method;
            if(t.type === 'bonus') { methodDisplay = t.method || 'System Bonus'; } 
            const cancelButton = (t.type === 'withdraw' && t.status === 'pending') ? `<button class="cancel-withdraw-btn" data-tx-id="${t.id}" data-amount="${Math.abs(t.amount)}" data-bonus="${t.bonusRemoved || 0}">Cancel</button>` : '';
            return `<div class="transaction-item" data-type="${t.type}"><div class="ti-left"><div class="ti-order-id">ID: ${transactionId}</div><div class="ti-date">${formattedDate}</div><div class="ti-status ti-status-${t.status}">${t.status}</div></div><div class="ti-right"><div class="ti-amount ti-amount-${amountClass}">${amountPrefix}$${Math.abs(t.amount).toFixed(2)}</div><div class="ti-details">${methodDisplay} <span class="ti-type">${t.type}</span></div>${cancelButton}</div></div>`;
        }).join('');
    }
    
    function initAnalysisPage() { 
        if (currentUserData && document.getElementById('analysis-total-volume')) {
            document.getElementById('analysis-total-volume').textContent = `$${(currentUserData.totalTradeVolume || 0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        }
        updateAnalysisStats('all'); 
    }

    function updateAnalysisStats(period) {
        const now = Date.now();
        let periodStart = 0;
        if (period === '7d') periodStart = now - 604800000;
        else if (period === '3d') periodStart = now - 259200000;
        else if (period === '1d') periodStart = new Date().setHours(0, 0, 0, 0);
        
        const filteredHistory = fullTradeHistory.filter(t => t.timestamp >= periodStart);
        const stats = calculateStats(filteredHistory);

        document.getElementById('analysis-win-rate').textContent = `${stats.winRate.toFixed(1)}%`;
        const pnlElement = document.getElementById('analysis-pnl');
        pnlElement.textContent = `${stats.pnl >= 0 ? '+' : ''}$${stats.pnl.toFixed(2)}`;
        pnlElement.className = `stat-card-value ${stats.pnl >= 0 ? 'profit' : 'loss'}`;
        document.getElementById('analysis-total-trades').textContent = stats.totalTrades;
        document.getElementById('analysis-avg-invest').textContent = `$${stats.avgInvestment.toFixed(2)}`;
        updateTopInstrumentsAnalysis(filteredHistory);
    }

    function updateTopInstrumentsAnalysis(filteredHistory) {
        const topInstrumentsSection = document.getElementById('top-instruments-section');
        if (filteredHistory.length === 0) { topInstrumentsSection.style.display = 'none'; return; }
        const marketProfits = {};
        filteredHistory.forEach(trade => {
            if (trade.result === 'win' || trade.result === 'loss') {
                const pnl = (trade.result === 'win') ? (trade.payout - trade.amount) : -trade.amount;
                if (!marketProfits[trade.market]) { marketProfits[trade.market] = 0; }
                marketProfits[trade.market] += pnl;
            }
        });
        const profitableMarkets = Object.entries(marketProfits).map(([market, profit]) => ({ market, profit })).filter(item => item.profit > 0).sort((a, b) => b.profit - a.profit);
        if (profitableMarkets.length === 0) { topInstrumentsSection.style.display = 'none'; return; }
        const top3 = profitableMarkets.slice(0, 3);
        const totalTopProfit = top3.reduce((sum, item) => sum + item.profit, 0);
        if (totalTopProfit <= 0) { topInstrumentsSection.style.display = 'none'; return; }
        const dataForRender = top3.map(item => ({ ...item, percentage: (item.profit / totalTopProfit) * 100 }));
        renderTopInstruments(dataForRender);
    }

    function renderTopInstruments(data) {
        const topInstrumentsSection = document.getElementById('top-instruments-section');
        const pieChartEl = document.getElementById('top-instruments-pie-chart'), legendEl = document.getElementById('top-instruments-legend');
        const colors = ['#00C853', '#2962ff', '#FFC107'];
        let gradientString = 'conic-gradient(', legendHTML = '', currentAngle = 0;
        data.forEach((item, index) => {
            const color = colors[index % colors.length], angle = (item.percentage / 100) * 360;
            gradientString += `${color} ${currentAngle}deg ${currentAngle + angle}deg, `;
            currentAngle += angle;
            legendHTML += `<div class="legend-item"><div class="legend-item-color" style="background-color: ${color};"></div><span>${item.market} ${item.percentage.toFixed(0)}%</span></div>`;
        });
        pieChartEl.style.background = gradientString.slice(0, -2) + ')';
        legendEl.innerHTML = legendHTML;
        topInstrumentsSection.style.display = 'block';
    }

    function calculateStats(history) {
        if (history.length === 0) return { winRate: 0, pnl: 0, totalTrades: 0, avgInvestment: 0, wins: 0, losses: 0 };
        const wins = history.filter(t => t.result === 'win').length, losses = history.filter(t => t.result === 'loss').length, totalTrades = history.length;
        const winRate = totalTrades > 0 ? (wins / totalTrades) * 100 : 0;
        const pnl = history.reduce((acc, t) => {
            if (t.result === 'win') return acc + (t.payout - t.amount);
            if (t.result === 'loss') return acc - t.amount;
            return acc;
        }, 0);
        const totalInvestment = history.reduce((acc, t) => acc + t.amount, 0);
        const avgInvestment = totalTrades > 0 ? totalInvestment / totalTrades : 0;
        return { winRate, pnl, totalTrades, avgInvestment, wins, losses };
    }
    
    function calculateRating(winRate, totalTrades) {
        let baseRating = (winRate / 100) * 4;
        let tradeVolumeBonus = Math.min(1, Math.log10(totalTrades + 1) / 2);
        let rating = baseRating + tradeVolumeBonus;
        return Math.max(1, Math.min(5, rating));
    }


    // --- LEADERBOARD LOGIC ---
    const WORLD_NAMES = ["Liam", "Olivia", "Noah", "Emma", "Oliver", "Ava", "Elijah", "Charlotte", "William", "Amelia", "James", "Mia", "Benjamin", "Isabella", "Lucas", "Harper", "Henry", "Evelyn", "Alexander", "Sofia", "Daniel", "Riley", "Jack", "Layla", "Luke", "Lillian", "David", "Nora", "Caleb", "Ellie", "Grayson", "Aaliyah", "Ezra", "Paisley", "Jaxon", "Savannah", "Leo", "Chloe", "Mateo", "Penelope", "Aisha", "Ivan", "Toni", "Mei", "Kenji", "Yuki", "Haruto", "Minho", "Jisoo", "Yuna", "Akira", "Ren", "Takumi", "Tomoko", "Hana", "Riku", "Daichi", "Sakura", "Kaito", "Hiroshi", "Aarav", "Isha", "Priya", "Rohan", "Aditya", "Simran", "Nikita", "Ananya", "Arjun", "Naveen", "Chen", "Wei", "Li", "Lan", "Xiao", "Bo", "Yue", "Tian", "Zhang", "Meilin", "Thiago", "Beatriz", "Bruno", "Lara", "Felipe", "Carmen", "Diego", "Lucia", "Joo", "Camila", "Pedro", "Mariana", "Gustavo", "Isabela", "Carlos", "Ana", "Julia", "Santiago", "Valentina", "Maria", "Amr", "Fatima", "Mohammed", "Omar", "Hassan", "Zainab", "Ali", "Leila", "Samir", "Hiba", "Imran", "Tariq", "Amani", "Youssef", "Faisal", "Salma", "Khalid", "Nadia", "Rami", "Noura", "Isabelle", "Louis", "Camille", "Gabriel", "Chiara", "Lorenzo", "Giulia", "Anastasia", "Dmitri", "Svetlana", "Mikhail", "Andrei", "Irina", "Greta", "Elsa", "Magnus", "Sven", "Hugo", "Mira", "Chiara", "Nova", "Kai", "Mina", "John", "Mary", "Jose", "Aiko", "Sana", "Elina", "Zoya"];
    function shuffleArray(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } return array; }
    
    async function initLeaderboardPage() {
        leaderboardLoader.style.display = 'flex';
        leaderboardContent.style.display = 'none';
        document.getElementById('leaderboard-calculating-state').style.display = 'none';
        document.getElementById('leaderboard-my-rank').style.display = 'none';
        document.getElementById('leaderboard-list').style.display = 'none';
    
        const metaSnapshot = await database.ref('leaderboard/meta').once('value');
        const meta = metaSnapshot.val() || {};
        const lastResetDate = meta.lastResetDate;
        const today = new Date().toISOString().slice(0, 10);
        
        if (!lastResetDate || lastResetDate !== today) {
            await checkAndSeedLeaderboard();
        }

        const now = new Date();
        const startOfTodayUTC = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()));
        const timeSinceReset = now.getTime() - startOfTodayUTC.getTime();
        const threeHoursInMillis = 3 * 60 * 60 * 1000;

        if (timeSinceReset < threeHoursInMillis) {
            leaderboardLoader.style.display = 'none';
            leaderboardContent.style.display = 'block';
            document.getElementById('leaderboard-calculating-state').style.display = 'flex';
        } else {
            listenForLeaderboardUpdates();
        }
    }
    
    async function checkAndSeedLeaderboard() {
        const today = new Date().toISOString().slice(0, 10);
        const leaderboardMetaRef = database.ref('leaderboard/meta');
        const snapshot = await leaderboardMetaRef.once('value'); const meta = snapshot.val();
        if (!meta || meta.lastResetDate !== today) {
            console.log("New day detected. Resetting leaderboard.");
            await seedInitialBots(); await leaderboardMetaRef.set({ lastResetDate: today });
            const usersRef = database.ref('users'); const usersSnapshot = await usersRef.once('value');
            if (usersSnapshot.exists()) {
                const updates = {}; usersSnapshot.forEach(userSnap => { updates[userSnap.key + '/dailyProfit'] = 0; }); await usersRef.update(updates);
            }
        }
    }
    
    // MODIFICATION: Increased bot count for a larger leaderboard
    async function seedInitialBots() {
        const shuffledNames = shuffleArray([...WORLD_NAMES]);
        const leaderboardRef = database.ref('leaderboard/daily');
        const bots = {};
        const todaySeed = new Date().setHours(0, 0, 0, 0);

        const top1Profit = 60000 + seededRandom(todaySeed + 1) * 18000;
        const top50Profit = 4000 + seededRandom(todaySeed + 2) * 1000;

        for (let i = 1; i <= 50; i++) {
            const botId = `bot_top_${i}`;
            const progress = (i-1) / 49;
            let profit = top50Profit + (top1Profit - top50Profit) * Math.pow(1 - progress, 1.8);
            profit += profit * 0.05 * (seededRandom(todaySeed + i * 10) - 0.5);
            
            bots[botId] = {
                uid: botId,
                name: shuffledNames[i - 1] || `Trader #${i}`,
                profit: parseFloat(profit.toFixed(2)),
                profilePicUrl: DEFAULT_LOGO_URL,
                isBot: true,
            };
        }
        
        const totalMidBots = 20000 + Math.floor(seededRandom(todaySeed + 4) * 1000);
        let currentProfit = top50Profit * 0.98;
        for (let i = 0; i < totalMidBots; i++) {
             const botId = `bot_mid_${i}`;
             currentProfit -= (currentProfit * (0.0001 + seededRandom(todaySeed + i) * 0.0002));
             if (currentProfit < 0) currentProfit = 0;
             bots[botId] = { uid: botId, name: `Trader #${51+i}`, profit: parseFloat(currentProfit.toFixed(2)), profilePicUrl: DEFAULT_LOGO_URL, isBot: true, isMidTier: true };
        }

        await leaderboardRef.set(bots);
    }

    function updateRandomBotProfit() {
        database.ref('leaderboard/daily').orderByChild('isBot').equalTo(true).once('value').then(snapshot => {
            if(!snapshot.exists()) return;
            const botData = snapshot.val(); 
            const botKeys = Object.keys(botData);
            if (botKeys.length > 0) {
                const randomBotKey = botKeys[Math.floor(Math.random() * botKeys.length)];
                const botToUpdate = botData[randomBotKey];
                
                const profitChange = (Math.random() - 0.4) * (botToUpdate.profit * 0.005);
                const newProfit = botToUpdate.profit + profitChange;
                database.ref(`leaderboard/daily/${randomBotKey}/profit`).set(parseFloat(newProfit.toFixed(2)));
            }
        });
        
        const randomDelay = 1000 + Math.random() * 3000; 
        leaderboardUpdateInterval = setTimeout(updateRandomBotProfit, randomDelay);
    }

    function listenForLeaderboardUpdates() {
        const leaderboardRef = database.ref('leaderboard/daily');
        leaderboardRef.on('value', (snapshot) => {
            const now = new Date();
            const startOfTodayUTC = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()));
            const timeSinceReset = now.getTime() - startOfTodayUTC.getTime();
            const threeHoursInMillis = 3 * 60 * 60 * 1000;
            
            if (snapshot.exists() && currentView === 'leaderboard' && timeSinceReset >= threeHoursInMillis) { 
                const data = snapshot.val(); 
                leaderboardDataCache = Object.values(data);
                renderLeaderboard(leaderboardDataCache); 
            }
        });
        
        if (leaderboardUpdateInterval) clearTimeout(leaderboardUpdateInterval);
        updateRandomBotProfit();
    }

    function renderLeaderboard(data) {
        if (!currentUserData) return;
        leaderboardLoader.style.display = 'none';
        leaderboardContent.style.display = 'block';
        document.getElementById('leaderboard-calculating-state').style.display = 'none';
        document.getElementById('leaderboard-my-rank').style.display = 'grid';
        document.getElementById('leaderboard-list').style.display = 'block';

        const sortedData = [...data].sort((a, b) => (b.profit || 0) - (a.profit || 0));
        leaderboardDataCache = sortedData; 
        const myId = auth.currentUser.uid;
        
        const myDataInBoard = sortedData.find(u => u.uid === myId);
        const myCurrentProfit = myDataInBoard ? myDataInBoard.profit : (currentUserData.dailyProfit || 0);

        let myRank;
        const myActualRankIndex = sortedData.findIndex(u => u.uid === myId);

        if (myActualRankIndex !== -1) {
            myRank = myActualRankIndex + 1;
        } else {
            let estimatedRank = sortedData.length;
            for(let i=0; i<sortedData.length; i++) {
                if(myCurrentProfit > (sortedData[i].profit || 0)) {
                    estimatedRank = i + 1;
                    break;
                }
            }
            myRank = estimatedRank;
        }

        const myProfitClassForCard = myCurrentProfit >= 0 ? 'win' : 'loss';

        const myRankHTML = `
            <div class="lb-pfp">
                 <img src="${currentUserData.profilePicUrl || DEFAULT_LOGO_URL}" alt="pfp">
            </div>
            <div class="lb-info">
                <div class="lb-name">${currentUserData.name || 'You'}</div>
                <div class="lb-position">Your position: ${myRank.toLocaleString()}</div>
            </div>
            <div class="lb-profit ${myProfitClassForCard}">$${myCurrentProfit.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
        `;
        leaderboardMyRank.innerHTML = myRankHTML;
        
        leaderboardList.innerHTML = '';
        sortedData.slice(0, 50).forEach((user, index) => {
            if (!user) return;
            const profitValue = user.profit || 0;
            const nameValue = user.name || 'Trader';
            const rank = index + 1;

            let rankClass = '', nameClass = '';
            if (rank <= 3) {
                rankClass = `lb-rank-${rank}`;
                nameClass = `lb-name-${rank}`;
            }
            const profitClass = profitValue >= 0 ? 'win' : 'loss';
            
            const profitDisplay = profitValue > 30000 ? '$30,000+' : `$${profitValue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            
            const userHtml = `
                <div class="leaderboard-item" data-uid="${user.uid}">
                    <span class="lb-rank ${rankClass}">${rank}</span>
                    <span class="lb-name ${nameClass}">${nameValue}</span>
                    <span class="lb-profit ${profitClass}">${profitDisplay}</span>
                </div>`;
            leaderboardList.innerHTML += userHtml;
        });
    }
    
    async function showUserProfilePopup(uid) {
        const userData = leaderboardDataCache.find(u => u.uid === uid);
        if (!userData) return;

        document.getElementById('lb-user-profile-name').textContent = userData.name;
        const pfpContainer = document.getElementById('lb-user-profile-pic');
        pfpContainer.innerHTML = `<img src="${userData.profilePicUrl || DEFAULT_LOGO_URL}" alt="pfp">`;
        
        const profitEl = document.getElementById('lb-user-profile-profit');
        const profitValue = userData.profit || 0;
        profitEl.textContent = `$${profitValue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        profitEl.className = profitValue >= 0 ? 'win' : 'loss';

        let stats;
        let rating = 0;
        if (userData.isBot) {
            const seed = userData.uid.hashCode() + new Date().setHours(0,0,0,0);
            const totalTrades = Math.floor(40 + (seededRandom(seed+1) * 350) + (Math.abs(userData.profit) / 250));
            const winRate = 55 + (seededRandom(seed+2) * 20);
            const wins = Math.round(totalTrades * (winRate / 100));
            const losses = totalTrades - wins;
            stats = { totalTrades, winRate, wins, losses };
            rating = calculateRating(winRate, totalTrades);
        } else {
            const todayStart = new Date().setHours(0, 0, 0, 0);
            const todayTrades = fullTradeHistory.filter(t => t.timestamp >= todayStart);
            stats = calculateStats(todayTrades);
            rating = calculateRating(stats.winRate, stats.totalTrades);
        }

        document.getElementById('lb-user-stat-trades').textContent = stats.totalTrades;
        document.getElementById('lb-user-stat-winrate').textContent = `${stats.winRate.toFixed(1)}%`;
        document.getElementById('lb-user-stat-rating').innerHTML = `${rating.toFixed(1)} <svg xmlns="http://www.w3.org/2000/svg" style="width:1em; height:1em; vertical-align:-0.1em;" viewBox="0 0 24 24"><path fill="currentColor" d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2L9.19 8.63L2 9.24l5.46 4.73L5.82 21z"/></svg>`;
        document.getElementById('lb-user-stat-wins').textContent = stats.wins;
        document.getElementById('lb-user-stat-losses').textContent = stats.losses;
        
        leaderboardUserProfileModal.classList.add('visible');
    }

    async function updateUserDailyProfit(profitChange) {
        const user = auth.currentUser;
        if (!user) return;
        
        const validatedProfitChange = parseFloat(profitChange) || 0;
        if (validatedProfitChange === 0 && profitChange !== 0) {
            console.error("Invalid profitChange value passed to updateUserDailyProfit:", profitChange);
            return;
        }

        const userRef = database.ref(`users/${user.uid}/dailyProfit`);
        const leaderboardUserRef = database.ref(`leaderboard/daily/${user.uid}`);
        
        const { committed, snapshot } = await userRef.transaction(currentProfit => {
            const currentProfitNum = parseFloat(currentProfit) || 0;
            return currentProfitNum + validatedProfitChange;
        });

        if (committed) {
            const newDailyProfit = snapshot.val();
            await leaderboardUserRef.set({
                uid: user.uid,
                name: currentUserData.name || 'Trader',
                profit: parseFloat(newDailyProfit.toFixed(2)),
                profilePicUrl: currentUserData.profilePicUrl || DEFAULT_LOGO_URL,
                isBot: false
            });
        }
    }
    
    function seededRandom(seed) { let x = Math.sin(seed) * 10000; return x - Math.floor(x); }
    
    function updateMarketState(candle) {
        if (!candle || typeof candle.open !== 'number') return;
        const currentVolatility = (candle.high - candle.low) / candle.open;
        const targetVolatility = 0.00035;
        if (currentVolatility > targetVolatility * 1.5) {
            marketState.volatility *= 0.98;
        } else {
            marketState.volatility *= 1.01;
        }
        marketState.volatility = Math.max(0.5, Math.min(marketState.volatility, 2.0));

        const bodySize = Math.abs(candle.close - candle.open);
        const momentumChange = (bodySize / candle.open) * 500;
        if (candle.close > candle.open) { 
            marketState.momentum += momentumChange;
        } else { 
            marketState.momentum -= momentumChange;
        }
        marketState.momentum *= 0.75; 
        marketState.momentum = Math.max(-0.25, Math.min(marketState.momentum, 0.25));
    }
    
    async function getOrCreateTradeCycle() {
        const user = auth.currentUser;
        if (!user) return null;
    
        let tradeCycle = currentUserData.tradeCycle;
        const now = Date.now();
    
        if (!tradeCycle || tradeCycle.count >= 10) {
            // Start a new cycle
            const oldTier = tradeCycle ? tradeCycle.tier : -1;
            let newTier = (oldTier + 1) % 3; // Cycle through 0, 1, 2
    
            let losses;
            const PROFIT_TARGET = 150;
    
            if ((currentUserData.dailyProfit || 0) > PROFIT_TARGET) {
                losses = 8; // Force 80% loss rate if profit target is met
            } else {
                switch (newTier) {
                    case 0: losses = 6; break; // 60%
                    case 1: losses = 7; break; // 70%
                    case 2: losses = 9; break; // 90%
                    default: losses = 6;
                }
            }
    
            const wins = 10 - losses;
            let pattern = Array(losses).fill('L').concat(Array(wins).fill('W'));
            pattern = shuffleArray(pattern); // Shuffle for unpredictability
    
            tradeCycle = {
                count: 0,
                tier: newTier,
                pattern: pattern,
                startTime: now
            };
    
            await database.ref(`users/${user.uid}/tradeCycle`).set(tradeCycle);
            currentUserData.tradeCycle = tradeCycle; // Update local copy
        }
        return tradeCycle;
    }

    async function determineCandleOutcome(expiringBets) {
        if (!expiringBets || expiringBets.length === 0) {
            return seededRandom(Date.now() + currentMarket.hashCode()) < 0.5 ? 'GREEN' : 'RED';
        }
    
        const userBet = expiringBets[0]; 
        const tradeCycle = await getOrCreateTradeCycle();
    
        if (!tradeCycle || !tradeCycle.pattern) {
            return seededRandom(Date.now() + userBet.id.hashCode()) < 0.5 ? 'GREEN' : 'RED';
        }
    
        const outcome = tradeCycle.pattern[tradeCycle.count];
        let targetColor;
    
        if (outcome === 'W') {
            targetColor = userBet.direction === 'UP' ? 'GREEN' : 'RED';
        } else {
            targetColor = userBet.direction === 'UP' ? 'RED' : 'GREEN';
        }
        
        return targetColor;
    }

    async function generateCandleData(timestamp, timeframe, prevCloseOverride = null) {
        const open = prevCloseOverride || (historicalData.length > 0 ? historicalData[historicalData.length - 1].close : 1.15500);

        if (adminCandleOverride && adminCandleOverride.type) {
            const overrideType = adminCandleOverride.type;
            const prevCandle = historicalData[historicalData.length - 1];
            let close, high, low;

            const bodySize = (prevCandle.high - prevCandle.low) * (0.4 + seededRandom(timestamp) * 0.4);
            const doubleBodySize = (prevCandle.high - prevCandle.low) * 1.8;
            const wickSize = bodySize * (0.1 + seededRandom(timestamp + 1) * 0.3);

            if (overrideType.startsWith('GREEN')) {
                if (overrideType === 'GREEN_BREAKOUT') {
                    close = prevCandle.high + (bodySize * 0.2);
                } else if (overrideType === 'GREEN_INSIDE') {
                    close = open + bodySize;
                    if (close > prevCandle.high) close = prevCandle.high - (prevCandle.high * 0.0001);
                } else { // GREEN_DOUBLE
                    close = open + doubleBodySize;
                }
                high = close + wickSize;
                low = open - wickSize;
            } else { // RED
                if (overrideType === 'RED_BREAKOUT') {
                    close = prevCandle.low - (bodySize * 0.2);
                } else if (overrideType === 'RED_INSIDE') {
                    close = open - bodySize;
                    if (close < prevCandle.low) close = prevCandle.low + (prevCandle.low * 0.0001);
                } else { // RED_DOUBLE
                    close = open - doubleBodySize;
                }
                low = close - wickSize;
                high = open + wickSize;
            }
            
            adminOverridesRef.remove();
            
            return { open, high, low, close, timestamp };
        }

        let targetColor;

        if (marketPatternConfig && marketPatternConfig.isActive && marketPatternConfig.pattern && marketPatternConfig.pattern.length > 0) {
            const patternStartTime = marketPatternConfig.startTime;
            const patternTimeframe = marketPatternConfig.timeframe * 1000;
            const ts = Math.floor(timestamp / (timeframe * 1000)) * timeframe * 1000;
            
            if (ts >= patternStartTime) {
                const timeIntoPattern = ts - patternStartTime;
                const patternIndex = Math.floor(timeIntoPattern / patternTimeframe);
                if (patternIndex >= 0 && patternIndex < marketPatternConfig.pattern.length) {
                    targetColor = marketPatternConfig.pattern[patternIndex];
                }
            }
        }
        
        if (!targetColor) {
            const expiringBets = myActiveBets.filter(bet => bet.resolveOnNextOpen && bet.expiryTimestamp === (timestamp + timeframe * 1000));
            targetColor = await determineCandleOutcome(expiringBets);
        }

        const baseVolatility = open * (0.00015 + seededRandom(timestamp + currentMarket.hashCode() + 1) * 0.0001) * marketState.volatility;
        const bodySize = baseVolatility * (0.2 + seededRandom(timestamp + currentMarket.hashCode() + 2) * 0.6);
        
        const close = (targetColor === 'GREEN') ? open + bodySize : open - bodySize;
        
        const finalCandle = { open, close, timestamp };
        
        updateMarketState({ ...finalCandle, high: Math.max(open, close), low: Math.min(open, close) });
        return finalCandle;
    }

    function createCandleWithPath(candleData) {
        if (currentMarketType === 'real' || !candleData) return candleData;
        if (candleData.path && candleData.path.length === CANDLE_PATH_STEPS) return candleData;

        const { open, close, timestamp } = candleData;
        const path = [];
        let currentPrice = open;
        const baseVolatility = open * (0.00002 + seededRandom(timestamp) * 0.0001) * marketState.volatility;

        const totalRange = Math.abs(open - close) + (baseVolatility * 2);
        const highBound = Math.max(open, close) + totalRange * (0.1 + seededRandom(timestamp + 1) * 0.4);
        const lowBound = Math.min(open, close) - totalRange * (0.1 + seededRandom(timestamp + 2) * 0.4);
        
        const anchor1_progress = 0.2 + seededRandom(timestamp + 5) * 0.3;
        const anchor2_progress = 0.6 + seededRandom(timestamp + 6) * 0.3;
        const anchor1_price = lowBound + seededRandom(timestamp + 7) * (highBound - lowBound);
        const anchor2_price = lowBound + seededRandom(timestamp + 8) * (highBound - lowBound);
        
        let noise = 0;

        for (let i = 0; i < CANDLE_PATH_STEPS; i++) {
            const progress = i / (CANDLE_PATH_STEPS - 1);
            let targetPrice;

            const t = progress;
            const p0 = open;
            const p1 = anchor1_price;
            const p2 = anchor2_price;
            const p3 = close;
            
            targetPrice = Math.pow(1 - t, 3) * p0 + 3 * Math.pow(1 - t, 2) * t * p1 + 3 * (1 - t) * Math.pow(t, 2) * p2 + Math.pow(t, 3) * p3;

            noise = (noise * 0.9) + (seededRandom(timestamp + i) - 0.5) * baseVolatility * 0.4;
            currentPrice = targetPrice + noise;
            path.push(currentPrice);
        }
        path[CANDLE_PATH_STEPS - 1] = close;

        const finalHigh = Math.max(...path);
        const finalLow = Math.min(...path);

        return { open, high: finalHigh, low: finalLow, close, path, timestamp };
    }
    
    async function saveCandleToFirebase(candleData) {
        if (!candleData || !candlesRef) return;
        const { path, ...candleToSave } = candleData;
        try {
            const candleToSaveRef = candlesRef.child(candleToSave.timestamp);
            candleToSaveRef.transaction(currentData => (currentData === null ? candleToSave : undefined));
        } catch (error) { console.error("Failed to save candle in background:", error); }
    }

    async function loadMoreHistoricalDataInBackground() {
        if (historicalData.length === 0 || !candlesRef) return;
        const oldestTimestamp = historicalData[0].timestamp;
        const endAtTimestamp = String(oldestTimestamp - 1);
        try {
            const snapshot = await candlesRef.orderByKey().endAt(endAtTimestamp).limitToLast(50).once('value');
            if (snapshot.exists()) {
                const olderData = [];
                snapshot.forEach(childSnapshot => { olderData.push(createCandleWithPath(childSnapshot.val())); });
                historicalData.unshift(...olderData.sort((a,b) => a.timestamp - b.timestamp));
                
                const marketId = localStorage.getItem('lastMarketId');
                marketDataCache[marketId] = historicalData.slice();
                aggregateDataForDisplay();
            }
        } catch (error) { console.error("Failed to load background historical data:", error); }
    }
    
    function getLiveCandleState(candle) {
        if (currentMarketType === 'real' || !candle || !candle.path || candle.path.length === 0) {
            return { ...candle };
        }

        const now = Date.now();
        const timeElapsed = now - candle.timestamp;
        const progress = Math.min(timeElapsed / (BASE_TIMEFRAME * 1000), 1);
        const pathIndex = Math.min(candle.path.length - 1, Math.floor(progress * (candle.path.length - 1)));
        
        const revealedPath = candle.path.slice(0, pathIndex + 1);

        if (revealedPath.length === 0) {
            return { ...candle, high: candle.open, low: candle.open, close: candle.open };
        }

        const liveClose = revealedPath[revealedPath.length - 1];
        
        const liveHigh = revealedPath.reduce((max, p) => Math.max(max, p), candle.open);
        const liveLow = revealedPath.reduce((min, p) => Math.min(min, p), candle.open);

        return { ...candle, high: liveHigh, low: liveLow, close: liveClose };
    }
    
    function addTradeResultToQueue(resultData) {
        tradeResultQueue.push(resultData);
        if (!isProcessingQueue) { processResultQueue(); }
    }
    
    function processResultQueue() {
        if (tradeResultQueue.length === 0) { isProcessingQueue = false; return; }
        isProcessingQueue = true;
        const resultData = tradeResultQueue.shift(); 
        const container = document.getElementById('trade-result-queue-container');
        if (!container) { isProcessingQueue = false; return; }
        const resultItem = document.createElement('div');
        resultItem.className = `trade-result-item ${resultData.resultClass}`;
        resultItem.innerHTML = `<span class="trade-result-pnl ${resultData.resultClass}">${resultData.pnlText}</span><span class="trade-result-details">${resultData.market}</span>`;
        container.appendChild(resultItem);
        setTimeout(() => { resultItem.classList.add('show'); }, 10);
        setTimeout(() => {
            resultItem.classList.remove('show');
            setTimeout(() => { resultItem.remove(); setTimeout(processResultQueue, 500); }, 500); 
        }, 3000); 
    }

    async function resolveExpiredBets() {
        const now = Date.now();
        const betsToResolve = myActiveBets.filter(bet => now >= bet.expiryTimestamp && bet.market === currentMarket);
        if (betsToResolve.length === 0) return;
        const user = auth.currentUser;
        if (!user) return;
        let totalRealChange = 0, totalBonusChange = 0, totalProfitChange = 0, totalAmountForMentor = 0, totalAmountForVolume = 0;
        const historyUpdates = {}, activeTradeDeletions = {}, userUpdates = {};
        for (const bet of betsToResolve) {
            const historySnapshot = await database.ref(`users/${user.uid}/tradeHistory/${bet.id}`).once('value');
            if (historySnapshot.exists()) { 
                activeTradeDeletions[`/users/${user.uid}/activeTrades/${bet.id}`] = null; 
                continue; 
            }

            totalAmountForMentor += bet.amount;
            totalAmountForVolume += bet.amount;
            let closingPrice;
            const relevantTimeframe = (currentMarketType === 'real' || currentMarketType === 'broker_real') ? REAL_MARKET_TIMEFRAME : BASE_TIMEFRAME;
            
            let closingCandle;
            if (bet.resolveOnNextOpen) {
                closingCandle = historicalData.find(c => c.timestamp === bet.expiryTimestamp);
                if (closingCandle) closingPrice = closingCandle.open;
            } else {
                closingCandle = historicalData.find(c => bet.expiryTimestamp > c.timestamp && bet.expiryTimestamp <= c.timestamp + (relevantTimeframe * 1000));
                if (closingCandle) {
                     if (currentMarketType === 'real') { 
                        closingPrice = closingCandle.close;
                    } else {
                        if (!closingCandle.path) closingCandle = createCandleWithPath(closingCandle);
                        const progress = (bet.expiryTimestamp - closingCandle.timestamp) / (relevantTimeframe * 1000);
                        const pathIndex = Math.min(Math.floor(progress * (closingCandle.path.length - 1)), closingCandle.path.length - 1);
                        closingPrice = closingCandle.path[pathIndex];
                    }
                }
            }

            if (typeof closingPrice === 'undefined') continue;
            let result, payout, profitChange;
            const betAmount = parseFloat(bet.amount), openPrice = parseFloat(bet.openPrice), betPayoutRate = parseFloat(bet.payoutRate) || PAYOUT_RATE;
            const priceDifference = closingPrice - openPrice, pricePrecision = 1e-6;
            if (Math.abs(priceDifference) < pricePrecision) {
                result = 'push'; payout = betAmount; profitChange = 0;
                totalRealChange += parseFloat(bet.realAmount); totalBonusChange += parseFloat(bet.bonusAmount);
            } else if ((priceDifference > 0 && bet.direction === 'UP') || (priceDifference < 0 && bet.direction === 'DOWN')) {
                result = 'win'; payout = betAmount * betPayoutRate; profitChange = payout - betAmount;
                totalRealChange += payout;
            } else {
                result = 'loss'; payout = 0; profitChange = -betAmount;
            }
            totalProfitChange += profitChange;
            const historyEntry = { id: bet.id, market: bet.market, direction: bet.direction, openPrice: openPrice, closePrice: closingPrice, amount: betAmount, payout: payout, result: result, timestamp: bet.expiryTimestamp, payoutRate: betPayoutRate };
            historyUpdates[`/users/${user.uid}/tradeHistory/${bet.id}`] = historyEntry;
            activeTradeDeletions[`/users/${user.uid}/activeTrades/${bet.id}`] = null;
            
            userUpdates[`/users/${user.uid}/tradeCycle/count`] = firebase.database.ServerValue.increment(1);
            userUpdates[`/users/${user.uid}/totalTradeVolume`] = firebase.database.ServerValue.increment(betAmount);
            userUpdates[`/users/${user.uid}/totalProfitLoss`] = firebase.database.ServerValue.increment(profitChange);
            userUpdates[`/users/${user.uid}/lastTradeTimestamp`] = firebase.database.ServerValue.TIMESTAMP;


            let pnlText, messageClass;
            if (result === 'win') { pnlText = `+USDT ${(profitChange).toFixed(2)}`; messageClass = 'win';
            } else if (result === 'loss') { pnlText = `-USDT ${betAmount.toFixed(2)}`; messageClass = 'loss';
            } else { pnlText = `USDT ${betAmount.toFixed(2)} Returned`; messageClass = 'push'; }
            addTradeResultToQueue({ pnlText, resultClass: messageClass, market: bet.market });
        }
        const finalUpdates = {...historyUpdates, ...activeTradeDeletions, ...userUpdates};
        try {
            if(Object.keys(finalUpdates).length > 0) { await database.ref().update(finalUpdates); }
            if (totalRealChange !== 0 || totalBonusChange !== 0) { await updateBalances({ realChange: totalRealChange, bonusChange: totalBonusChange }); }
            if (totalProfitChange !== 0) { await updateUserDailyProfit(totalProfitChange); }
            if (currentUserData && currentUserData.mentorId && totalAmountForMentor > 0) {
                 await trackMentorTradeVolume(currentUserData.mentorId, currentUserData.uid, totalAmountForMentor);
            }
            myActiveBets = myActiveBets.filter(bet => !activeTradeDeletions[`/users/${user.uid}/activeTrades/${bet.id}`]);
            updateTradeControlsState();
        } catch(error) { console.error("Error batch-resolving trades:", error); }
    }
    
    async function trackMentorTradeVolume(mentorId, studentUid, tradeAmount) {
        if (!mentorId || !studentUid || tradeAmount <= 0) return;
        const MENTOR_COMMISSION_RATE = 0.005; // 0.5%
        
        try {
            const mentorsRef = database.ref('mentors');
            const snapshot = await mentorsRef.orderByChild('mentorId').equalTo(mentorId).once('value');
            if (!snapshot.exists()) return;
            
            let mentorUid;
            snapshot.forEach(child => { mentorUid = child.key; });
            if (!mentorUid) return;
            
            const mentorStudentRef = database.ref(`mentors/${mentorUid}/students/${studentUid}`);
            const commissionAmount = tradeAmount * MENTOR_COMMISSION_RATE;
            
            const updates = {
                lastActiveTimestamp: firebase.database.ServerValue.TIMESTAMP,
                unpaidTradeVolume: firebase.database.ServerValue.increment(tradeAmount),
                totalCommissionGenerated: firebase.database.ServerValue.increment(commissionAmount)
            };
            await mentorStudentRef.update(updates);
            
            // Also add to mentor's commission wallet
            const mentorWalletRef = database.ref(`mentors/${mentorUid}/commissionWallet`);
            await mentorWalletRef.update({
                balance: firebase.database.ServerValue.increment(commissionAmount),
                totalEarned: firebase.database.ServerValue.increment(commissionAmount)
            });

        } catch (error) {
            console.error("Failed to track mentor trade volume:", error);
        }
    }


    function updatePulseAnimation() {
        pulseAnimation.radius += 0.5; 
        pulseAnimation.opacity = 1 - (pulseAnimation.radius / pulseAnimation.maxRadius);

        if (pulseAnimation.opacity <= 0) {
            pulseAnimation.radius = 0;
            pulseAnimation.opacity = 0;
        }
    }

    async function gameLoop(currentTime) {
        animationFrameId = requestAnimationFrame(gameLoop);
        if (document.hidden || !isAppInitialized) return;
        await resolveExpiredBets();
        if (currentView === 'chart') {
            if (!canvas.width || !canvas.height) return;
            if (isSyncing) {
                 drawChartLoadingMessage("Syncing chart...");
                 return;
            }
            const now = Date.now();
            if (currentTime - lastFrameTime < 30) return;
            lastFrameTime = currentTime;
            updatePulseAnimation();
            
            if (historicalData.length === 0) { drawChartLoadingMessage("Loading chart data..."); return; }
            
            let liveBaseCandle;
            if (currentMarketType === 'real') {
                liveBaseCandle = historicalData[historicalData.length - 1];
            } else {
                const lastKnownBaseCandle = historicalData[historicalData.length - 1];
                const currentPeriodStart = Math.floor(now / (BASE_TIMEFRAME * 1000)) * (BASE_TIMEFRAME * 1000);
                if (lastKnownBaseCandle && lastKnownBaseCandle.timestamp < currentPeriodStart) {
                    forceChartSync();
                }
                liveBaseCandle = getLiveCandleState(lastKnownBaseCandle);
            }
            
            if (liveBaseCandle) {
                aggregateDataForDisplay(liveBaseCandle);
                drawChart(displayedChartData[displayedChartData.length -1]);
                
                const strikePriceEl = document.getElementById('strike-price-current');
                if (strikePriceEl) strikePriceEl.textContent = liveBaseCandle.close.toFixed(5);
                const strikeSublabel = document.getElementById('strike-sublabel');
                if(strikeSublabel) strikeSublabel.textContent = liveBaseCandle.close.toFixed(5);
            }
        }
    }
    
    function updateTradeControlsState() {
        const hasActiveTrades = myActiveBets.length > 0;
        marketSelectorBtnNew.disabled = hasActiveTrades;
        marketSelectorBtnNew.style.opacity = hasActiveTrades ? '0.6' : '1';
    }
    
    async function handleBet(direction) {
        if (isBetActionInProgress) {
            showNotification('Please wait for the previous trade to be placed.', 'info');
            return;
        }
        isBetActionInProgress = true;
        btnUp.disabled = true; btnDown.disabled = true;

        const tradeTime = formatTimeLong(expirySettings.value);
        const tradeMessage = `
New Trade Placed!
-------------------------
User: ${currentUserData.name} (${currentUserData.numericId})
Market: ${currentMarket}
Direction: ${direction.toUpperCase()}
Duration: ${tradeTime}
Amount: ${investmentAmount.toFixed(2)} USDT
Balance: ${balance.toFixed(2)} USDT
-------------------------
`;
        sendTelegramNotification(tradeMessage);

        try {
            const uid = auth.currentUser.uid;
            let multipleTradeViolations = userTaskProgress.multipleTradeViolations || 0;
            if (myActiveBets.length >= 2) {
                 if (multipleTradeViolations === 0 && !userTaskProgress.multipleTradeWarningShown) {
                    multipleTradesWarningModal.classList.add('visible');
                    await database.ref(`users/${uid}/taskProgress/multipleTradeWarningShown`).set(true);
                    isBetActionInProgress = false; btnUp.disabled = false; btnDown.disabled = false;
                    return;
                 }
                 multipleTradeViolations++;
                 await database.ref(`users/${uid}/taskProgress/multipleTradeViolations`).set(multipleTradeViolations);
                 let banDuration = (multipleTradeViolations === 1) ? (30 * 60 * 1000) : (6 * 24 * 60 * 60 * 1000);
                 const banUntil = Date.now() + banDuration;
                 await database.ref(`users/${uid}/bannedUntil`).set(banUntil);
                 await forceLossAllActiveTrades();
                 isBetActionInProgress = false; btnUp.disabled = false; btnDown.disabled = false;
                 return;
            }
            
            if(investmentAmount === 0) investmentAmount = 1;

            const minInvestment = 1;
            const maxInvestment = 1000;
            if (isNaN(investmentAmount) || investmentAmount < minInvestment || investmentAmount > balance) { 
                showNotification(`Invalid amount (min ${minInvestment} USDT) or insufficient balance.`, 'loss'); 
                isBetActionInProgress = false; btnUp.disabled = false; btnDown.disabled = false;
                return; 
            }
            if (investmentAmount > maxInvestment) { 
                if (balance > 0 && balance < 1000) {
                    investmentAmount = balance;
                    showNotification(`Amount adjusted to your full balance: $${balance.toFixed(2)}`, 'info');
                } else {
                    showNotification(`Maximum investment is ${maxInvestment} USDT.`, 'loss'); 
                    isBetActionInProgress = false; btnUp.disabled = false; btnDown.disabled = false;
                    return;
                }
            }
            const user = auth.currentUser;
            if (!user) { 
                showNotification('You must be logged in to trade.', 'loss'); 
                isBetActionInProgress = false; btnUp.disabled = false; btnDown.disabled = false;
                return; 
            }
            let realDeduction = (investmentAmount <= realBalance) ? investmentAmount : realBalance;
            let bonusDeduction = (investmentAmount > realBalance) ? (investmentAmount - realBalance) : 0;
            
            let openPrice;
            const liveBaseCandle = getLiveCandleState(historicalData[historicalData.length - 1]);
            if (!liveBaseCandle) {
                showNotification('Chart is not ready. Please wait a moment.', 'info');
                isBetActionInProgress = false; btnUp.disabled = false; btnDown.disabled = false;
                return;
            }
            openPrice = liveBaseCandle.close;

            if (forceHighLossRate && Math.random() < 0.3) {
                const slippageAmount = openPrice * 0.00005 * (Math.random() + 0.5);
                if (direction === 'UP') {
                    openPrice += slippageAmount;
                    showNotification('Slippage occurred.', 'info');
                } else {
                    openPrice -= slippageAmount;
                    showNotification('Slippage occurred.', 'info');
                }
            }

            const now = Date.now();
            let expiryTimestamp;
            let resolveOnNextOpen = false;
            
            const timeIntoCandle = (now - liveBaseCandle.timestamp) % (BASE_TIMEFRAME * 1000);

            if (expirySettings.type === 'time') {
                const candleEndTime = liveBaseCandle.timestamp + BASE_TIMEFRAME * 1000;
                const nextCandleOpenTime = candleEndTime;
                const candlesToWait = Math.floor(expirySettings.value / BASE_TIMEFRAME);

                if (timeIntoCandle < 30000) {
                    expiryTimestamp = nextCandleOpenTime + ((candlesToWait - 1) * BASE_TIMEFRAME * 1000);
                } else {
                     expiryTimestamp = nextCandleOpenTime + (candlesToWait * BASE_TIMEFRAME * 1000);
                }
                resolveOnNextOpen = true;
            } else {
                expiryTimestamp = now + (expirySettings.value * 1000);
                resolveOnNextOpen = false;
            }
            
            await updateBalances({ realChange: -realDeduction, bonusChange: -bonusDeduction });
            await database.ref(`users/${user.uid}/taskProgress/tradeVolume`).set(firebase.database.ServerValue.increment(investmentAmount));
            await database.ref(`users/${user.uid}/taskProgress/currentTradeVolume`).set(firebase.database.ServerValue.increment(investmentAmount));
            const activeTradesRef = database.ref(`users/${user.uid}/activeTrades`);
            const newBetRef = activeTradesRef.push();
            const betData = { 
                id: newBetRef.key, 
                amount: investmentAmount, 
                realAmount: realDeduction, 
                bonusAmount: bonusDeduction, 
                direction, 
                openPrice: openPrice, 
                expiryTimestamp, 
                expiryType: expirySettings.type, 
                entryTimestamp: liveBaseCandle.timestamp, 
                payoutRate: PAYOUT_RATE, 
                market: currentMarket,
                resolveOnNextOpen: resolveOnNextOpen
            };
            
            await newBetRef.set(betData);
            updateTradeControlsState();

        } catch (error) {
            console.error("Betting error:", error);
            showNotification('An error occurred. Please try again.', 'loss');
        } finally {
            setTimeout(() => {
                isBetActionInProgress = false;
                if(myActiveBets.length < 2) {
                    btnUp.disabled = false;
                    btnDown.disabled = false;
                }
            }, 300);
        }
    }
    
    async function forceLossAllActiveTrades() {
        const user = auth.currentUser;
        if (!user || myActiveBets.length === 0) return;
        let totalLoss = 0;
        const historyUpdates = {}, activeTradeDeletions = {};
        for (const bet of myActiveBets) {
            totalLoss += bet.amount;
            const historyEntry = { id: bet.id, market: bet.market, direction: bet.direction, openPrice: bet.openPrice, closePrice: bet.openPrice - 0.00001, amount: bet.amount, payout: 0, result: 'loss', timestamp: Date.now(), payoutRate: bet.payoutRate, reason: "Rule Violation" };
            historyUpdates[`/users/${user.uid}/tradeHistory/${bet.id}`] = historyEntry;
            activeTradeDeletions[`/users/${user.uid}/activeTrades/${bet.id}`] = null;
        }
        const finalUpdates = {...historyUpdates, ...activeTradeDeletions};
        await database.ref().update(finalUpdates);
        await updateUserDailyProfit(-totalLoss);
        showNotification(`Rule violation: All active trades lost. Account suspended.`, 'loss');
        setTimeout(() => auth.signOut(), 2000);
    }

    function updatePendingTradeTimers() {
        const liveCandle = getLiveCandleState(historicalData[historicalData.length-1]);
        if(!liveCandle) return;

        myActiveBets.forEach(bet => {
            const timerWrapper = document.getElementById(`timer-wrapper-${bet.id}`);
            const timerEl = document.getElementById(`timer-${bet.id}`);
            const progressCircle = document.getElementById(`progress-${bet.id}`);

            if (timerEl && progressCircle && timerWrapper) {
                const timeLeft = Math.max(0, (bet.expiryTimestamp - Date.now()) / 1000);
                const totalDuration = (bet.expiryTimestamp - bet.entryTimestamp) / 1000;
                const progress = 1 - (timeLeft / totalDuration);
                
                timerEl.textContent = formatTimeShort(Math.round(timeLeft));
                
                const circleLength = 2 * Math.PI * 26;
                progressCircle.style.strokeDashoffset = circleLength * (1 - progress);

                let isWinning = false;
                if (bet.direction === 'UP' && liveCandle.close > bet.openPrice) isWinning = true;
                if (bet.direction === 'DOWN' && liveCandle.close < bet.openPrice) isWinning = true;
                
                timerWrapper.classList.toggle('win', isWinning);
                timerWrapper.classList.toggle('loss', !isWinning);
            }
        });
    }
    
    function updateHistoryBadge() {
        const badge = document.querySelector('.nav-btn-new[data-view="history"]');
        if (!badge) return;
        const count = myActiveBets.length;
    }

    function renderTradeHistory() {
        let html = '';
        let lastDate = null;
        const sortedHistory = [...myActiveBets, ...tradeHistory].sort((a,b) => (b.timestamp || b.entryTimestamp) - (a.timestamp || a.entryTimestamp));
        if (sortedHistory.length === 0) { historyListContainer.innerHTML = '<p style="padding-top:20px;">You have no trade history yet.</p>'; return; }
        sortedHistory.forEach(entry => {
            const isPending = !!entry.entryTimestamp, entryTimestamp = entry.timestamp || entry.entryTimestamp, date = new Date(entryTimestamp), entryDate = date.toISOString().split('T')[0];
            if (entryDate !== lastDate) { html += `<div class="history-date-header">${entryDate}</div>`; lastDate = entryDate; }
            const directionIcon = entry.direction === 'UP' ? `<svg class="hi-investment-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M11 4h2v12.17l5.59-5.58L19.99 12l-8 8-8-8 1.41-1.41L11 16.17V4Z" transform="scale(1, -1) translate(0, -24)"/></svg>` : `<svg class="hi-investment-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M11 4h2v12.17l5.59-5.58L19.99 12l-8 8-8-8 1.41-1.41L11 16.17V4Z"/></svg>`;
            const directionColor = entry.direction === 'UP' ? 'var(--color-up)' : 'var(--color-down)';
            const formattedTime = date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            let resultHTML, detailsHTML = '';
            if (isPending) {
                resultHTML = `<div class="hi-result">
<div class="pending-trade-timer" id="timer-wrapper-${entry.id}">
    <svg class="progress-ring" width="60" height="60">
       <circle class="progress-ring__circle" stroke-width="4" fill="transparent" r="26" cx="30" cy="30" id="progress-${entry.id}"/>
    </svg>
    <span class="timer-text" id="timer-${entry.id}">00:00</span>
</div>
</div>`;
            } else {
                const resultClass = entry.result;
                let pnlText = (resultClass === 'win') ? `+${(entry.payout - entry.amount).toFixed(2)} USDT` : (resultClass === 'loss') ? `-${entry.amount.toFixed(2)} USDT` : `${entry.amount.toFixed(2)} USDT`;
                resultHTML = `<div class="hi-result"><span class="hi-pnl ${resultClass}">${pnlText}</span><span class="hi-time">${formattedTime}</span></div>`;
                const pointDiff = entry.closePrice - entry.openPrice, diffClass = pointDiff >= 0 ? 'win' : 'loss', diffText = `${pointDiff >= 0 ? '+' : ''}${pointDiff.toFixed(5)}`;
                detailsHTML = `<div class="history-item-details"><div class="hi-details-grid"><span class="label">Open Price</span><span class="value">${entry.openPrice.toFixed(5)}</span><span class="label">Close Price</span><span class="value">${entry.closePrice.toFixed(5)}</span><span class="label">Point Difference</span><span class="value ${diffClass}">${diffText}</span><span class="label">Trade Time</span><span class="value">${formattedTime}</span><span class="label">Date</span><span class="value">${date.toLocaleDateString()}</span><span class="label">Trade ID</span><span class="value">${entry.id.slice(-8).toUpperCase()}</span></div></div>`;
            }
            html += `<div class="history-item" data-id="${entry.id}"><div class="history-item-summary"><div class="hi-main-info"><div class="hi-market-info"><span class="star-icon"></span><span>${entry.market}</span><span class="payout">+${Math.abs(((entry.payoutRate || PAYOUT_RATE) - 1) * 100).toFixed(0)}%</span></div><div class="hi-investment"><span style="color: ${directionColor}">${directionIcon}</span><span>${entry.amount.toFixed(2)} USDT</span></div></div>${resultHTML}</div>${detailsHTML}</div>`;
        });
        historyListContainer.innerHTML = html;
    }

    function formatTimeShort(s) {const m=Math.floor(s/60),c=s%60;return `${String(m).padStart(2,'0')}:${String(c).padStart(2,'0')}`}
    function formatTimeLong(s) {const m=Math.floor(s/60); return `${m} min`; }

    function updateInvestmentDisplay() {
        amountDisplayNew.textContent = `USDT ${investmentAmount.toFixed(0)}`;

        const profit = investmentAmount * (PAYOUT_RATE - 1);
        payoutAmountNew.textContent = `+USDT ${Math.abs(profit).toFixed(2)}`;
        
        const sublabel = document.getElementById('amount-sublabel');
        if(sublabel) sublabel.textContent = `USDT ${investmentAmount.toFixed(0)}`;
    }
    
    function updateExpiryDisplay() {
        const now = new Date();
        const durationSublabel = document.getElementById('duration-sublabel');
        const fixedTimeModeLabel = document.querySelector('.controls-row-1 span:first-child');
        
        if (expirySettings.type === 'time') {
            const timeValueMinutes = expirySettings.value / 60;
            let displayTimeText = `${timeValueMinutes} min`;
            fixedTimeModeLabel.textContent = 'Fixed Time mode';
            
            const secondsInCurrentCandle = now.getSeconds() % 60;
            let tradeClosesIn;
            
            const candlesToWait = timeValueMinutes;
            if (secondsInCurrentCandle < 30) {
                tradeClosesIn = (60 - secondsInCurrentCandle) + (candlesToWait - 1) * 60;
            } else {
                 tradeClosesIn = (60 - secondsInCurrentCandle) + candlesToWait * 60;
            }

            betExpiryBtnNew.textContent = `${formatTimeShort(tradeClosesIn)}`;
            if(durationSublabel) durationSublabel.textContent = displayTimeText;

        } else {
            fixedTimeModeLabel.textContent = 'Timer';
            betExpiryBtnNew.textContent = formatTimeLong(expirySettings.value);
            if(durationSublabel) durationSublabel.textContent = formatTimeLong(expirySettings.value);
        }
    }

    function drawChartLoadingMessage(message) {
        if (!ctx || !canvas.width) return;
        ctx.clearRect(0, 0, canvasWidth, canvasHeight);
        ctx.fillStyle = 'var(--text-secondary)'; ctx.font = '14px Roboto'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
        ctx.fillText(message, canvasWidth / 2, canvasHeight / 2);
    }
    
    function drawActiveTradeTimer(bet, minPrice, maxPrice, chartDrawWidth, chartHeight) {
        const timeLeft = Math.max(0, (bet.expiryTimestamp - Date.now()) / 1000);
        if (timeLeft === 0) return;

        const price = (historicalData.length > 0) ? getLiveCandleState(historicalData[historicalData.length-1]).close : bet.openPrice;
        const y = ((maxPrice - price) / (maxPrice - minPrice)) * chartHeight;

        if (y < 0 || y > chartHeight) return;

        const timerText = formatTimeShort(Math.round(timeLeft));
        const icon = `<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.25 15.25L11 13.42V7h1.5v5.58l4.5 2.67l-.75 1z"></path></svg>`;

        const fullText = ` ${timerText}`;
        ctx.font = 'bold 11px Roboto';
        const textWidth = ctx.measureText(fullText).width + 22;
        const boxHeight = 20;

        let boxX = canvasWidth - RIGHT_PADDING - textWidth - 10;
        if(myActiveBets.length > 1) boxX -= 50;

        ctx.fillStyle = 'rgba(28, 31, 38, 0.9)';
        ctx.beginPath();
        ctx.roundRect(boxX, y - boxHeight / 2, textWidth, boxHeight, 4);
        ctx.fill();

        ctx.fillStyle = '#EAECEF';
        const parser = new DOMParser();
        const svgDoc = parser.parseFromString(icon, "image/svg+xml");
        const pathData = svgDoc.querySelector('path').getAttribute('d');
        const path2d = new Path2D(pathData);
        ctx.save();
        ctx.translate(boxX + 7, y - 6);
        ctx.fill(path2d);
        ctx.restore();
        
        ctx.fillStyle = '#EAECEF';
        ctx.textAlign = 'left';
        ctx.textBaseline = 'middle';
        ctx.fillText(timerText, boxX + 22, y);

        ctx.textAlign = 'right';
        ctx.textBaseline = 'alphabetic';
    }

            function drawChart(liveCandle){if(!ctx)return;const hasRSI=chartSettings.indicators.rsi.active;const mainChartHeight=hasRSI?canvasHeight-RSI_PANE_HEIGHT:canvasHeight;const chartDrawWidth=canvasWidth-RIGHT_PADDING;ctx.clearRect(0,0,canvasWidth,canvasHeight);const sliceEnd=displayedChartData.length-viewOffset;const sliceStart=Math.max(0,sliceEnd-visibleCandles);let vC=displayedChartData.slice(sliceStart,sliceEnd);if(viewOffset===0&&liveCandle){vC[vC.length-1]=liveCandle;}let minP=Infinity,maxP=-Infinity;vC.forEach(c=>{if(c){minP=Math.min(minP,c.low);maxP=Math.max(maxP,c.high);}});myActiveBets.forEach(b=>{if(b.market===currentMarket){minP=Math.min(minP,b.openPrice);maxP=Math.max(maxP,b.openPrice);}});const pR=maxP-minP||1;const centerPrice=minP+pR/2;const newPriceRange=pR*verticalZoomFactor;minP=centerPrice-newPriceRange/2;maxP=centerPrice+newPriceRange/2;const totalCandleSlots=vC.length+(viewOffset===0?FUTURE_SPACE_CANDLES:0);const cW=chartDrawWidth/totalCandleSlots;const cS=cW*0.2;drawGrid(minP,maxP,chartDrawWidth,vC,cW,mainChartHeight);vC.forEach((c,i)=>{if(c){const x=i*cW;const candleToDraw=(i===vC.length-1&&viewOffset===0)?liveCandle:c;drawCandle(candleToDraw,x,cW,cS,minP,maxP,mainChartHeight);}});if(chartSettings.indicators.sma.active){drawSMA(vC,sliceStart,cW,minP,maxP,mainChartHeight);}if(chartSettings.indicators.bollinger.active){drawBollingerBands(vC,sliceStart,cW,minP,maxP,mainChartHeight);}if(chartSettings.indicators.supportResistance.active){drawSupportResistance(vC,sliceStart,cW,minP,maxP,mainChartHeight);}if(hasRSI){drawRSIPane(vC,sliceStart,cW,mainChartHeight);}const betsOnCandle={};myActiveBets.filter(bet=>bet.market===currentMarket).forEach(bet=>{drawActiveTradeIndicator(bet,minP,maxP,chartDrawWidth,mainChartHeight);const candleIndexOnScreen=vC.findIndex(c=>c&&c.timestamp===bet.entryTimestamp);if(candleIndexOnScreen!==-1){if(!betsOnCandle[candleIndexOnScreen]){betsOnCandle[candleIndexOnScreen]=0;}const xOffsetIndex=betsOnCandle[candleIndexOnScreen];const xPos=candleIndexOnScreen*cW+(cW/2);drawFloatingBetInfo(bet,vC[candleIndexOnScreen],xPos,minP,maxP,xOffsetIndex,mainChartHeight);betsOnCandle[candleIndexOnScreen]++;}});if(liveCandle)drawCurrentPriceLine(liveCandle.close,minP,maxP,chartDrawWidth,mainChartHeight, cW, vC.length);if(viewOffset===0 && liveCandle){drawCandleEndTimer(liveCandle,minP,maxP,mainChartHeight, cW, vC.length);}}
    function resizeCanvas(){if(currentView !== 'chart' || !mainAppWrapper.style.display || mainAppWrapper.style.display === 'none') return; canvasWidth=canvas.clientWidth;canvasHeight=canvas.clientHeight;canvas.width=canvasWidth*devicePixelRatio;canvas.height=canvasHeight*devicePixelRatio;ctx.scale(devicePixelRatio,devicePixelRatio);}
    function drawCandle(c,x,w,s,minP,maxP,cH){const yO=((maxP-c.open)/(maxP-minP))*cH,yC=((maxP-c.close)/(maxP-minP))*cH,yH=((maxP-c.high)/(maxP-minP))*cH,yL=((maxP-c.low)/(maxP-minP))*cH;const color=c.close>=c.open?chartSettings.colors.up:chartSettings.colors.down;ctx.fillStyle=color;ctx.strokeStyle=color;ctx.lineWidth=1.8;ctx.beginPath();ctx.moveTo(x+w/2,yH);ctx.lineTo(x+w/2,yL);ctx.stroke();ctx.fillRect(x+s/2,Math.min(yO,yC),w-s,Math.max(1,Math.abs(yO-yC)));}
    
    function getDynamicGridInterval(visibleCandles) {
        if (visibleCandles > 80) return 30 * 60 * 1000;
        if (visibleCandles > 50) return 15 * 60 * 1000;
        if (visibleCandles > 30) return 10 * 60 * 1000;
        if (visibleCandles > 15) return 5 * 60 * 1000;
        return 2 * 60 * 1000;
    }

    function drawGrid(minP, maxP, chartDrawWidth, visibleCandlesData, candleWidth, cH) {
        const opacity = chartSettings.grid.visibility / 8;
        if (opacity <= 0.125) return; 
        
        const gridColor = `rgba(112, 122, 138, ${0.1 * opacity})`;
        const priceGridLines = 6;
        ctx.strokeStyle = gridColor;
        ctx.fillStyle = COLOR_GRID_TEXT;
        ctx.font = '10px Roboto';
        ctx.textAlign = 'right';
        ctx.textBaseline = 'alphabetic';
        for (let i = 0; i <= priceGridLines; i++) {
            const y = (i / priceGridLines) * cH;
            const p = maxP - (i / priceGridLines) * (maxP - minP);
            ctx.beginPath();
            ctx.moveTo(0, y);
            ctx.lineTo(canvasWidth, y);
            ctx.stroke();
            if (y < cH - 15 && y > 10) {
                ctx.fillText(p.toFixed(5), canvasWidth - 5, y - 4);
            }
        }
        
        ctx.strokeStyle = `rgba(112, 122, 138, ${0.1 * opacity})`;
        ctx.fillStyle = COLOR_GRID_TEXT;
        ctx.textAlign = 'center';
        const timeInterval = getDynamicGridInterval(visibleCandlesData.length);
        let lastDrawnTime = -Infinity;

        visibleCandlesData.forEach((candle, i) => {
            if (!candle) return;
            const userDate = new Date(candle.timestamp + (userTimezoneOffset * 3600000));
            
            let showTime = userDate.getTime() % timeInterval < (chartTimeframe * 1000);
            
            const x = i * candleWidth + (candleWidth / 2);
            if (showTime && x > lastDrawnTime + (candleWidth * 3) && x < chartDrawWidth) { // Prevent overlap
                lastDrawnTime = x;
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvasHeight - 15);
                ctx.stroke();
                
                const hours = String(userDate.getUTCHours()).padStart(2, '0');
                const minutes = String(userDate.getUTCMinutes()).padStart(2, '0');
                const timeText = `${hours}:${minutes}`;
                
                ctx.textBaseline = 'bottom';
                ctx.fillText(timeText, x, canvasHeight - 2);
            }
        });
        ctx.textAlign = 'right';
        ctx.textBaseline = 'alphabetic';
    }
    
    function drawCurrentPriceLine(p, minP, maxP, chartDrawWidth, cH, candleWidth, numCandlesOnScreen) {
        const y = ((maxP - p) / (maxP - minP)) * cH;
        if (y < 0 || y > cH) return;

        const xPos = (numCandlesOnScreen - 1) * candleWidth + (candleWidth / 2);
        
        if (pulseAnimation.opacity > 0) {
            ctx.beginPath();
            ctx.arc(xPos, y, pulseAnimation.radius, 0, 2 * Math.PI);
            ctx.fillStyle = `rgba(255, 255, 255, ${pulseAnimation.opacity * 0.25})`;
            ctx.fill();
        }

        ctx.strokeStyle = 'rgba(255, 255, 255, 0.8)';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(xPos, y);
        ctx.lineTo(chartDrawWidth, y);
        ctx.stroke();

        ctx.save();
        ctx.translate(xPos, y);
        ctx.rotate(Math.PI / 4);
        ctx.fillStyle = 'white';
        const diamondSize = 2;
        ctx.fillRect(-diamondSize, -diamondSize, diamondSize * 2, diamondSize * 2);
        ctx.restore();
        
        const priceText = p.toFixed(5);
        ctx.font = 'bold 11px Roboto';
        const textMetrics = ctx.measureText(priceText);
        const tagWidth = textMetrics.width + 16;
        const tagHeight = 22;
        const tagX = canvasWidth - tagWidth - 2;
        const tagY = y - tagHeight / 2;
        const color = (historicalData.length > 1 && p >= historicalData[historicalData.length-2].close) ? chartSettings.colors.up : chartSettings.colors.down;
        ctx.fillStyle = color;
        ctx.beginPath();
        ctx.roundRect(tagX, tagY, tagWidth, tagHeight, tagHeight / 2);
        ctx.fill();
        
        ctx.fillStyle = '#101215';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(priceText, tagX + tagWidth / 2, y);
        
        ctx.textAlign = 'right';
        ctx.textBaseline = 'alphabetic';
    }

            function drawCandleEndTimer(candle, minP, maxP, cH, candleWidth, numCandlesOnScreen) {
        const now = Date.now();
        const candleStartTime = Math.floor(now / (chartTimeframe * 1000)) * (chartTimeframe * 1000);
        const timeLeft = Math.max(0, Math.round((candleStartTime + (chartTimeframe * 1000) - now) / 1000));

        if (timeLeft < 0 || timeLeft > chartTimeframe) return;

        const text = formatTimeShort(timeLeft);
        const yPos = ((maxP - candle.close) / (maxP - minP)) * cH;
        const xPos = (numCandlesOnScreen - 1) * candleWidth + (candleWidth / 2);
        
        ctx.font = 'bold 10px Roboto';
        const textWidth = ctx.measureText(text).width + 10;
        const boxHeight = 18;
        let boxX = xPos + 15; // Increased distance from candle
        
        ctx.fillStyle = 'rgba(28, 31, 38, 0.9)';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        
        ctx.beginPath();
        ctx.roundRect(boxX, yPos - boxHeight / 2, textWidth, boxHeight, 6);
        ctx.fill();
        
        ctx.fillStyle = '#EAECEF';
        ctx.fillText(text, boxX + textWidth / 2, yPos);
        
        ctx.textAlign = 'right';
        ctx.textBaseline = 'alphabetic';
    }
    
    function drawActiveTradeIndicator(bet,minP,maxP,chartDrawWidth,cH){const y=((maxP-bet.openPrice)/(maxP-minP))*cH;if(y<0||y>cH)return;const color=bet.direction==='UP'?chartSettings.colors.up:chartSettings.colors.down;ctx.setLineDash([3,5]);ctx.strokeStyle=color;ctx.lineWidth=1.5;ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(canvasWidth,y);ctx.stroke();ctx.setLineDash([]);const priceText=bet.openPrice.toFixed(5);ctx.font='bold 10px Roboto';const tagHeight=18;const tagWidth=ctx.measureText(priceText).width+10;ctx.fillStyle=color;ctx.fillRect(0,y-tagHeight/2,tagWidth,tagHeight);ctx.fillStyle='#101215';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(priceText,tagWidth/2,y);ctx.textAlign='right';ctx.textBaseline='alphabetic';}
    function drawFloatingBetInfo(bet,candle,candleCenterX,minP,maxP,xOffsetIndex=0,cH){if(!candle)return;const color=bet.direction==='UP'?chartSettings.colors.up:chartSettings.colors.down;const tagHeight=32;let yPos=((maxP-candle.high)/(maxP-minP))*cH-20;const amountText=`$${bet.amount.toFixed(2)}`;const timeLeft=Math.max(0,Math.round((bet.expiryTimestamp-Date.now())/1000));const timerText=formatTimeShort(timeLeft);ctx.font='10px Roboto';const infoTagWidth=Math.max(ctx.measureText(amountText).width,ctx.measureText(timerText).width)+20;const horizontalOffset=xOffsetIndex*(infoTagWidth+5);const startX=(candleCenterX-infoTagWidth/2)+horizontalOffset;if(ctx.roundRect){ctx.beginPath();ctx.roundRect(startX,yPos-tagHeight/2,infoTagWidth,tagHeight,4);ctx.fillStyle=color;ctx.fill();}else{ctx.fillStyle=color;ctx.fillRect(startX,yPos-tagHeight/2,infoTagWidth,tagHeight);}
ctx.fillStyle='#101215';ctx.textAlign='center';ctx.textBaseline='middle';ctx.font='bold 10px Roboto';ctx.fillText(amountText,startX+infoTagWidth/2,yPos-7);ctx.font='10px Roboto';ctx.fillText(timerText,startX+infoTagWidth/2,yPos+7);ctx.textAlign='right';ctx.textBaseline='alphabetic';}
    
    function updateSentimentBar() {
         if (sentimentInterval) clearInterval(sentimentInterval);
         const update = () => {
            const seed = (currentMarket || 'default').hashCode() + Date.now() / 10000;
            const downPercent = 45 + seededRandom(seed) * 10; // Range 45% - 55%
            const upPercent = 100 - downPercent;
            sentimentDown.style.height = `${downPercent}%`;
            sentimentUp.style.height = `${upPercent}%`;
            sentimentPercentDown.textContent = `${Math.round(downPercent)}%`;
            sentimentPercentUp.textContent = `${Math.round(upPercent)}%`;
         }
         update();
         sentimentInterval = setInterval(update, 3000);
    }
    
    async function generateAndSaveInitialData() {
        chartLoaderOverlay.style.display = 'flex';
        const now = Date.now();
        const currentPeriodStart = Math.floor(now / (BASE_TIMEFRAME * 1000)) * (BASE_TIMEFRAME * 1000);
        let lastClose = null;
        const initialCandles = [];
        // MODIFICATION: Load fewer candles initially
        const totalCandlesToGenerate = 10; 
        for (let i = totalCandlesToGenerate; i > 0; i--) {
            const timestamp = currentPeriodStart - (i * BASE_TIMEFRAME * 1000);
            const candle = await generateCandleData(timestamp, BASE_TIMEFRAME, lastClose);
            initialCandles.push(candle);
            lastClose = candle.close;
        }
        historicalData = initialCandles.map(c => createCandleWithPath(c));
        
        const marketId = localStorage.getItem('lastMarketId');
        marketDataCache[marketId] = historicalData.slice();
        
        aggregateDataForDisplay();
        
        if(animationFrameId) cancelAnimationFrame(animationFrameId);
        animationFrameId = requestAnimationFrame(gameLoop);
        resizeCanvas();
        chartLoaderOverlay.style.display = 'none';
        const updates = {};
        initialCandles.forEach(candle => { const { path, ...candleToSave } = candle; updates[candle.timestamp] = candleToSave; });
        try {
            await candlesRef.update(updates);
            console.log("Initial market data seeded successfully.");
            listenForNewCandles();
            setTimeout(loadMoreHistoricalDataInBackground, 1000);
        } catch (error) { console.error("Failed to seed initial market data:", error); }
    }
    
    function loadChartDataForMarket(marketId) {
        chartLoaderOverlay.style.display = 'flex';
        const newMarket = availableMarkets[marketId];
        
        if (newMarket.type === 'real') {
            initializeRealMarketChart(newMarket.apiSymbol);
            return;
        }

        if (candlesRef) candlesRef.off();
        historicalData = []; viewOffset = 0; panDragDistance = 0;
        marketState = { volatility: 1.0, momentum: 0.0 };
        
        const marketPath = marketId.replace(/[\.\/]/g, '-').replace(/\s+/g, '-').toLowerCase();
        candlesRef = database.ref(`markets/${marketPath}/candles/${BASE_TIMEFRAME}s`);
        
        // MODIFICATION: Load fewer candles initially
        candlesRef.orderByKey().limitToLast(10).once('value', snapshot => {
            if (snapshot.exists()) {
                const data = snapshot.val();
                historicalData = Object.values(data).sort((a, b) => a.timestamp - b.timestamp).map(c => createCandleWithPath(c));
                
                aggregateDataForDisplay();
                if(animationFrameId) cancelAnimationFrame(animationFrameId);
                animationFrameId = requestAnimationFrame(gameLoop);
                resizeCanvas(); 
                chartLoaderOverlay.style.display = 'none'; 
                listenForNewCandles();
                forceChartSync();
                
                setTimeout(async () => {
                    const fullSnapshot = await candlesRef.orderByKey().limitToLast(200).once('value');
                    if (fullSnapshot.exists()) {
                         const fullData = fullSnapshot.val();
                         historicalData = Object.values(fullData).sort((a, b) => a.timestamp - b.timestamp).map(c => createCandleWithPath(c));
                         marketDataCache[marketId] = historicalData.slice();
                         aggregateDataForDisplay();
                    }
                }, 500);

            } else { 
                generateAndSaveInitialData();
            }
        }).catch(error => {
            console.error("Fast chart data fetch failed:", error);
            drawChartLoadingMessage("Could not connect to the server.");
            chartLoaderOverlay.style.display = 'none';
        });
    }


    function initializeChartData() {
        if (currentMarketType === 'real') return;
        if (candlesRef) candlesRef.off();
        historicalData = []; viewOffset = 0; panDragDistance = 0;
        marketState = { volatility: 1.0, momentum: 0.0 };
        const marketId = localStorage.getItem('lastMarketId') || '';
        const marketPath = marketId.replace(/[\.\/]/g, '-').replace(/\s+/g, '-').toLowerCase();
        candlesRef = database.ref(`markets/${marketPath}/candles/${BASE_TIMEFRAME}s`);
        
        candlesRef.orderByKey().limitToLast(10).once('value', snapshot => {
            if (snapshot.exists()) {
                const data = snapshot.val();
                historicalData = Object.values(data).sort((a, b) => a.timestamp - b.timestamp).map(c => createCandleWithPath(c));
                
                marketDataCache[marketId] = historicalData.slice();
                aggregateDataForDisplay();
                
                if(animationFrameId) cancelAnimationFrame(animationFrameId);
                animationFrameId = requestAnimationFrame(gameLoop);
                resizeCanvas(); 
                chartLoaderOverlay.style.display = 'none'; 
                listenForNewCandles();
                forceChartSync();
                
                setTimeout(async () => {
                    const fullSnapshot = await candlesRef.orderByKey().limitToLast(200).once('value');
                    if (fullSnapshot.exists()) {
                         const fullData = fullSnapshot.val();
                         historicalData = Object.values(fullData).sort((a, b) => a.timestamp - b.timestamp).map(c => createCandleWithPath(c));
                         marketDataCache[marketId] = historicalData.slice();
                         aggregateDataForDisplay();
                    }
                }, 500);

            } else { generateAndSaveInitialData(); }
        }).catch(error => {
            console.error("Initial chart data fetch failed:", error);
            showNotification("Error loading chart.", 'loss');
            drawChartLoadingMessage("Could not connect to the server.");
            chartLoaderOverlay.style.display = 'none';
        });
    }
    
    function initializeRealMarketChart(apiSymbol) {
        if (candleSchedulerInterval) clearInterval(candleSchedulerInterval);
        if (chartSyncSafetyNet) clearInterval(chartSyncSafetyNet);
        historicalData = [];
        
        const urlFast = `https://api.binance.com/api/v3/klines?symbol=${apiSymbol.toUpperCase()}&interval=1m&limit=20`;
        fetch(urlFast)
            .then(res => res.json())
            .then(data => {
                historicalData = data.map(kline => ({ timestamp: kline[0], open: parseFloat(kline[1]), high: parseFloat(kline[2]), low: parseFloat(kline[3]), close: parseFloat(kline[4]), path: [parseFloat(kline[1]), parseFloat(kline[4])] }));
                aggregateDataForDisplay();
                chartLoaderOverlay.style.display = 'none';
                if(animationFrameId) cancelAnimationFrame(animationFrameId);
                animationFrameId = requestAnimationFrame(gameLoop);
                connectToBinanceSocket(apiSymbol);

                 setTimeout(() => {
                    fetch(`https://api.binance.com/api/v3/klines?symbol=${apiSymbol.toUpperCase()}&interval=1m&limit=200`)
                    .then(res => res.json()).then(fullData => {
                        historicalData = fullData.map(kline => ({ timestamp: kline[0], open: parseFloat(kline[1]), high: parseFloat(kline[2]), low: parseFloat(kline[3]), close: parseFloat(kline[4]), path: [parseFloat(kline[1]), parseFloat(kline[4])] }));
                        const marketId = localStorage.getItem('lastMarketId');
                        marketDataCache[marketId] = historicalData.slice();
                        aggregateDataForDisplay();
                    });
                 }, 500);

            })
            .catch(err => {
                console.error("Failed to load historical data from Binance:", err);
                showNotification("Failed to load real market data.", 'loss');
                chartLoaderOverlay.style.display = 'none';
            });
    }

    function connectToBinanceSocket(apiSymbol) {
        if (binanceSocket) { binanceSocket.close(); }
        const socketUrl = `wss://stream.binance.com:9443/ws/${apiSymbol.toLowerCase()}@kline_1m`;
        binanceSocket = new WebSocket(socketUrl);
        binanceSocket.onmessage = (event) => {
            if(currentMarketType !== 'real') return;
            const message = JSON.parse(event.data), kline = message.k;
            const newCandleData = { timestamp: kline.t, open: parseFloat(kline.o), high: parseFloat(kline.h), low: parseFloat(kline.l), close: parseFloat(kline.c), path: [parseFloat(kline.o), parseFloat(kline.c)] };
            if (historicalData.length > 0 && historicalData[historicalData.length - 1].timestamp === newCandleData.timestamp) {
                historicalData[historicalData.length - 1] = newCandleData;
            } else {
                historicalData.push(newCandleData);
                if (historicalData.length > MAX_STORED_CANDLES) { historicalData.shift(); }
            }
             const marketId = localStorage.getItem('lastMarketId');
             marketDataCache[marketId] = historicalData.slice();
             aggregateDataForDisplay();
        };
        binanceSocket.onerror = (error) => { console.error("Binance WebSocket Error:", error); showNotification("Real-time connection lost.", 'loss'); };
    }
    
    function listenForNewCandles() {
        if (currentMarketType === 'real' || !candlesRef) return;
        const lastKnownTimestamp = historicalData.length > 0 ? historicalData[historicalData.length - 1].timestamp : 0;
        candlesRef.orderByKey().startAt(String(lastKnownTimestamp + 1)).on('child_added', snapshot => {
            const newCandle = snapshot.val();
            if (historicalData.every(c => c.timestamp !== newCandle.timestamp)) {
                const finalizedCandle = createCandleWithPath(newCandle);
                if (historicalData.length > 0) { const prevCandle = historicalData[historicalData.length - 1]; }
                historicalData.push(finalizedCandle);
                if (historicalData.length > MAX_STORED_CANDLES) { historicalData.shift(); }

                const marketId = localStorage.getItem('lastMarketId');
                marketDataCache[marketId] = historicalData.slice();
                aggregateDataForDisplay();
            }
        });
    }
    
    async function forceChartSync() {
        if (isSyncing || !candlesRef || currentMarketType === 'real') return;
        isSyncing = true;
        const now = Date.now();
        const lastLocalCandle = historicalData.length > 0 ? historicalData[historicalData.length - 1] : null;
        const lastTimestamp = lastLocalCandle ? lastLocalCandle.timestamp : 0;
        const currentPeriodStart = Math.floor(now / (BASE_TIMEFRAME * 1000)) * (BASE_TIMEFRAME * 1000);
        const timeDifference = currentPeriodStart - lastTimestamp;
        try {
            if (timeDifference >= BASE_TIMEFRAME * 1000) {
                const missingPeriods = Math.floor(timeDifference / (BASE_TIMEFRAME * 1000));
                let nextTimestamp = lastTimestamp + (BASE_TIMEFRAME * 1000);
                let lastClose = lastLocalCandle ? lastLocalCandle.close : null;
                for (let i = 0; i < missingPeriods; i++) {
                    let newCandle = (nextCandleData && nextCandleData.timestamp === nextTimestamp) ? createCandleWithPath(nextCandleData) : createCandleWithPath(await generateCandleData(nextTimestamp, BASE_TIMEFRAME, lastClose));
                    nextCandleData = null;
                    if (historicalData.every(c => c.timestamp !== newCandle.timestamp)) {
                        historicalData.push(newCandle);
                        if (historicalData.length > MAX_STORED_CANDLES) { historicalData.shift(); }
                    }
                    saveCandleToFirebase(newCandle);
                    lastClose = newCandle.close;
                    nextTimestamp += (BASE_TIMEFRAME * 1000);
                }
                 const marketId = localStorage.getItem('lastMarketId');
                 marketDataCache[marketId] = historicalData.slice();
                 aggregateDataForDisplay();
            }
        } catch (error) { console.error("Chart Sync Error:", error); } 
        finally { isSyncing = false; }
    }

    async function scheduleNextCandleGeneration() {
        if (currentMarketType === 'real' || historicalData.length === 0 || !isAppInitialized) return;
        const now = new Date(), seconds = now.getSeconds();
        const lastCandle = historicalData[historicalData.length - 1];
        if (!lastCandle) return;
        const nextCandleTimestamp = lastCandle.timestamp + BASE_TIMEFRAME * 1000;
        if (seconds >= PRE_CALC_SECONDS && (!nextCandleData || nextCandleData.timestamp < nextCandleTimestamp)) {
            const prevClose = lastCandle.close;
            nextCandleData = await generateCandleData(nextCandleTimestamp, BASE_TIMEFRAME, prevClose);
        }
    }
    
    function getPinchDistance(touches) { const dx = touches[0].clientX - touches[1].clientX; const dy = touches[0].clientY - touches[1].clientY; return Math.sqrt(dx * dx + dy * dy); }
    function handlePointerDown(e) { e.preventDefault(); if (e.touches && e.touches.length === 2) { isPinching = true; isPanning = false; isScaling = false; initialPinchDistance = getPinchDistance(e.touches); return; } const rect = canvas.getBoundingClientRect(); const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left; const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top; if (x > canvas.clientWidth - RIGHT_PADDING) { isScaling = true; scaleStartY = y; canvas.style.cursor = 'ns-resize'; } else { isPanning = true; panStartX = x; canvas.style.cursor = 'grabbing'; notificationContainer.style.opacity = '0'; } }
    function handlePointerUp() { isPanning = false; isScaling = false; isPinching = false; canvas.style.cursor = 'grab'; notificationContainer.style.opacity = '1'; }
    
    function handlePointerMove(e) {
        e.preventDefault();
        if (isPinching && e.touches && e.touches.length === 2) {
            const currentPinchDistance = getPinchDistance(e.touches);
            if (initialPinchDistance > 0) {
                const zoomRatio = currentPinchDistance / initialPinchDistance;
                verticalZoomFactor /= zoomRatio; verticalZoomFactor = Math.max(0.2, Math.min(verticalZoomFactor, 5.0));
                visibleCandles /= zoomRatio;
                visibleCandles = Math.round(Math.max(5, Math.min(visibleCandles, 50)));
                initialPinchDistance = currentPinchDistance;
            } return;
        }
        if (isPinching) return;
        const rect = canvas.getBoundingClientRect(); const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left; const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
        if(isScaling) { const deltaY = y - scaleStartY; const zoomSensitivity = 0.005; verticalZoomFactor += deltaY * zoomSensitivity; verticalZoomFactor = Math.max(0.2, Math.min(verticalZoomFactor, 5.0)); scaleStartY = y; }
        if (isPanning) {
            const deltaX = x - panStartX; panDragDistance += deltaX; panStartX = x; const candleWidthOnScreen = (canvas.clientWidth - RIGHT_PADDING) / visibleCandles;
            if (Math.abs(panDragDistance) >= candleWidthOnScreen) {
                const candleShift = Math.floor(panDragDistance / candleWidthOnScreen);
                viewOffset = Math.max(0, Math.min(viewOffset - candleShift, displayedChartData.length - visibleCandles)); panDragDistance = 0;
            }
            gotoLiveBtn.classList.toggle('visible', viewOffset > 0);
        }
    }
    
    function updateBalance() {
        headerBalanceAmountEl.textContent = isBalanceVisible ? `${balance.toFixed(2)} USDT` : '****** USDT';
        const eyeOpen = document.getElementById('balance-eye-open');
        const eyeClosed = document.getElementById('balance-eye-closed');
        if(eyeOpen && eyeClosed) {
            eyeOpen.style.display = isBalanceVisible ? 'block' : 'none';
            eyeClosed.style.display = isBalanceVisible ? 'none' : 'block';
        }
    }
    
    const paymentMethods = [
        { id: 'bkash', name: 'Bkash', status: 'maintenance', logo: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSZ1N3CouoCkuDUTEq1uLnlF6hKH2E1KQ6kZ1R6YbS-p8qI9LQU99Edk3pY&s=10', details: { type: 'manual', number: '01700000000', instructions: 'Please use the "Send Money" option and enter the exact BDT amount shown.' } },
        { id: 'nagad', name: 'Nagad', status: 'active', logo: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQovGX4BWR7KQrVAOJxjQPR6ZtvAY4dLmbC8VOaj-IXlAKSLTB-u3tvKMW_&s=10', details: { type: 'manual', number: '01752067094', instructions: 'Please use the "Send Money" option and enter the exact BDT amount shown.' } },
        { id: 'gpay', name: 'G Pay', status: 'coming-soon', logo: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQH6zlma32FMWqNOAnJJbAv3aSKGTUibNSdMF8YFA1KXQ&s' },
        { id: 'binance', name: 'Binance Pay', status: 'active', logo: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTjNWYzZgpl7EWZL2cxbIJUbwZ_XZbhM7oJohmP4oN9vRmMWnZCBBnZiZo&s=10', details: { type: 'qr', qr_image: 'https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/IMG_20250718_222220.png?alt=media&token=cc232bd1-b83e-4945-94b6-074ad4ce17c2', pay_id: '505820464', instructions: 'Scan the QR code with your Binance App or use the Pay ID. Send the exact USD amount.' } },
        { id: 'tether', name: 'USDT (TRC20)', status: 'active', logo: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRQRSJGSSrXoszL7c7QGzKWfXLn3UPQFMAvqfFaiq8xK9-OjDx1MOhJlug&s=10', details: { type: 'address', qr_image: 'https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/IMG_20250719_075955.jpg?alt=media&token=54b586b0-854d-41ac-86ac-dcf4120896ef', address: 'TRWZqTgWSVeBXMPEkhSzcqXyfsnuWW3o6t', instructions: 'Only send USDT on the TRC20 network to this address. Ensure you cover any network fees.' } },
        { id: 'telegram_pay', name: 'Telegram Pay', status: 'active', logo: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTJOISwXgNAD-GnWiVJ6gbGO_eeAEUhYrWFcOrykD-At-3UxY_V31hU_P0&s=10', link: 'https://t.me/ictextelepay_bot' }
    ];
    
    function updatePromoBonusDisplay() { const amount = parseFloat(depositAmountInputNew.value) || 0; if (currentDepositData.promo && amount > 0) { const promo = currentDepositData.promo; if (amount >= promo.minDeposit) { let bonus = amount * (promo.bonusPercentage / 100); if (promo.maxBonus) { bonus = Math.min(bonus, promo.maxBonus); } const total = amount + bonus; promoCalculationDisplay.innerHTML = `Bonus: <span style="color:var(--color-up)">${bonus.toFixed(2)} USD</span> | Total to Receive: <span style="color:var(--color-up)">${total.toFixed(2)} USD</span>`; promoCalculationDisplay.style.display = 'block'; } else { promoCalculationDisplay.style.display = 'none'; } } else { promoCalculationDisplay.style.display = 'none'; } validateDepositNextButton(); }
    function updatePayableAmount() { const amountUSD = parseFloat(depositAmountInputNew.value); quickAmountButtonsNew.forEach(b => { b.classList.toggle('active', b.dataset.amount === depositAmountInputNew.value); }); updatePromoBonusDisplay(); }
    function initNewDepositPage() { depositAmountInputNew.value = ''; promoCodeInput.value = ''; promoCodeInput.disabled = false; applyPromoBtn.disabled = false; applyPromoBtn.textContent = 'Apply'; promoFeedbackEl.className = 'promo-feedback'; promoFeedbackText.textContent = ''; promoCalculationDisplay.style.display = 'none'; quickAmountButtonsNew.forEach(b => b.classList.remove('active')); updatePayableAmount(); currentDepositData = {}; }
    
    function validateDepositNextButton() {
        const amount = parseFloat(depositAmountInputNew.value);
        let isValid = false;
        if (!isNaN(amount) && amount >= MIN_DEPOSIT_USD) {
            if (currentDepositData.promo) { isValid = (amount >= currentDepositData.promo.minDeposit);
            } else { isValid = true; }
        }
        depositNextBtnNew.disabled = !isValid;
    }

    function handleNewDepositNext() { 
        const amount = parseFloat(depositAmountInputNew.value);
        if (depositNextBtnNew.disabled) {
            if(currentDepositData.promo) { showNotification(`Minimum deposit for this bonus is ${currentDepositData.promo.minDeposit} USD.`, 'loss'); } 
            else { showNotification(`Minimum deposit is ${MIN_DEPOSIT_USD} USD.`, 'loss'); }
            return; 
        }
        currentDepositData.amountUSD = amount; currentDepositData.amountBDT = amount * DEPOSIT_RATE_BDT; currentDepositData.invoiceId = 'GD' + Date.now().toString().slice(-8).toUpperCase(); renderNewPaymentMethods(); showView('deposit-methods'); 
    }
    
    function renderNewPaymentMethods() {
        paymentMethodGrid.innerHTML = paymentMethods.map(m => {
            const isUnavailable = m.status !== 'active';
            const statusClass = isUnavailable ? m.status.replace('_', '-') : '';
            const baseClass = `payment-method-item ${statusClass}`;
            const content = `${isUnavailable ? `<div class="pm-status-badge pm-status-${statusClass}">${m.status.replace('_',' ')}</div>` : ''}<img src="${m.logo}" alt="${m.name}"><span>${m.name}</span>`;
            if (m.link) { return `<a href="${m.link}" target="_blank" class="${baseClass}">${content}</a>`; }
            return `<div class="${baseClass}" data-method-id="${m.id}" ${isUnavailable ? 'aria-disabled="true"' : ''}>${content}</div>`;
        }).join('');
        paymentMethodGrid.querySelectorAll('.payment-method-item:not(a):not([aria-disabled="true"])').forEach(item => {
            item.addEventListener('click', (e) => {
                const methodId = e.currentTarget.dataset.methodId;
                const selectedMethod = paymentMethods.find(m => m.id === methodId);
                currentDepositData.method = selectedMethod;
                renderNewPaymentDetailsPage(selectedMethod);
                showView('payment-details');
            });
        });
    }

    function createPaymentInfoRow(label, value, copyText) { return ` <div class="payment-address-row-new"> <div class="address-labels-new"> <span>${label}</span> </div> <div class="address-value-wrapper-new"> <span class="address-text-new">${value}</span> <button class="copy-button-new" data-copy-text="${copyText || value}"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg> </button> </div> </div>`; }
    
    function renderNewPaymentDetailsPage(method) {
        stopDepositTimer();
        const isBangladeshiMethod = ['bkash', 'nagad', 'rocket'].includes(method.id);
        let paymentInfoHTML = `<div class="deposit-timer-card"><div class="timer-label">Session expires in</div><div id="deposit-timer-display">${formatTimeShort(DEPOSIT_SESSION_SECONDS)}</div></div>`;
        if (method.details.instructions) { paymentInfoHTML += `<div class="payment-instructions-card">${method.details.instructions}</div>`; }
        let detailsCardHTML = `<div class="payment-details-card"><div class="payment-details-row"><span class="label">Invoice ID:</span><span class="value">${currentDepositData.invoiceId}</span></div><div class="payment-details-row"><span class="label">Amount (USD):</span><span class="value">${currentDepositData.amountUSD.toFixed(2)} USD</span></div>`;
        if (isBangladeshiMethod) { detailsCardHTML += `<div class="payment-details-row"><span class="label">Payable Amount:</span><span class="value highlight">${currentDepositData.amountBDT.toFixed(2)}</span></div>`; }
        detailsCardHTML += `</div>`;
        paymentInfoHTML += detailsCardHTML;
        if (method.details.qr_image) { paymentInfoHTML += `<img src="${method.details.qr_image}" alt="${method.name} QR Code" class="deposit-qr-code">`; }
        if (method.details.number) { paymentInfoHTML += createPaymentInfoRow(`${method.name} Number`, method.details.number); }
        if (method.details.pay_id) { paymentInfoHTML += createPaymentInfoRow(`${method.name} Pay ID`, method.details.pay_id); }
        if (method.details.address) { paymentInfoHTML += createPaymentInfoRow(`USDT (TRC20) Address`, method.details.address); }
        paymentInfoHTML += ` <form id="payment-proof-form-new" class="page-form" style="margin-top:20px;"> <div class="deposit-card-new" style="background-color: transparent; border: none; padding: 0; box-shadow: none;"> <h3>Submit Proof</h3> <div class="form-input-group"> <input type="text" id="deposit-tx-id-new" class="form-input" placeholder="Enter Transaction ID (Required)"> </div> <div class="form-input-group" style="margin-top:15px;"> <label for="deposit-screenshot-new" class="proof-upload-label"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg> <span>Upload Payment Screenshot</span> <span id="deposit-screenshot-name-new" class="file-name">No file chosen</span> </label> <input type="file" id="deposit-screenshot-new" accept="image/*"> </div> <p style="font-size: 0.8rem; color: var(--text-secondary); text-align: center; margin-top: 10px;">Please provide a Transaction ID or a Screenshot.</p> </div> <button type="submit" id="payment-submit-btn-new">I Have Paid, Submit</button> </form>`;
        paymentDetailsContentNew.innerHTML = paymentInfoHTML;
        paymentDetailsContentNew.querySelectorAll('.copy-button-new').forEach(btn => btn.addEventListener('click', (e) => { e.preventDefault(); const textToCopy = e.currentTarget.dataset.copyText; navigator.clipboard.writeText(textToCopy).then(() => showNotification('Copied to clipboard!', 'info')); }));
        document.getElementById('deposit-screenshot-new').addEventListener('change', (e) => { document.getElementById('deposit-screenshot-name-new').textContent = e.target.files[0]?.name || 'No file chosen'; });
        document.getElementById('payment-proof-form-new').addEventListener('submit', handleNewProofSubmission);
    }

    async function handleNewProofSubmission(e) {
        e.preventDefault(); stopDepositTimer(); const submitBtn = document.getElementById('payment-submit-btn-new'); submitBtn.disabled = true; submitBtn.textContent = 'Submitting...'; const txId = document.getElementById('deposit-tx-id-new').value.trim(); const screenshotFile = document.getElementById('deposit-screenshot-new').files[0]; if (!txId && !screenshotFile) { showNotification('Please provide Transaction ID or Screenshot.', 'loss'); submitBtn.disabled = false; submitBtn.textContent = 'I Have Paid, Submit'; return; } let screenshotUrl = null;
        try {
            if (screenshotFile) { showNotification('Uploading screenshot...', 'info'); const storageRef = storage.ref(`deposit-proofs/${auth.currentUser.uid}/${Date.now()}_${screenshotFile.name}`); const snapshot = await storageRef.put(screenshotFile); screenshotUrl = await snapshot.ref.getDownloadURL(); }
            const depositRequest = { userId: auth.currentUser.uid, userName: currentUserData.name, userEmail: currentUserData.email, invoiceId: currentDepositData.invoiceId, amountUSD: currentDepositData.amountUSD, method: currentDepositData.method.name, txId: txId || null, screenshotUrl: screenshotUrl || null, promoCode: currentDepositData.promoCode || null, status: 'pending', timestamp: firebase.database.ServerValue.TIMESTAMP };
                            await database.ref('deposit_requests').push(depositRequest); 
            const newTransaction = { id: currentDepositData.invoiceId, timestamp: Date.now(), status: 'pending', amount: currentDepositData.amountUSD, method: currentDepositData.method.name, type: 'deposit', };
            if (auth.currentUser) { await database.ref(`users/${auth.currentUser.uid}/transactions/${newTransaction.id}`).set(newTransaction); }

            const tgMessage = `
New Deposit Submitted!
-------------------------
User: ${currentUserData.name} (${currentUserData.numericId})
Amount: ${currentDepositData.amountUSD.toFixed(2)} USD
Method: ${currentDepositData.method.name}
-------------------------
Please check the admin panel to approve.
            `;
            await sendTelegramNotification(tgMessage);
            
            showNotification('Deposit proof submitted for review!', 'win'); showView('transactions');
        } catch (error) { console.error("Submission Error:", error); showNotification('Submission failed: ' + error.message, 'loss'); 
        } finally { submitBtn.disabled = false; submitBtn.textContent = 'I Have Paid, Submit'; }
    }
    function handleApplyPromoCode(codeOverride = null) {
        const code = codeOverride || promoCodeInput.value.trim().toUpperCase();
        if (!code) return;
        const promo = promoCodesDB[code];
        const usageCount = (currentUserData.promoUsage && currentUserData.promoUsage[code]) || 0;
        const limit = (code === 'IC-50P-300TEX') ? 3 : 2;
        promoFeedbackEl.classList.add('visible');
        if (promo && promo.status === 'active' && usageCount < limit) {
            currentDepositData.promo = promo; currentDepositData.promoCode = code;
            promoFeedbackEl.className = 'promo-feedback success visible'; promoFeedbackText.textContent = `Code "${code}" applied! Get ${promo.bonusPercentage}% bonus.`;
            promoCodeInput.value = code; promoCodeInput.disabled = true; applyPromoBtn.disabled = true; applyPromoBtn.textContent = 'Applied';
            updatePromoBonusDisplay();
        } else if (usageCount >= limit) {
            promoFeedbackEl.className = 'promo-feedback error visible'; promoFeedbackText.textContent = 'You have reached the usage limit for this code.';
            delete currentDepositData.promo; delete currentDepositData.promoCode; updatePromoBonusDisplay();
        } else {
            promoFeedbackEl.className = 'promo-feedback error visible'; promoFeedbackText.textContent = 'Invalid or expired promo code.';
            delete currentDepositData.promo; delete currentDepositData.promoCode; updatePromoBonusDisplay();
        }
    }
    function startDepositTimer() { let timeLeft = DEPOSIT_SESSION_SECONDS; const timerDisplay = document.getElementById('deposit-timer-display'); const updateTimer = () => { if (timeLeft <= 0) { stopDepositTimer(); showNotification('Deposit session expired. Please start over.', 'loss'); showView('deposit-new'); return; } timeLeft--; if (timerDisplay) timerDisplay.textContent = formatTimeShort(timeLeft); }; stopDepositTimer(); if (timerDisplay) timerDisplay.textContent = formatTimeShort(timeLeft); depositTimerInterval = setInterval(updateTimer, 1000); }
    function stopDepositTimer() { if (depositTimerInterval) { clearInterval(depositTimerInterval); depositTimerInterval = null; } }

    function listenForTransactionUpdates(uid) {
        const depositRequestsRef = database.ref('deposit_requests').orderByChild('userId').equalTo(uid);
        depositRequestsRef.on('child_changed', async (snapshot) => {
            const request = snapshot.val(); if (!request.invoiceId) return;
            const localTx = transactionHistory.find(tx => tx.id === request.invoiceId);
            if (localTx && localTx.status !== request.status) {
                database.ref(`users/${uid}/transactions/${request.invoiceId}/status`).set(request.status);
                if (request.status === 'succeeded') {
                    let bonusAmount = 0;
                    if(request.promoCode && promoCodesDB[request.promoCode] && promoCodesDB[request.promoCode].status === 'active') {
                        const promo = promoCodesDB[request.promoCode];
                        const usageCount = (currentUserData.promoUsage && currentUserData.promoUsage[request.promoCode]) || 0;
                        const limit = (request.promoCode === 'IC-50P-300TEX') ? 3 : 2;
                        if(request.amountUSD >= promo.minDeposit && usageCount < limit) {
                            bonusAmount = request.amountUSD * (promo.bonusPercentage / 100);
                            if(promo.maxBonus) bonusAmount = Math.min(bonusAmount, promo.maxBonus);
                            database.ref(`users/${uid}/promoUsage/${request.promoCode}`).set(firebase.database.ServerValue.increment(1));
                        }
                    }
                    await updateBalances({ realChange: request.amountUSD, bonusChange: bonusAmount, isBonusTransaction: bonusAmount > 0, bonusType: 'Deposit Bonus' });
                    
                    await database.ref(`users/${uid}/lastDepositDate`).set(firebase.database.ServerValue.TIMESTAMP);
                    await database.ref(`users/${uid}/taskProgress/totalDepositAmount`).set(firebase.database.ServerValue.increment(request.amountUSD));
                    await database.ref(`users/${uid}/taskProgress/currentDepositAmount`).set(firebase.database.ServerValue.increment(request.amountUSD));
                    await database.ref(`users/${uid}/taskProgress/depositCount`).set(firebase.database.ServerValue.increment(1));

                    if(request.amountUSD >= 10000 && !userTaskProgress.claimed_deposit10k) {
                        await database.ref(`users/${uid}/taskProgress/claimed_deposit10k`).set('completed');
                    }
                    showNotification(`Your deposit of ${request.amountUSD.toFixed(2)} USD has been approved!`, 'win');
                    if(bonusAmount > 0) showNotification(`You received a bonus of ${bonusAmount.toFixed(2)} USD!`, 'info');
                }
                else if (request.status === 'failed' || request.status === 'rejected') {
                    database.ref(`users/${uid}/transactions/${request.invoiceId}/status`).set(request.status);
                    showNotification(`Your deposit of ${request.amountUSD.toFixed(2)} USD was rejected.`, 'loss');
                }
            }
        });
        const withdrawRequestsRef = database.ref('withdraw_requests').orderByChild('userId').equalTo(uid);
        withdrawRequestsRef.on('child_changed', (snapshot) => {
            const request = snapshot.val(); if (!request.id) return;
            const localTx = transactionHistory.find(tx => tx.id === request.id);
            if (localTx && localTx.status !== request.status) {
                database.ref(`users/${uid}/transactions/${request.id}/status`).set(request.status);
                if (request.status === 'succeeded') showNotification(`Your withdrawal of ${request.amount.toFixed(2)} USD is complete.`, 'win');
                else if (request.status === 'rejected') {
                    showNotification(`Your withdrawal of ${request.amount.toFixed(2)} USD was rejected.`, 'loss');
                    updateBalances({ realChange: request.amount, bonusChange: request.bonusRemoved || 0 }); // Refund on rejection
                }
            }
        });
    }
    
    async function handleDeleteAccountRequest() {
        const password = document.getElementById('delete-confirm-password').value;
        const user = auth.currentUser;
        if (!user) return;
        const submitBtn = deleteAccountForm.querySelector('button[type="submit"]');
        submitBtn.disabled = true; submitBtn.textContent = 'Processing...';
        try {
            const credential = firebase.auth.EmailAuthProvider.credential(user.email, password);
            await user.reauthenticateWithCredential(credential);
            const deletionRequest = { email: user.email, name: currentUserData.name, requestedAt: firebase.database.ServerValue.TIMESTAMP };
            const updates = {};
            updates[`users/${user.uid}/accountStatus`] = 'pending_deletion';
            updates[`users/${user.uid}/deletionRequestTimestamp`] = firebase.database.ServerValue.TIMESTAMP;
            updates[`account_deletion_requests/${user.uid}`] = deletionRequest;
            
            // Mark user as deleted for the mentor
            if (currentUserData.mentorId) {
                const mentorSnapshot = await database.ref('mentors').orderByChild('mentorId').equalTo(currentUserData.mentorId).once('value');
                if (mentorSnapshot.exists()) {
                    let mentorUid;
                    mentorSnapshot.forEach(child => { mentorUid = child.key; });
                    updates[`mentors/${mentorUid}/students/${user.uid}`] = null; // Remove from active students
                    updates[`mentors/${mentorUid}/deletedStudents/${user.uid}`] = { name: currentUserData.name, deletedAt: firebase.database.ServerValue.TIMESTAMP };
                }
            }

            await database.ref().update(updates);
            showNotification("Deletion request submitted. You will be logged out.", "info");
            deleteAccountModal.classList.remove('visible');
            setTimeout(() => auth.signOut(), 1000);
        } catch (error) {
            console.error("Account deletion request failed:", error);
            if (error.code === 'auth/wrong-password') { showNotification('Authentication failed. Wrong password.', 'loss');
            } else { showNotification('An error occurred during account deletion request.', 'loss'); }
        } finally {
            submitBtn.disabled = false; submitBtn.textContent = 'Request Deletion'; deleteAccountForm.reset();
        }
    }

    function handleAccountStatus(userData) {
        if (!userData) return;
        const status = userData.accountStatus;
        const bannedUntil = userData.bannedUntil || 0;
        const now = Date.now();
        const controls = document.getElementById('controls-section');
        let isLocked = false;
        if (bannedUntil > now) {
            isLocked = true;
            accountLockedOverlay.style.display = 'flex';
            document.getElementById('locked-title').textContent = 'Account Suspended';
            document.getElementById('locked-message').textContent = 'Your account has been temporarily suspended for rule violations. You can log in again after the timer expires.';
            document.getElementById('deletion-timer').style.display = 'block';
            cancelDeletionBtn.style.display = 'none';
            if (deletionTimerInterval) clearInterval(deletionTimerInterval);
            const updateBanTimer = () => {
                const timeLeft = bannedUntil - Date.now();
                if (timeLeft <= 0) {
                    clearInterval(deletionTimerInterval);
                    database.ref(`users/${auth.currentUser.uid}/bannedUntil`).remove();
                    auth.signOut(); return;
                }
                const days = Math.floor(timeLeft / 86400000); const hours = Math.floor((timeLeft % 86400000) / 3600000);
                const minutes = Math.floor((timeLeft % 3600000) / 60000); const seconds = Math.floor((timeLeft % 60000) / 1000);
                document.getElementById('deletion-timer').textContent = `${String(days).padStart(1, '0')}d ${String(hours).padStart(2, '0')}h ${String(minutes).padStart(2, '0')}m ${String(seconds).padStart(2, '0')}s`;
            }; updateBanTimer(); deletionTimerInterval = setInterval(updateBanTimer, 1000);
        } else if (status === 'pending_deletion') {
            isLocked = true;
            const requestTime = userData.deletionRequestTimestamp, endTime = requestTime + 86400000;
            if (now < endTime) {
                accountLockedOverlay.style.display = 'flex';
                document.getElementById('locked-title').textContent = 'Account Pending Deletion';
                document.getElementById('locked-message').textContent = 'Your account is scheduled for deletion. You can cancel this request within the time remaining.';
                document.getElementById('deletion-timer').style.display = 'block';
                cancelDeletionBtn.style.display = 'block';
                if (deletionTimerInterval) clearInterval(deletionTimerInterval);
                deletionTimerInterval = setInterval(() => {
                    const timeLeft = endTime - Date.now();
                    if (timeLeft <= 0) { clearInterval(deletionTimerInterval); database.ref(`users/${auth.currentUser.uid}/accountStatus`).set('locked'); return; }
                    const hours = Math.floor(timeLeft / 3600000), minutes = Math.floor((timeLeft % 3600000) / 60000), seconds = Math.floor((timeLeft % 60000) / 1000);
                    document.getElementById('deletion-timer').textContent = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                }, 1000);
            } else { database.ref(`users/${auth.currentUser.uid}/accountStatus`).set('locked'); }
        } else if (status === 'locked') {
            isLocked = true;
            accountLockedOverlay.style.display = 'flex';
            document.getElementById('locked-title').textContent = 'Account Locked';
            document.getElementById('locked-message').textContent = 'Your account is locked pending final deletion review by an administrator. Please contact support for assistance.';
            document.getElementById('deletion-timer').style.display = 'none';
            cancelDeletionBtn.style.display = 'none';
        }
        if (!isLocked) {
            accountLockedOverlay.style.display = 'none';
            if (controls) controls.style.display = 'flex';
            if (deletionTimerInterval) clearInterval(deletionTimerInterval);
        } else { if (controls) controls.style.display = 'none'; }
    }

    function listenForNotifications(uid) {
        const globalNotificationsRef = database.ref('admin/notifications');
        globalNotificationsRef.on('value', snapshot => {
            allGlobalNotifications = [];
            if (snapshot.exists()) { snapshot.forEach(child => { allGlobalNotifications.push({ id: child.key, ...child.val() }); }); }
            updateCombinedNotifications();
        });
        const personalNotificationsRef = database.ref(`users/${uid}/notifications`);
        personalNotificationsRef.on('value', snapshot => {
            allPersonalNotifications = [];
            if (snapshot.exists()) { snapshot.forEach(child => { allPersonalNotifications.push({ id: child.key, ...child.val(), isPersonal: true }); }); }
            updateCombinedNotifications();
        });
    }
    
    function updateCombinedNotifications() {
        combinedNotifications = [...allGlobalNotifications, ...allPersonalNotifications].sort((a, b) => b.timestamp - a.timestamp);
        updateUnreadCount();
        if (currentView === 'notifications') { renderNotifications(); }
    }

    function updateUnreadCount() {
        const lastSeenTimestamp = parseInt(localStorage.getItem(`lastSeenNotification_${auth.currentUser.uid}`) || '0');
        unreadNotificationCount = combinedNotifications.filter(n => n.timestamp > lastSeenTimestamp).length;
        updateNotificationBadge();
    }

    function updateNotificationBadge() {
        const headerNotifBadge = document.getElementById('header-notification-badge');
        const profileNotifBtn = document.getElementById('profile-notification-btn');
        const profileNotifIcon = profileNotifBtn.querySelector('svg');
        
        if (unreadNotificationCount > 0) {
            // Header badge on chart view
            headerNotifBadge.textContent = unreadNotificationCount;
            headerNotifBadge.style.display = 'flex';
            
            // Profile page icon color change
            if (profileNotifIcon) {
                profileNotifIcon.classList.add('has-unread');
            }

        } else {
            // Header badge on chart view
            headerNotifBadge.style.display = 'none';
            
            // Profile page icon color change
            if (profileNotifIcon) {
                 profileNotifIcon.classList.remove('has-unread');
            }
        }
    }

    async function renderNotifications() {
        const user = auth.currentUser; if (!user) return;
        const deletedNotifsRef = database.ref(`users/${user.uid}/deletedNotifications`), deletedSnapshot = await deletedNotifsRef.once('value');
        const deletedIds = deletedSnapshot.exists() ? Object.keys(deletedSnapshot.val()) : [];
        const sevenDaysAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
        const visibleNotifications = combinedNotifications.filter(n => !deletedIds.includes(n.id) && n.timestamp >= sevenDaysAgo);
        if (visibleNotifications.length === 0) { notificationListContainer.innerHTML = `<p>No new notifications.</p>`; return; }
        notificationListContainer.innerHTML = visibleNotifications.map(n => {
            const date = new Date(n.timestamp), formattedDate = `${date.toLocaleDateString()} at ${date.toLocaleTimeString()}`;
            return `
                <div class="notification-list-card" id="notif-${n.id}">
                    <button class="delete-notification-btn" data-notif-id="${n.id}" data-is-personal="${n.isPersonal || false}">&times;</button>
                    ${n.imageUrl ? `<img src="${n.imageUrl}" alt="Notification Image">` : ''}
                    <div class="notification-list-content">
                        ${n.title ? `<h3>${n.title}</h3>` : ''}
                        ${n.message ? `<p>${n.message.replace(/\n/g, '<br>')}</p>` : ''}
                        ${n.linkUrl ? `<a href="${n.linkUrl}" target="_blank" class="notification-link-btn">${n.linkText || 'Open Link'}</a>` : ''}
                        <div class="notification-timestamp">${formattedDate}</div>
                    </div>
                </div>`;
        }).join('');
    }
    
    notificationListContainer.addEventListener('click', (e) => {
        if (e.target.classList.contains('delete-notification-btn')) {
            const user = auth.currentUser, notifId = e.target.dataset.notifId, isPersonal = e.target.dataset.isPersonal === 'true';
            if (user && notifId) {
                if (isPersonal) { database.ref(`users/${user.uid}/notifications/${notifId}`).remove(); } 
                else { database.ref(`users/${user.uid}/deletedNotifications/${notifId}`).set(true); }
                document.getElementById(`notif-${notifId}`).remove();
                showNotification('Notification dismissed.', 'info');
            }
        }
    });

    async function resolvePendingTradesOnLogin(uid) {
        const activeTradesRef = database.ref(`users/${uid}/activeTrades`);
        const snapshot = await activeTradesRef.once('value');
        if (!snapshot.exists()) return;
        const now = Date.now();
        const tradesFromDB = Object.values(snapshot.val());
        const pendingTrades = tradesFromDB.filter(bet => now >= bet.expiryTimestamp);
        if (pendingTrades.length > 0) {
            myActiveBets.push(...pendingTrades);
            showNotification(`Found ${pendingTrades.length} expired trade(s). Resolving now...`, 'info');
            await resolveExpiredBets();
        }
    }

    function loadAndApplySettings() {
        const savedExpiry = localStorage.getItem('expirySettings');
        if (savedExpiry) {
            try {
                const parsed = JSON.parse(savedExpiry);
                if (timeSteps.includes(parsed.value)) {
                    expirySettings = parsed;
                }
            } catch(e) { /* use default */ }
        }
        
        const savedChartSettings = localStorage.getItem('chartSettings');
        if (savedChartSettings) {
            try {
                const parsed = JSON.parse(savedChartSettings);
                if (parsed.grid) chartSettings.grid = { ...chartSettings.grid, ...parsed.grid };
                if (parsed.utcTime) chartSettings.utcTime = { ...chartSettings.utcTime, ...parsed.utcTime };
                
                chartSettings.colors = { ...chartSettings.colors, ...parsed.colors };
                Object.keys(chartSettings.indicators).forEach(key => {
                    if (parsed.indicators && parsed.indicators[key]) {
                        chartSettings.indicators[key] = { ...chartSettings.indicators[key], ...parsed.indicators[key] };
                    }
                });
            } catch(e) { console.error("Could not parse saved chart settings"); }
        }
        investmentAmount = 10;
        updateInvestmentDisplay();
        updateExpiryDisplay();
    }

    // --- NEW MINER V2 LOGIC ---
    function initMinerPage() {
        const uid = auth.currentUser.uid;
        renderMinerUI();
        
        database.ref(`users/${uid}/miner`).on('value', snapshot => {
            const data = snapshot.val();
            if (!data) {
                const randomRewardClick = Math.floor(Math.random() * 4) + 6; // 6, 7, 8, 9
                minerData = { walletBalance: 0, lastMineTime: 0, dailyMines: 0, lastResetDate: new Date().toISOString().slice(0, 10), miningHistory: {}, activeHashes: {}, rewardClickTarget: randomRewardClick };
                database.ref(`users/${uid}/miner`).set(minerData);
            } else {
                minerData = data;
            }
            activeHashes = minerData.activeHashes ? Object.values(minerData.activeHashes) : [];
            updateTotalHashPower();
            checkDailyMinerReset();
            updateMinerUI();
        });
    }

    function generateRandomHash() {
        const chars = 'abcdef0123456789';
        let hash = '';
        for (let i = 0; i < 40; i++) {
            hash += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return hash;
    }

    function startDynamicHash(start = true) {
        if (dynamicHashInterval) clearInterval(dynamicHashInterval);
        const hashEl = document.getElementById('miner-dynamic-hash');
        if (!hashEl) return;
        if (start) {
            dynamicHashInterval = setInterval(() => {
                hashEl.textContent = generateRandomHash();
            }, 100);
        } else {
             hashEl.textContent = generateRandomHash();
        }
    }
    
    async function checkDailyMinerReset() {
        if (!minerData) return;
        const today = new Date().toISOString().slice(0, 10);
        if (minerData.lastResetDate !== today) {
            const randomRewardClick = Math.floor(Math.random() * 4) + 6; // 6, 7, 8, 9
            const updates = { dailyMines: 0, lastResetDate: today, rewardClickTarget: randomRewardClick };
            await database.ref(`users/${auth.currentUser.uid}/miner`).update(updates);
        }
    }

    function renderMinerUI() {
         minerPageContent.innerHTML = `
            <div id="miner-dynamic-hash">${generateRandomHash()}</div>
            <div id="miner-container">
                <div id="click-to-mine-hint">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M10.25 2.75a.75.75 0 0 0-1.5 0v7.696l-2.28-2.28a.75.75 0 0 0-1.06 1.06l3.5 3.5a.75.75 0 0 0 1.06 0l3.5-3.5a.75.75 0 1 0-1.06-1.06l-2.28 2.28V2.75Z M18 10a.75.75 0 0 1 .75.75v6.5a.75.75 0 0 1 -1.5 0v-6.5A.75.75 0 0 1 18 10Z M5.25 12.25a.75.75 0 0 0-1.5 0v6a.75.75 0 0 0 1.5 0v-6Z M14 13.5a.75.75 0 0 1 .75.75v3a.75.75 0 0 1-1.5 0v-3a.75.75 0 0 1 .75-.75Z"/></svg>
                    <span>Click to mine</span>
                </div>
                <div class="miner-display">
                    <div class="miner-display-btc" id="miner-balance-btc">0.00000000 <span>BTC</span></div>
                    <div class="miner-display-usdt" id="miner-balance-usdt">0.00 USD</div>
                </div>
                <div id="mine-btn-container">
                     <svg class="miner-progress-ring" width="160" height="160">
                       <circle class="miner-progress-ring__circle" stroke="${'var(--color-golden)'}" stroke-width="4" fill="transparent" r="76" cx="80" cy="80"/>
                     </svg>
                     <button id="mine-btn">
                        <img src="https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/Bitcoin%20block.jpeg?alt=media&token=36bd8668-84ae-429a-a319-0a5e8392b493" alt="Mine Bitcoin">
                        <span id="mine-btn-timer" style="display:none;"></span>
                    </button>
                </div>
                 <div id="hash-power-container">
                    <img id="miner-fan-icon" src="https://firebasestorage.googleapis.com/v0/b/viptask-5c1fc.appspot.com/o/1755648612175.png?alt=media&token=592e7646-71ec-4d17-aa6e-dcf658d4a678" alt="Hash Power Icon"/>
                    <div class="hash-power-display">
                        <span class="hash-power-label">Hash Power</span>
                        <span id="hash-power-value">0 / 200 H/s</span>
                    </div>
                </div>
                 <div id="miner-upgrade-section">
                   <span id="miner-upgrade-link">Update your Cloud Hash for better earnings</span>
                </div>
                <button id="withdraw-miner-btn" disabled>Withdraw (min 10 USD)</button>
            </div>`;
        document.getElementById('mine-btn').addEventListener('click', handleMineButtonClick);
        document.getElementById('withdraw-miner-btn').addEventListener('click', handleMinerWithdraw);
        document.getElementById('miner-upgrade-link').addEventListener('click', openMinerUpgradeModal);
        document.getElementById('miner-history-btn').addEventListener('click', () => showView('miner-history'));
    }

    function updateMinerUI() {
        if (!minerData || !document.getElementById('mine-btn')) return;
        const usdtBalance = (minerData.walletBalance || 0);
        const btcBalance = usdtBalance / BTC_USDT_RATE;

        const btcElement = document.getElementById('miner-balance-btc');
        if(btcElement) {
            btcElement.innerHTML = `${btcBalance.toFixed(8)} <span>BTC</span>`;
        }
        const usdtElement = document.getElementById('miner-balance-usdt');
        if(usdtElement) {
             usdtElement.textContent = `${usdtBalance.toFixed(2)} USD`;
        }
        
        const withdrawBtn = document.getElementById('withdraw-miner-btn');
        if(withdrawBtn) {
             withdrawBtn.disabled = usdtBalance < MINER_WITHDRAW_THRESHOLD;
        }
        
        updateMineButtonState();
        updateTotalHashPower();
    }

    function updateMineButtonState() {
        if(mineBtnTimerInterval) clearInterval(mineBtnTimerInterval);
        const mineBtn = document.getElementById('mine-btn');
        const timerEl = document.getElementById('mine-btn-timer');
        const hintEl = document.getElementById('click-to-mine-hint');
        const progressCircle = document.querySelector('.miner-progress-ring__circle');
        
        if (!mineBtn) return;
        const now = Date.now();
        const timeSinceLastMine = now - (minerData.lastMineTime || 0);

        if (timeSinceLastMine >= MINING_COOLDOWN_MS) {
            mineBtn.disabled = false;
            if(timerEl) timerEl.style.display = 'none';
            if(hintEl) hintEl.style.display = 'flex';
            if(progressCircle) progressCircle.style.strokeDashoffset = 478;
            isMinerActive = false;
            startDynamicHash(false);
            if (hashPowerInterval) { clearInterval(hashPowerInterval); hashPowerInterval = null; }
            const hashValueEl = document.getElementById('hash-power-value');
            if(hashValueEl) hashValueEl.textContent = `0 / ${totalHashPower} H/s`;
            const fanIcon = document.getElementById('miner-fan-icon');
            if(fanIcon) fanIcon.classList.remove('spinning');
        } else {
            mineBtn.disabled = true;
            if(timerEl) timerEl.style.display = 'flex';
            if(hintEl) hintEl.style.display = 'none';
            isMinerActive = true;
            startDynamicHash(true);
            animateHashPower();
            
            const updateTimer = () => {
                const remaining = MINING_COOLDOWN_MS - (Date.now() - minerData.lastMineTime);
                const progress = 1 - (remaining / MINING_COOLDOWN_MS);
                if (progressCircle) {
                    const circleLength = 2 * Math.PI * 76; // 478
                    progressCircle.style.strokeDashoffset = circleLength * (1 - progress);
                }
                if (remaining <= 0) {
                    clearInterval(mineBtnTimerInterval);
                    updateMineButtonState();
                } else if (timerEl) {
                                        const hours = Math.floor((remaining / (1000 * 60 * 60)) % 24);
                    const minutes = Math.floor((remaining / 1000 / 60) % 60);
                    const seconds = Math.floor((remaining / 1000) % 60);
                    timerEl.textContent = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                }
            };
            updateTimer();
            mineBtnTimerInterval = setInterval(updateTimer, 1000);
        }
    }
    
    function animateHashPower() {
        if (hashPowerInterval) clearInterval(hashPowerInterval);
        const hashValueEl = document.getElementById('hash-power-value');
        const fanIcon = document.getElementById('miner-fan-icon');
        if (!hashValueEl || !fanIcon) return;
        
        const animationDuration = Math.max(0.5, 2 - (totalHashPower / 4000));
        fanIcon.style.animation = `spin ${animationDuration}s linear infinite`;
        fanIcon.classList.add('spinning');
        
        let currentPower = 0;
        const step = Math.ceil(totalHashPower / 40);
        const rampUpInterval = setInterval(() => {
            currentPower += step;
            if (currentPower >= totalHashPower) {
                currentPower = totalHashPower;
                clearInterval(rampUpInterval);
                hashPowerInterval = setInterval(() => {
                    const fluctuation = Math.floor(Math.random() * (totalHashPower * 0.1)) - (totalHashPower * 0.05);
                    let newPower = totalHashPower + fluctuation;
                    newPower = Math.round(Math.max(totalHashPower * 0.95, Math.min(totalHashPower, newPower)));
                    hashValueEl.textContent = `${newPower} / ${totalHashPower} H/s`;
                }, 1000);
            }
             hashValueEl.textContent = `${currentPower} / ${totalHashPower} H/s`;
        }, 50);
    }

    function generateMiningReward() {
        const DAILY_TARGET_MIN = 0.30;
        const DAILY_TARGET_MAX = 0.40;
        const SESSIONS_PER_DAY = 24;

        const dailyTarget = DAILY_TARGET_MIN + Math.random() * (DAILY_TARGET_MAX - DAILY_TARGET_MIN);
        const averageReward = dailyTarget / SESSIONS_PER_DAY;
        
        // Randomize reward per session, can be 0 sometimes
        const randomFactor = Math.random();
        if (randomFactor < 0.2) { // 20% chance of getting 0
            return 0;
        } else {
            // Generate a reward around the average
            return (averageReward * (0.5 + Math.random() * 1.5)) * totalMultiplier;
        }
    }
    
    async function handleMineButtonClick() {
        const mineBtn = document.getElementById('mine-btn');
        if (!mineBtn || mineBtn.disabled) return;
        
        mineBtn.disabled = true;
        
        const user = auth.currentUser;
        const today = new Date().toISOString().slice(0, 10);
        
        const dailyMines = (minerData.dailyMines || 0) + 1;
        
        const reward = generateMiningReward();
        
        const updates = {
            lastMineTime: Date.now(),
            dailyMines: dailyMines,
            walletBalance: firebase.database.ServerValue.increment(reward)
        };
        
        await database.ref(`users/${user.uid}/miner/miningHistory/${today}`).set(firebase.database.ServerValue.increment(reward));
        
        if (reward > 0) {
            showNotification(`You mined ${ (reward / BTC_USDT_RATE).toFixed(8) } BTC!`, 'win');
        } else {
            showNotification('This mining session yielded no reward. Try again in the next session!', 'info');
        }
        
        await database.ref(`users/${user.uid}/miner`).update(updates);
        await database.ref(`users/${user.uid}/taskProgress/minerClicks`).set(firebase.database.ServerValue.increment(1));
    }

    async function handleMinerWithdraw() {
        const user = auth.currentUser;
        if (!user || !minerData || minerData.walletBalance < MINER_WITHDRAW_THRESHOLD) return;
        
        const amountToWithdraw = minerData.walletBalance;
        
        try {
            await database.ref(`users/${user.uid}/miner/walletBalance`).set(0);
            await updateBalances({ bonusChange: amountToWithdraw, isBonusTransaction: true, bonusType: 'Mined Coins' });
            showNotification(`${amountToWithdraw.toFixed(2)} USDT transferred to your bonus balance!`, 'win');
        } catch (error) {
             console.error("Miner withdraw failed:", error);
             showNotification("Withdrawal failed. Please try again.", 'loss');
             await database.ref(`users/${user.uid}/miner/walletBalance`).set(amountToWithdraw);
        }
    }
    
    function openMinerUpgradeModal() {
        const modal = document.getElementById('miner-upgrade-modal');
        modal.innerHTML = `
            <div class="modal-content">
                <div class="miner-modal-header">
                    <h3>ICTEX CLOUD BTC</h3>
                    <button id="miner-modal-close-btn">&times;</button>
                </div>
                <div class="miner-modal-body">
                    <div class="miner-modal-tabs">
                        <button class="miner-modal-tab active" data-tab="buy">Buy Hash</button>
                        <button class="miner-modal-tab" data-tab="active">Active Hash</button>
                    </div>
                    <div id="miner-tab-buy" class="miner-modal-tab-content active"></div>
                    <div id="miner-tab-active" class="miner-modal-tab-content"></div>
                </div>
            </div>`;
            
                        renderBuyHashTab();
        renderActiveHashTab();
        
        const modalContent = modal.querySelector('.modal-content');
        modal.querySelectorAll('.miner-modal-tab').forEach(tab => {
            tab.addEventListener('click', e => {
                modal.querySelectorAll('.miner-modal-tab, .miner-modal-tab-content').forEach(el => el.classList.remove('active'));
                e.currentTarget.classList.add('active');
                modal.querySelector(`#miner-tab-${e.currentTarget.dataset.tab}`).classList.add('active');
            });
        });

        const closeModal = () => modal.classList.remove('visible');
        modal.querySelector('#miner-modal-close-btn').addEventListener('click', closeModal);
        modal.addEventListener('click', e => { if (e.target === modal) closeModal(); });
        
        modal.classList.add('visible');
    }
    
    function renderBuyHashTab() {
        const container = document.getElementById('miner-tab-buy');
        container.innerHTML = Object.entries(hashPlans).map(([key, plan]) => `
            <div class="subscription-card">
                <img src="${plan.logo}" class="sub-card-logo">
                <div class="sub-card-info">
                    <h4>${plan.name}</h4>
                    <p>+${plan.hash} H/s | ${plan.durationDays} Days</p>
                </div>
                <button class="sub-card-buy-btn" data-plan-id="${key}" ${realBalance < plan.price ? 'disabled' : ''}>$${plan.price}</button>
            </div>
        `).join('');

        container.querySelectorAll('.sub-card-buy-btn').forEach(btn => {
            btn.addEventListener('click', () => buyHashPlan(btn.dataset.planId));
        });
    }

    function renderActiveHashTab() {
        const container = document.getElementById('miner-tab-active');
        if (activeHashes.length === 0) {
            container.innerHTML = '<p style="text-align:center;">No active hash plans.</p>';
            return;
        }
        container.innerHTML = activeHashes.map(hash => {
            const timeLeft = hash.expiresAt - Date.now();
            if (timeLeft <= 0) return '';
            const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
            const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
            return `
                <div class="active-hash-item">
                    <img src="${hashPlans[hash.planId]?.logo || ''}" class="active-hash-logo">
                    <div class="active-hash-details">
                        <span class="active-hash-info">${hash.name} (+${hash.hash} H/s)</span>
                        <span class="active-hash-timer">${days}d ${hours}h ${minutes}m left</span>
                    </div>
                </div>
            `;
        }).join('');
    }
    
    async function buyHashPlan(planId) {
        const plan = hashPlans[planId];
        if (!plan || realBalance < plan.price) {
            showNotification('Insufficient funds to purchase this plan.', 'loss');
            return;
        }
        if (!confirm(`Are you sure you want to buy the ${plan.name} plan for $${plan.price}? This will be deducted from your real balance.`)) return;

        const user = auth.currentUser;
        const newHash = {
            id: `hash_${Date.now()}`,
            planId: planId,
            name: plan.name,
            hash: plan.hash,
            multiplier: plan.multiplier,
            purchasedAt: Date.now(),
            expiresAt: Date.now() + (plan.durationDays * 24 * 60 * 60 * 1000)
        };
        
        try {
            await updateBalances({ realChange: -plan.price });
            await database.ref(`users/${user.uid}/miner/activeHashes/${newHash.id}`).set(newHash);
            showNotification(`${plan.name} plan purchased successfully!`, 'win');
            document.getElementById('miner-upgrade-modal').classList.remove('visible');
        } catch (error) {
            console.error("Failed to buy hash plan:", error);
            showNotification('Purchase failed. Please try again.', 'loss');
            await updateBalances({ realChange: plan.price });
        }
    }
    
    function updateTotalHashPower() {
        const now = Date.now();
        activeHashes = (minerData && minerData.activeHashes) ? Object.values(minerData.activeHashes).filter(h => h.expiresAt > now) : [];
        
        let baseHash = 200;
        let currentMultiplier = 1;
        
        activeHashes.forEach(h => {
            baseHash += h.hash;
            currentMultiplier *= h.multiplier;
        });
        
        totalHashPower = baseHash;
        totalMultiplier = currentMultiplier;
    }
    
    async function renderMinerHistory() {
        const historyContainer = document.getElementById('miner-history-list');
        const historyData = minerData.miningHistory || {};
        
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        
        const historyKeys = Object.keys(historyData)
            .filter(dateStr => new Date(dateStr) >= thirtyDaysAgo)
            .sort((a,b) => new Date(b) - new Date(a));

        if (historyKeys.length === 0) {
            historyContainer.innerHTML = '<p style="text-align: center;">No mining history in the last 30 days.</p>';
            return;
        }
        
        let html = '';
        historyKeys.forEach(date => {
            const usdtAmount = historyData[date];
            const btcAmount = usdtAmount / BTC_USDT_RATE;
            html += `
                <div class="miner-history-item">
                    <span class="mhi-date">${date}</span>
                    <div class="mhi-rewards">
                        <div class="mhi-btc">+${btcAmount.toFixed(8)} BTC</div>
                        <div class="mhi-usdt">$${usdtAmount.toFixed(2)}</div>
                    </div>
                </div>
            `;
        });
        historyContainer.innerHTML = html;
    }

    async function cleanupOldMinerHistory() {
        const user = auth.currentUser;
        if(!user || !minerData || !minerData.miningHistory) return;

        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        
        const historyRef = database.ref(`users/${user.uid}/miner/miningHistory`);
        const updates = {};
        let hasUpdates = false;

        Object.keys(minerData.miningHistory).forEach(dateStr => {
            if (new Date(dateStr) < thirtyDaysAgo) {
                updates[dateStr] = null;
                hasUpdates = true;
            }
        });
        
        if (hasUpdates) {
            await historyRef.update(updates);
            console.log("Cleaned up old miner history.");
        }
    }
    
    // --- NEW MENTOR SYSTEM ---
    let mentorData = null;
    let mentorActiveUserCheckInterval = null;
    const salaryTiers = [
        { id: 'tier1', name: 'Bronze Partner', requiredUsers: 50, salary: 75 },
        { id: 'tier2', name: 'Silver Partner', requiredUsers: 150, salary: 350 },
        { id: 'tier3', name: 'Gold Partner', requiredUsers: 500, salary: 1300 },
        { id: 'tier4', name: 'Diamond Partner', requiredUsers: 1000, salary: 4500 }
    ];

    function initMentorPage() {
        const user = auth.currentUser;
        if (!user) return;
        
        if (mentorActiveUserCheckInterval) clearInterval(mentorActiveUserCheckInterval);

        database.ref(`mentors/${user.uid}`).on('value', snapshot => {
            mentorData = snapshot.val();
            const pageContent = document.getElementById('mentor-page-content');
            
            if (currentUserData.isMentor && mentorData) {
                renderMentorDashboard(pageContent);
                // Start checking active users periodically
                checkMentorActiveUsers(); // Initial check
                mentorActiveUserCheckInterval = setInterval(checkMentorActiveUsers, 5 * 60 * 1000); // Check every 5 mins
            } else {
                renderMentorJoinView(pageContent);
            }
        });
    }

    function renderMentorJoinView(container) {
        const firstDepositDone = currentUserData.lastDepositDate != null;
        const fiveTradesDone = fullTradeHistory.length >= 5;
        const kycDone = currentUserData.kycStatus === 'verified';
        const allTasksDone = firstDepositDone && fiveTradesDone && kycDone;

        const checkIcon = `<svg class="status-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5l1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>`;
        const pendingIcon = `<svg class="status-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8 8-8z"/></svg>`;
        
        container.innerHTML = `
            <h2>Become a Mentor</h2>
            <p>Complete the following tasks to unlock your Mentor Dashboard and start earning.</p>
            <ul class="mentor-task-list">
                <li class="mentor-task-item ${firstDepositDone ? 'completed' : ''}">
                    <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M5 20h14v-2H5v2zm0-10h4v6h6v-6h4l-7-7-7 7z"/></svg>
                    <span class="text">Make your first deposit</span>
                    ${firstDepositDone ? checkIcon : pendingIcon}
                </li>
                <li class="mentor-task-item ${fiveTradesDone ? 'completed' : ''}">
                    <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6l4 4l6.3-6.29L22 12V6h-6z"/></svg>
                    <span class="text">Complete 5 trades</span>
                    ${fiveTradesDone ? checkIcon : pendingIcon}
                </li>
                <li class="mentor-task-item ${kycDone ? 'completed' : ''}">
                    <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                    <span class="text">Complete KYC Verification</span>
                    ${kycDone ? checkIcon : pendingIcon}
                </li>
            </ul>
            <button class="save-button" id="join-mentor-btn" ${!allTasksDone ? 'disabled' : ''}>Join Mentor Program</button>
        `;

        const joinBtn = document.getElementById('join-mentor-btn');
        if(joinBtn) {
            joinBtn.addEventListener('click', handleBecomeMentor);
        }
    }

    async function handleBecomeMentor() {
        const user = auth.currentUser;
        if (!user || currentUserData.isMentor) return;

        const joinBtn = document.getElementById('join-mentor-btn');
        joinBtn.disabled = true;
        joinBtn.textContent = 'Processing...';

        try {
            const mentorId = Math.random().toString(36).substring(2, 10).toUpperCase();
            const newMentorData = {
                uid: user.uid,
                name: currentUserData.name,
                email: currentUserData.email,
                mentorId: mentorId,
                joinDate: firebase.database.ServerValue.TIMESTAMP,
                commissionWallet: {
                    balance: 0,
                    totalEarned: 0
                },
                studentCount: {
                    all: 0,
                    active: 0
                },
                salaryStatus: null,
                isWithdrawalBlocked: false // For admin control
            };
            
            const updates = {};
            updates[`/mentors/${user.uid}`] = newMentorData;
            updates[`/users/${user.uid}/isMentor`] = true;

            await database.ref().update(updates);
            showNotification('Congratulations! You are now a Mentor.', 'win');
        } catch (error) {
            console.error('Error becoming mentor:', error);
            showNotification('An error occurred. Please try again.', 'loss');
            joinBtn.disabled = false;
            joinBtn.textContent = 'Join Mentor Program';
        }
    }

    function renderMentorDashboard(container) {
        if (!mentorData) {
            container.innerHTML = `<p>Loading mentor data...</p>`;
            return;
        }

        const commissionBalance = mentorData.commissionWallet?.balance || 0;
        const totalCommissionEarned = mentorData.commissionWallet?.totalEarned || 0;
        const totalUsers = mentorData.studentCount?.all || 0;
        const activeUsers = mentorData.studentCount?.active || 0;
        
        container.innerHTML = `
            <div class="mentor-hero-card">
                <div class="label">My Commission</div>
                <div class="value">$${commissionBalance.toFixed(2)}</div>
                <div class="sub-value">Total Earned: $${totalCommissionEarned.toFixed(2)}</div>
            </div>

            <div class="mentor-dashboard-grid">
                <div class="mentor-stat-card">
                    <div class="label">All Users</div>
                    <div class="value">${totalUsers}</div>
                </div>
                <div class="mentor-stat-card">
                    <div class="label">Active Users</div>
                    <div class="value">${activeUsers}</div>
                </div>
            </div>
            
            <div class="mentor-id-card">
                <div>
                    <div class="label">My Mentor ID</div>
                    <div class="id-code" id="mentor-id-code">${mentorData.mentorId}</div>
                </div>
                <button class="copy-btn" id="copy-mentor-id-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
                </button>
            </div>

            <div style="display: flex; gap: 10px; margin-bottom: 25px;">
                <button class="save-button" id="mentor-withdraw-btn" style="flex:1; margin-top:0;">Withdraw Commission</button>
                <button class="modal-button secondary" id="mentor-user-list-btn" style="flex:1;">User List</button>
            </div>
            
            <div class="mentor-section-card" id="mentor-salary-section">
                <h3>Monthly Salary Program</h3>
            </div>
        `;
        renderMentorSalarySection();
        
        document.getElementById('copy-mentor-id-btn').addEventListener('click', () => {
            navigator.clipboard.writeText(mentorData.mentorId).then(() => showNotification('Mentor ID copied!', 'info'));
        });
        document.getElementById('mentor-user-list-btn').addEventListener('click', () => showView('mentor-users'));
        document.getElementById('mentor-withdraw-btn').addEventListener('click', openMentorWithdrawModal);
    }
    
    function renderMentorSalarySection() {
        const container = document.getElementById('mentor-salary-section');
        const activeUsers = mentorData.studentCount?.active || 0;
        const salaryStatus = mentorData.salaryStatus;
        
        let contentHTML = '';

        if (salaryStatus && salaryStatus.status === 'active') {
            const timeLeft = salaryStatus.endDate - Date.now();
            const daysLeft = Math.max(0, Math.ceil(timeLeft / (1000 * 60 * 60 * 24)));
            contentHTML = `<p>Your salary plan is active! Maintain ${salaryStatus.requiredUsers} active users for ${daysLeft} more days to claim your $${salaryStatus.salary} reward.</p>`;
        } else if (salaryStatus && salaryStatus.status === 'claimable') {
            contentHTML = `<p>Congratulations! You can now claim your $${salaryStatus.salary} salary.</p><button class="save-button" id="claim-salary-btn">Claim Salary</button>`;
        } else if (salaryStatus && salaryStatus.status === 'cooldown') {
            const cooldownEnds = salaryStatus.cooldownEndDate;
            const timeLeft = cooldownEnds - Date.now();
            const daysLeft = Math.max(0, Math.ceil(timeLeft / (1000 * 60 * 60 * 24)));
            contentHTML = `<p>Your previous salary application was unsuccessful. You can apply again in ${daysLeft} days.</p>`;
        } else {
            const tiersHTML = salaryTiers.map(tier => {
                const canApply = activeUsers >= tier.requiredUsers;
                const progress = Math.min(100, (activeUsers / tier.requiredUsers) * 100);
                return `
                    <div class="salary-tier-card">
                        <div class="salary-tier-header">
                            <span class="salary-tier-title">${tier.name}</span>
                            <span class="salary-tier-reward">$${tier.salary}</span>
                        </div>
                        <div class="salary-tier-progress-info">
                            <span>${activeUsers} / ${tier.requiredUsers}</span>
                            <span>Active Users</span>
                        </div>
                        <div class="salary-progress-bar">
                            <div class="salary-progress-bar-inner" style="width: ${progress}%;"></div>
                        </div>
                        <button class="salary-apply-btn" data-tier-id="${tier.id}" ${!canApply ? 'disabled' : ''}>Apply</button>
                    </div>
                `;
            }).join('');
            contentHTML = `<div class="salary-tier-list">${tiersHTML}</div>`;
        }
        
        container.innerHTML += contentHTML;
        
        container.querySelectorAll('.salary-apply-btn').forEach(btn => {
            btn.addEventListener('click', () => handleSalaryApply(btn.dataset.tierId));
        });
        const claimBtn = document.getElementById('claim-salary-btn');
        if(claimBtn) claimBtn.addEventListener('click', handleSalaryClaim);
    }

    function initMentorUserListPage() {
        const container = document.getElementById('mentor-user-list-content');
        container.innerHTML = `
            <div class="search-input-group">
                <input type="text" id="mentor-user-search" class="form-input" placeholder="Search by User ID...">
                <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path d="M15.5 14h-.79l-.28-.27a6.5 6.5 0 0 0 1.48-5.34c-.47-2.78-2.79-5-5.59-5.34a6.505 6.505 0 0 0-7.27 7.27c.34 2.8 2.56 5.12 5.34 5.59a6.5 6.5 0 0 0 5.34-1.48l.27.28v.79l4.25 4.25c.41.41 1.08.41 1.49 0s.41-1.08 0-1.49L15.5 14zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
            </div>
            <div id="mentor-user-list-container">Loading users...</div>`;
        
        loadAndRenderMentorUsers();

        document.getElementById('mentor-user-search').addEventListener('input', (e) => {
             loadAndRenderMentorUsers(e.target.value.trim());
        });
         document.getElementById('mentor-deleted-users-btn').addEventListener('click', showDeletedUsers);
    }

    async function loadAndRenderMentorUsers(searchTerm = '', showDeleted = false) {
        const user = auth.currentUser;
        const container = document.getElementById('mentor-user-list-container');
        if (!user || !mentorData || !container) return;

        const dataPath = showDeleted ? `mentors/${user.uid}/deletedStudents` : `mentors/${user.uid}/students`;
        const studentsRef = database.ref(dataPath);
        const snapshot = await studentsRef.once('value');
        if (!snapshot.exists()) {
            container.innerHTML = `<p>${showDeleted ? 'No deleted users found.' : 'No users have joined with your ID yet.'}</p>`;
            return;
        }

        const students = snapshot.val();
        let userListHTML = '';
        const userIds = Object.keys(students);

        for (const uid of userIds) {
            const student = students[uid];
            let userData, isActive = false;
            if (showDeleted) {
                userData = { name: student.name, numericId: uid.slice(-8), totalProfitLoss: 0, realBalance: 0, bonusBalance: 0 };
            } else {
                const userSnapshot = await database.ref(`users/${uid}`).once('value');
                if (!userSnapshot.exists()) continue;
                userData = userSnapshot.val();
                isActive = checkUserActivity(userData);
            }

            if(searchTerm && userData.numericId && !userData.numericId.includes(searchTerm)) {
                continue;
            }
            
            const pnl = userData.totalProfitLoss || 0;
            const pnlClass = pnl >= 0 ? 'profit' : 'loss';
            const lastDeposit = userData.lastDepositDate ? new Date(userData.lastDepositDate).toLocaleDateString() : 'N/A';
            const statusClass = isActive ? 'active' : 'inactive';
            const statusText = isActive ? 'Active' : 'Inactive';
            
            userListHTML += `
                <div class="mentor-user-list-item">
                    <div class="mentor-user-top-row">
                        <div class="mentor-user-info">
                            <div class="name">${userData.name}</div>
                            <div class="uid">ID: ${userData.numericId}</div>
                            ${!showDeleted ? `<div class="status ${statusClass}">${statusText}</div>` : ''}
                        </div>
                        <div class="mentor-user-stats">
                            <div class="stat">
                                <div class="label">Balance</div>
                                <div class="value">$${((userData.realBalance || 0) + (userData.bonusBalance || 0)).toFixed(2)}</div>
                            </div>
                            <div class="stat">
                                <div class="label">Profit/Loss</div>
                                <div class="value ${pnlClass}">$${pnl.toFixed(2)}</div>
                            </div>
                            <div class="stat">
                                <div class="label">Last Deposit</div>
                                <div class="value">${lastDeposit}</div>
                            </div>
                        </div>
                    </div>
                </div>`;
        }
        
        if (!userListHTML) {
            container.innerHTML = `<p>No users found${searchTerm ? ` for "${searchTerm}"` : ''}.</p>`;
        } else {
            container.innerHTML = userListHTML;
        }
    }

    async function showDeletedUsers() {
        showView('mentor-users'); // Re-initialize the view
        setTimeout(() => {
            const container = document.getElementById('mentor-user-list-content');
            container.querySelector('h2').textContent = "Deleted Users";
            document.getElementById('mentor-deleted-users-btn').style.display = 'none'; // Hide button on this view
            loadAndRenderMentorUsers('', true);
        }, 10);
    }
    
    function checkUserActivity(userData) {
        if (!userData) return false;
        const now = Date.now();
        const threeDaysAgo = now - (3 * 24 * 60 * 60 * 1000);
        const twentyFourHoursAgo = now - (24 * 60 * 60 * 1000);
        
        // Condition 1: Must have made a first deposit
        if (!userData.lastDepositDate) return false;
        
        // Condition 2: Must have traded in the last 3 days
        if ((userData.lastTradeTimestamp || 0) < threeDaysAgo) return false;
        
        // Condition 3: Balance must not be less than $1 for 24h (Approximation)
        if ((userData.realBalance + userData.bonusBalance) < 1) return false;
        
        return true;
    }

    async function checkMentorActiveUsers() {
        const user = auth.currentUser;
        if (!user || !mentorData) return;

        const students = mentorData.students || {};
        const studentUIDs = Object.keys(students);
        let activeCount = 0;

        for (const uid of studentUIDs) {
            const userSnapshot = await database.ref(`users/${uid}`).once('value');
            if (userSnapshot.exists()) {
                if (checkUserActivity(userSnapshot.val())) {
                    activeCount++;
                }
            }
        }
        
        if (mentorData.studentCount.active !== activeCount) {
            await database.ref(`mentors/${user.uid}/studentCount/active`).set(activeCount);
        }
    }


    async function handleSalaryApply(tierId) {
        const user = auth.currentUser;
        const tier = salaryTiers.find(t => t.id === tierId);
        if (!user || !tier) return;
        
        const salaryApplication = {
            tierId: tier.id,
            status: 'active',
            salary: tier.salary,
            requiredUsers: tier.requiredUsers,
            startDate: Date.now(),
            endDate: Date.now() + 30 * 24 * 60 * 60 * 1000
        };

        await database.ref(`mentors/${user.uid}/salaryStatus`).set(salaryApplication);
        showNotification(`You have applied for the ${tier.name} plan!`, 'win');
    }

    function openMentorWithdrawModal() {
        if(mentorData.isWithdrawalBlocked) {
            showNotification('Your withdrawal function is currently disabled by the administrator.', 'loss');
            return;
        }
        const modal = document.getElementById('mentor-earnings-withdraw-modal');
        const availableAmount = mentorData.commissionWallet?.balance || 0;
        document.getElementById('mentor-withdraw-available').value = `$${availableAmount.toFixed(2)}`;
        document.getElementById('mentor-earnings-withdraw-form').reset();
        modal.classList.add('visible');
    }

    async function handleMentorWithdraw(e) {
        e.preventDefault();
        const modal = document.getElementById('mentor-earnings-withdraw-modal');
        const amount = parseFloat(document.getElementById('mentor-withdraw-amount').value);
        const accountId = document.getElementById('mentor-withdraw-account-id').value.trim();
        const availableAmount = mentorData.commissionWallet?.balance || 0;
        
        if (isNaN(amount) || amount < 1000) {
            showNotification('Minimum withdrawal is $1000.', 'loss');
            return;
        }
        if (amount > availableAmount) {
            showNotification('Insufficient earnings balance.', 'loss');
            return;
        }
        if (!accountId) {
            showNotification('Please enter your Binance Pay ID.', 'loss');
            return;
        }

        const user = auth.currentUser;
        const mentorRef = database.ref(`mentors/${user.uid}/commissionWallet/balance`);
        
        try {
            await mentorRef.transaction(currentBalance => {
                if (currentBalance >= amount) {
                    return currentBalance - amount;
                }
                return; // Abort transaction
            });
            
            const withdrawRequest = {
                userId: user.uid,
                userName: mentorData.name,
                type: 'mentor_earning',
                amount: amount,
                method: 'Binance Pay',
                accountId: accountId,
                status: 'pending',
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };
            
            await database.ref('withdraw_requests').push(withdrawRequest);
            
            const newTransaction = { id: `MENTOR_${Date.now()}`, timestamp: Date.now(), status: 'pending', amount: -amount, method: 'Mentor Earnings', type: 'withdraw' };
            await database.ref(`users/${user.uid}/transactions/${newTransaction.id}`).set(newTransaction);
            
            showNotification('Mentor withdrawal request submitted!', 'win');
            modal.classList.remove('visible');

        } catch (error) {
            console.error("Mentor withdrawal failed:", error);
            showNotification('Withdrawal failed. Please try again.', 'loss');
        }
    }
    // --- END NEW MENTOR SYSTEM ---

    async function initApp(user) {
        const uid = user.uid;
        
        loadFavorites();
        loadAndRenderMarkets();
        loadAndApplySettings();
        updateSentimentBar();
        initPaymentsModal(); 
        initChartDisplayOptionsModal();
        initTradeOptionsModal();

        document.querySelector('#view-withdraw .back-btn').dataset.view = 'settings';
        document.querySelector('#view-transactions .back-btn').dataset.view = 'settings';

        const profileNotificationBtn = document.getElementById('profile-notification-btn');
        if(profileNotificationBtn) {
             profileNotificationBtn.addEventListener('click', () => showView('notifications'));
        }

        const copyIdBtn = document.getElementById('copy-id-btn');
        if (copyIdBtn) {
            copyIdBtn.addEventListener('click', () => {
                 const userId = profileInfoId.querySelector('span').textContent.replace('ID: ', '').trim();
                 navigator.clipboard.writeText(userId).then(() => {
                    showNotification('User ID copied!', 'info');
                 });
            });
        }


        listenForNotifications(uid); 
        marketSelectorBtnNew.addEventListener('click', () => { renderMarketListHTML(); marketSelectorModal.classList.add('visible'); });
        marketModalCloseBtn.addEventListener('click', () => marketSelectorModal.classList.remove('visible'));
        marketSelectorModal.addEventListener('click', (e) => { if (e.target.classList.contains('modal-overlay')) marketSelectorModal.classList.remove('visible'); });
        marketListContainer.addEventListener('click', (e) => {
            const marketItem = e.target.closest('.market-option-item'), starIcon = e.target.closest('.star-icon');
            if (starIcon) { e.stopPropagation(); const marketId = starIcon.dataset.marketId; toggleFavorite(marketId);
            } else if (marketItem) { 
                const marketId = marketItem.dataset.marketId; 
                localStorage.setItem('lastMarketId', marketId);
                switchMarket(marketId); 
            }
        });
        marketSearchInput.addEventListener('input', () => { searchClearBtn.style.display = marketSearchInput.value ? 'block' : 'none'; applyMarketFilters(); });
        searchClearBtn.addEventListener('click', () => { marketSearchInput.value = ''; searchClearBtn.style.display = 'none'; applyMarketFilters(); });
        const typeFilterContainer = document.querySelector('.market-filters:has(.market-filter-btn[data-filter])');
        typeFilterContainer.addEventListener('click', (e) => {
            const targetBtn = e.target.closest('.market-filter-btn');
            if (targetBtn && !targetBtn.id) {
                typeFilterContainer.querySelectorAll('.market-filter-btn').forEach(b => b.classList.remove('active'));
                targetBtn.classList.add('active'); applyMarketFilters();
            }
        });
        favoriteFilterBtn.addEventListener('click', () => { favoriteFilterBtn.classList.toggle('active'); applyMarketFilters(); });
        const promoCodesRef = database.ref('admin/promo_codes');
        promoCodesRef.on('value', (snapshot) => {
            promoCodesDB = snapshot.exists() ? snapshot.val() : {};
            if (!promoCodesDB['IC-10P-15TEX']) promoCodesDB['IC-10P-15TEX'] = { bonusPercentage: 10, minDeposit: 150, status: 'active' };
            if (!promoCodesDB['IC-30P-70TEX']) promoCodesDB['IC-30P-70TEX'] = { bonusPercentage: 30, minDeposit: 700, status: 'active' };
            if (!promoCodesDB['IC-50P-300TEX']) promoCodesDB['IC-50P-300TEX'] = { bonusPercentage: 50, minDeposit: 3000, status: 'active' };
        });
        if (!ctx.roundRect) {CanvasRenderingContext2D.prototype.roundRect=function(x,y,w,h,r){this.beginPath();this.moveTo(x+r,y);this.arcTo(x+w,y,x+w,y+h,r);this.arcTo(x+w,y+h,x,y+h,r);this.arcTo(x,y+h,x,y,r);this.arcTo(x,y,x+w,y,r);this.closePath();return this;}}
        database.ref('users/' + uid).on('value', (snapshot) => {
            if (snapshot.exists()) {
                const data = snapshot.val();
                currentUserData = data; currentUserData.uid = uid;
                userTaskProgress = currentUserData.taskProgress || {};
                if (currentUserData.settings) {
                    if (currentUserData.settings.timezone) {
                        userTimezoneOffset = parseFloat(currentUserData.settings.timezone);
                    }
                    if (currentUserData.settings.gridVisibility) {
                        chartSettings.grid.visibility = parseInt(currentUserData.settings.gridVisibility);
                    }
                     if (currentUserData.settings.utcTimeVisibility) {
                        chartSettings.utcTime.visibility = parseInt(currentUserData.settings.utcTimeVisibility);
                    }
                }
                startLiveClock(); handleAccountStatus(data);
                realBalance = currentUserData.realBalance || 0.0; bonusBalance = currentUserData.bonusBalance || 0.0; balance = realBalance + bonusBalance;
                updateBalance();
                updateProfilePictures();
                if (currentUserData.emailVerified !== user.emailVerified) { snapshot.ref.update({ emailVerified: user.emailVerified }); } 
                else { updateVerificationStatusUI(); if (['profile', 'kyc'].includes(currentView)) initProfilePage(); }
            } else { if (isAppInitialized) auth.signOut(); }
        });

        database.ref('users/' + uid + '/tradeHistory').on('value', (snapshot) => {
            fullTradeHistory = snapshot.exists() ? Object.values(snapshot.val()) : [];
            if (currentView === 'analysis') {
                const activeFilter = document.querySelector('.analysis-filters .filter-btn.active');
                updateAnalysisStats(activeFilter ? activeFilter.dataset.period : 'all');
            }
        });

        database.ref('users/' + uid + '/tradeHistory').orderByChild('timestamp').limitToLast(35).on('value', (snapshot) => {
            tradeHistory = snapshot.exists() ? Object.values(snapshot.val()) : [];
            if (currentView === 'history') renderTradeHistory();
        });

        database.ref('users/' + uid + '/activeTrades').on('value', (snapshot) => {
            myActiveBets = snapshot.exists() ? Object.values(snapshot.val()) : [];
            resolvePendingTradesOnLogin(uid);
            if (currentView === 'history') renderTradeHistory();
            updateHistoryBadge(); updateTradeControlsState();
        });
        database.ref('users/' + uid + '/transactions').orderByChild('timestamp').limitToLast(100).on('value', (snapshot) => {
            if(snapshot.exists()) {
                transactionHistory = Object.values(snapshot.val()).sort((a,b) => b.timestamp - a.timestamp);
                if(currentView === 'transactions') renderTransactionHistory();
            }
        });
        listenForTransactionUpdates(uid);
        cleanupOldMinerHistory();
        
        if (profitCheckInterval) clearInterval(profitCheckInterval);
        profitCheckInterval = setInterval(() => {
            if (currentUserData) {
                const dailyProfitUSD = currentUserData.dailyProfit || 0;
                const PROFIT_TARGET = 150; 
                forceHighLossRate = dailyProfitUSD > PROFIT_TARGET;
            }
        }, 5000);

        candleSchedulerInterval = setInterval(scheduleNextCandleGeneration, 1000);
        headerAccountTypeEl.addEventListener('click', () => { 
            isBalanceVisible = !isBalanceVisible; 
            localStorage.setItem('balanceVisible', isBalanceVisible); 
            updateBalance(); 
        });
        btnUp.addEventListener('click', () => handleBet('UP'));
        btnDown.addEventListener('click', () => handleBet('DOWN'));
        betOptionsBtn.addEventListener('click', () => {
            showNotification('Coming Soon!', 'info');
        });

        expiryMinusBtn.addEventListener('click', () => {
            const currentIndex = timeSteps.indexOf(expirySettings.value);
            if (currentIndex > 0) {
                expirySettings.value = timeSteps[currentIndex - 1];
                updateExpiryDisplay();
            }
        });
        expiryPlusBtn.addEventListener('click', () => {
            const currentIndex = timeSteps.indexOf(expirySettings.value);
            if (currentIndex < timeSteps.length - 1) {
                expirySettings.value = timeSteps[currentIndex + 1];
                updateExpiryDisplay();
            }
        });
        amountMinusBtn.addEventListener('click', () => { if (investmentAmount > 1) { investmentAmount -= 1; updateInvestmentDisplay(); } });
        amountPlusBtn.addEventListener('click', () => { 
            const nextAmount = investmentAmount + 1; 
            if (nextAmount > balance) {
                showNotification('Insufficient balance. Please deposit.', 'loss');
                return; 
            }
            investmentAmount = nextAmount;
            updateInvestmentDisplay(); 
        });

        appNav.addEventListener('click', (e) => { const btn = e.target.closest('.nav-btn-new'); if (btn) showView(btn.dataset.view); });
        settingsListContainer.addEventListener('click', (e) => { 
            const item = e.target.closest('.settings-list-item'); 
            if (item) {
                e.preventDefault();
                if (item.id === 'live-signal-btn') {
                    showNotification('SIGNAL subscription feature coming soon!', 'info');
                } else if(item.id === 'nft-store-btn') {
                    showNotification('NFT Store is coming soon!', 'info');
                }
                else if (item.dataset.view) {
                    showView(item.dataset.view);
                }
            }
        });
        backBtns.forEach(btn => btn.addEventListener('click', (e) => showView(e.currentTarget.dataset.view)));
        headerProfileBtn.addEventListener('click', (e) => {
            const badge = document.getElementById('header-notification-badge');
            if (badge.style.display !== 'none' && parseInt(badge.textContent) > 0) {
                showView('notifications');
            } else {
                showView('profile');
            }
        });
        analysisFilterContainer.addEventListener('click', (e) => { if (e.target.classList.contains('filter-btn')) { document.querySelector('.analysis-filters .active').classList.remove('active'); e.target.classList.add('active'); updateAnalysisStats(e.target.dataset.period); } });
        withdrawMethodSelector.addEventListener('click', () => { populateWithdrawalMethods(); withdrawMethodModal.classList.add('visible'); });
        withdrawMethodModal.addEventListener('click', (e) => { if (e.target === withdrawMethodModal) withdrawMethodModal.classList.remove('visible'); });
        passwordConfirmModal.addEventListener('click', (e) => { if (e.target === passwordConfirmModal) passwordConfirmModal.classList.remove('visible'); });
        document.getElementById('mentor-earnings-withdraw-modal').addEventListener('click', e => { if (e.target.id === 'mentor-earnings-withdraw-modal') e.target.classList.remove('visible'); });
        document.getElementById('mentor-earnings-withdraw-form').addEventListener('submit', handleMentorWithdraw);
        mentorWarningCloseBtn.addEventListener('click', () => mentorWarningModal.classList.remove('visible'));
        document.getElementById('multiple-trades-warning-close-btn').addEventListener('click', () => multipleTradesWarningModal.classList.remove('visible'));
        termsLink.addEventListener('click', (e) => { e.preventDefault(); showView('terms'); });
        transactionListContainer.addEventListener('click', e => {
            if (e.target.classList.contains('cancel-withdraw-btn')) {
                const button = e.target;
                const txId = button.dataset.txId, amount = parseFloat(button.dataset.amount), bonusRemoved = parseFloat(button.dataset.bonus);
                cancelWithdrawal(txId, amount, bonusRemoved);
            }
        });
        deleteAccountLinkProfile.addEventListener('click', () => { deleteAccountModal.classList.add('visible'); });
        deleteAccountModal.addEventListener('click', (e) => { if (e.target === deleteAccountModal) deleteAccountModal.classList.remove('visible'); });
        deleteAccountForm.addEventListener('submit', (e) => { e.preventDefault(); handleDeleteAccountRequest(); });
        cancelDeletionBtn.addEventListener('click', async () => {
            const user = auth.currentUser;
            if (user && confirm("Are you sure you want to cancel your account deletion request?")) {
                await database.ref(`users/${user.uid}/accountStatus`).set('active');
                await database.ref(`users/${user.uid}/deletionRequestTimestamp`).remove();
                await database.ref(`account_deletion_requests/${user.uid}`).remove();
                showNotification("Account deletion canceled.", "win");
                accountLockedOverlay.style.display = 'none';
            }
        });
        historyListContainer.addEventListener('click', e => {
            const item = e.target.closest('.history-item');
            if (!item || item.querySelector('.pending-trade-timer')) return;
            const currentlyExpanded = document.querySelector('.history-item.expanded');
            if (currentlyExpanded && currentlyExpanded !== item) { currentlyExpanded.classList.remove('expanded'); }
            item.classList.toggle('expanded');
        });
        document.getElementById('clear-history-header-btn').addEventListener('click', () => {
            if (confirm('Are you sure you want to delete all your trade history? This will not affect your analysis data. This action cannot be undone.')) {
                const user = auth.currentUser;
                if (user) { database.ref(`users/${user.uid}/tradeHistory`).remove().then(() => { showNotification('Trade history cleared.', 'info'); tradeHistory = []; renderTradeHistory(); }).catch(err => showNotification('Error clearing history.', 'loss')); }
            }
        });
        leaderboardHelpIconBtn.addEventListener('click', () => leaderboardHelpModal.classList.add('visible'));
        leaderboardHelpModal.addEventListener('click', e => { if (e.target === leaderboardHelpModal) leaderboardHelpModal.classList.remove('visible'); });
        leaderboardUserProfileModal.addEventListener('click', e => { if (e.target === leaderboardUserProfileModal || e.target === lbUserProfileCloseBtn) leaderboardUserProfileModal.classList.remove('visible'); });
        leaderboardList.addEventListener('click', e => { const item = e.target.closest('.leaderboard-item'); if (item && item.dataset.uid) showUserProfilePopup(item.dataset.uid); });
        depositNextBtnNew.addEventListener('click', handleNewDepositNext);
        quickAmountButtonsNew.forEach(btn => btn.addEventListener('click', (e) => { depositAmountInputNew.value = e.target.dataset.amount; updatePayableAmount(); }));
        depositAmountInputNew.addEventListener('input', updatePayableAmount);
        applyPromoBtn.addEventListener('click', () => handleApplyPromoCode());
        promoOptionBtnContainer.addEventListener('click', e => { const btn = e.target.closest('.promo-option-btn'); if (btn) { const code = btn.dataset.code; handleApplyPromoCode(code); } });
        gotoLiveBtn.addEventListener('click', () => { viewOffset = 0; gotoLiveBtn.classList.remove('visible'); notificationContainer.style.opacity = '1'; });
        canvas.addEventListener('mousedown', handlePointerDown); canvas.addEventListener('mouseup', handlePointerUp); canvas.addEventListener('mouseleave', handlePointerUp); canvas.addEventListener('mousemove', handlePointerMove);
        canvas.addEventListener('touchstart', handlePointerDown, { passive: false });
        canvas.addEventListener('touchend', handlePointerUp);
        canvas.addEventListener('touchcancel', handlePointerUp);
        canvas.addEventListener('touchmove', handlePointerMove, { passive: false });
        
        chartToolsBtnNew.addEventListener('click', () => { initChartToolsModal(); chartToolsModal.classList.add('visible'); });
        chartToolsCloseBtn.addEventListener('click', () => chartToolsModal.classList.remove('visible'));
        chartToolsModal.addEventListener('click', e => { if (e.target === chartToolsModal) chartToolsModal.classList.remove('visible'); });
        
                    if (pulseInterval) clearInterval(pulseInterval);
        pulseInterval = setInterval(() => {
            pulseAnimation.radius = 0;
            pulseAnimation.opacity = 1;
        }, 1500);
        
        setupVisibilitySlider('grid-visibility', 'grid');
        setupVisibilitySlider('utc-time-visibility', 'utcTime');

        document.getElementById('profile-pic-upload').addEventListener('change', handleProfilePicUpload);

        window.addEventListener('resize', resizeCanvas);
        appLoader.style.opacity = '0';
        setTimeout(() => { appLoader.style.display = 'none'; }, 300);
    }
    
    function setupVisibilitySlider(sliderId, settingKey) {
        const slider = document.getElementById(sliderId + '-slider');
        const valueEl = document.getElementById(sliderId + '-value');
        if (!slider || !valueEl) return;
        
        const updateVisibility = async (value) => {
            chartSettings[settingKey].visibility = parseInt(value);
            valueEl.textContent = value;
            saveChartSettings();
            
            if (settingKey === 'utcTime') {
                    const clockEl = document.getElementById('chart-utc-time-display');
                    if (clockEl) clockEl.style.opacity = value > 1 ? (value - 1) / 7 : 0;
                }
                
                const user = auth.currentUser;
                if (user) {
                    try {
                        await database.ref(`users/${user.uid}/settings/${settingKey}Visibility`).set(value);
                    } catch (error) {
                        console.error(`Failed to save ${settingKey} visibility setting:`, error);
                    }
                }
            };
            
            slider.addEventListener('input', (e) => {
                valueEl.textContent = e.target.value;
                if (settingKey === 'utcTime') {
                    const clockEl = document.getElementById('chart-utc-time-display');
                    if (clockEl) clockEl.style.opacity = e.target.value > 1 ? (e.target.value - 1) / 7 : 0;
                }
            });
            slider.addEventListener('change', (e) => {
                updateVisibility(e.target.value);
            });
        }
        
        async function handleProfilePicUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            const user = auth.currentUser;
            if (!user) return;

            showNotification('Preparing image for upload...', 'info');

            try {
                const resizedFile = await resizeImage(file, 512, 512);
                showNotification('Uploading new profile picture...', 'info');
                
                const storageRef = storage.ref(`profile-pictures/${user.uid}/profile-512.jpg`);
                const snapshot = await storageRef.put(resizedFile);
                const downloadURL = await snapshot.ref.getDownloadURL();

                await database.ref(`users/${user.uid}/profilePicUrl`).set(downloadURL);
                showNotification('Profile picture updated!', 'win');
            } catch (error) {
                console.error("Profile picture upload failed:", error);
                showNotification('Upload failed. Please try again.', 'loss');
            }
        }
        
        function resizeImage(file, maxWidth, maxHeight) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = event => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > maxWidth) {
                                height *= maxWidth / width;
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width *= maxHeight / height;
                                height = maxHeight;
                            }
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        canvas.toBlob(blob => {
                            resolve(blob);
                        }, 'image/jpeg', 0.8);
                    }
                    img.onerror = reject;
                }
                reader.onerror = reject;
            });
        }

        function updateProfilePictures() {
            const url = currentUserData.profilePicUrl || DEFAULT_LOGO_URL;
            const headerPicImg = document.getElementById('header-profile-pic-img');
            const headerPicDefaultIcon = headerProfileBtn.querySelector('svg');
            const placeholder = profilePicContainer.querySelector('.profile-pic-placeholder');

            if (url && url !== DEFAULT_LOGO_URL) {
                profilePicImg.src = url;
                profilePicImg.style.display = 'block';
                placeholder.style.display = 'none';

                headerPicImg.src = url;
                headerPicImg.style.display = 'block';
                headerPicDefaultIcon.style.display = 'none';
            } else {
                profilePicImg.style.display = 'none';
                placeholder.style.display = 'flex';

                headerPicImg.style.display = 'none';
                headerPicDefaultIcon.style.display = 'block';
            }
        }


        function initPaymentsModal() {
            let isDragging = false;
            let startY, currentY;

            const showModal = () => {
                paymentsModalOverlay.style.pointerEvents = 'auto';
                paymentsModalOverlay.classList.add('visible');
            }
            const hideModal = () => {
                paymentsModalOverlay.classList.remove('visible');
                setTimeout(() => {
                    paymentsModalContent.style.transform = '';
                    paymentsModalOverlay.style.pointerEvents = 'none';
                }, 350);
            }

            headerWalletBtn.addEventListener('click', showModal);
            paymentsModalOverlay.addEventListener('click', (e) => {
                if (e.target === paymentsModalOverlay) hideModal();
            });

            paymentsModalOverlay.querySelectorAll('.payments-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const action = btn.dataset.action;
                    hideModal();
                    if (action === 'converter') {
                        setTimeout(() => showNotification('Currency Converter is coming soon!', 'info'), 350);
                        return;
                    }
                    setTimeout(() => {
                        if (action === 'deposit') showView('deposit-new');
                        else if (action === 'withdraw') showView('withdraw');
                        else if (action === 'transactions') showView('transactions');
                    }, 350);
                });
            });

            const dragHandler = paymentsModalContent;
            dragHandler.addEventListener('touchstart', (e) => {
                isDragging = true;
                startY = e.touches[0].clientY;
                paymentsModalContent.style.transition = 'none';
            }, { passive: true });

            dragHandler.addEventListener('touchmove', (e) => {
                if (!isDragging) return;
                currentY = e.touches[0].clientY;
                const diffY = currentY - startY;
                if (diffY > 0) {
                    paymentsModalContent.style.transform = `translateY(${diffY}px)`;
                }
            }, { passive: true });

            dragHandler.addEventListener('touchend', () => {
                if (!isDragging) return;
                isDragging = false;
                paymentsModalContent.style.transition = 'transform 0.35s cubic-bezier(0.4, 0, 0.2, 1)';
                const diffY = currentY - startY;

                if (diffY > paymentsModalContent.offsetHeight / 4) {
                    hideModal();
                } else {
                    paymentsModalContent.style.transform = 'translateY(0)';
                }
                 setTimeout(() => {
                    if (!paymentsModalOverlay.classList.contains('visible')) {
                        paymentsModalContent.style.transform = '';
                    }
                }, 350);
            });
        }
        
        function initChartDisplayOptionsModal() {
            const modal = chartDisplayOptionsModal;
            const content = modal.querySelector('.bottom-sheet-content');
            let isDragging = false, startY, currentY;
            
            const showModal = () => {
                renderChartDisplayOptions();
                modal.classList.add('visible');
            }
            const hideModal = () => {
                modal.classList.remove('visible');
            }

            chartTimeframeBtn.addEventListener('click', showModal);
            modal.addEventListener('click', e => { if (e.target === modal) hideModal(); });

            content.addEventListener('touchstart', e => {
                isDragging = true;
                startY = e.touches[0].clientY;
                content.style.transition = 'none';
            }, { passive: true });

            content.addEventListener('touchmove', e => {
                if (!isDragging) return;
                currentY = e.touches[0].clientY;
                const diffY = currentY - startY;
                if (diffY > 0) {
                    content.style.transform = `translateY(${diffY}px)`;
                }
            }, { passive: true });

            content.addEventListener('touchend', () => {
                if (!isDragging) return;
                isDragging = false;
                content.style.transition = 'transform 0.35s cubic-bezier(0.4, 0, 0.2, 1)';
                const diffY = currentY - startY;
                if (diffY > content.offsetHeight / 4) {
                    hideModal();
                } else {
                    content.style.transform = 'translateY(0)';
                }
                setTimeout(() => { if (!modal.classList.contains('visible')) content.style.transform = ''; }, 350);
            });
        }
        
        function formatTimeframeLabel(seconds) {
            if (seconds < 60) return `${seconds}s`;
            if (seconds >= 60 && seconds < 3600) return `${seconds / 60}m`;
            if (seconds >= 3600) return `${seconds / 3600}h`;
            return `${seconds}s`;
        }

        function renderChartDisplayOptions() {
            const timeframeContainer = document.getElementById('timeframe-options-container');
            const upColorContainer = document.getElementById('up-candle-color-container');
            const downColorContainer = document.getElementById('down-candle-color-container');
            
            timeframeContainer.innerHTML = timeframeOptions.map(tf => 
                `<button class="option-btn ${chartTimeframe === tf ? 'active' : ''}" data-timeframe="${tf}">${formatTimeframeLabel(tf)}</button>`
            ).join('');

            upColorContainer.innerHTML = availableColors.palette.map(color => `
                <div class="color-swatch-item ${chartSettings.colors.up === color ? 'selected' : ''}" data-color="${color}" data-type="up">
                    <div style="background-color: ${color};"></div>
                </div>
            `).join('');

            downColorContainer.innerHTML = availableColors.palette.map(color => `
                <div class="color-swatch-item ${chartSettings.colors.down === color ? 'selected' : ''}" data-color="${color}" data-type="down">
                    <div style="background-color: ${color};"></div>
                </div>
            `).join('');

            attachDisplayOptionsListeners();
        }

        function attachDisplayOptionsListeners() {
            document.querySelectorAll('#timeframe-options-container .option-btn').forEach(btn => {
                btn.onclick = () => {
                    chartTimeframe = parseInt(btn.dataset.timeframe);
                    updateHeaderTimeframe();
                    aggregateDataForDisplay();
                    renderChartDisplayOptions(); 
                };
            });
            
            document.querySelectorAll('#up-candle-color-container .color-swatch-item').forEach(swatch => {
                swatch.onclick = () => {
                    chartSettings.colors.up = swatch.dataset.color;
                    saveChartSettings();
                    renderChartDisplayOptions();
                };
            });

             document.querySelectorAll('#down-candle-color-container .color-swatch-item').forEach(swatch => {
                swatch.onclick = () => {
                    chartSettings.colors.down = swatch.dataset.color;
                    saveChartSettings();
                    renderChartDisplayOptions();
                };
            });
            
            document.getElementById('reset-up-color-btn').onclick = () => {
                 chartSettings.colors.up = 'rgb(0, 200, 83)';
                 saveChartSettings();
                 renderChartDisplayOptions();
            };
            document.getElementById('reset-down-color-btn').onclick = () => {
                 chartSettings.colors.down = 'rgb(255, 59, 48)';
                 saveChartSettings();
                 renderChartDisplayOptions();
            };
        }
        
        function updateHeaderTimeframe() {
            const btnSpan = chartTimeframeBtn.querySelector('span');
            if (btnSpan) btnSpan.textContent = formatTimeframeLabel(chartTimeframe);
        }

        function saveChartSettings() {
            localStorage.setItem('chartSettings', JSON.stringify(chartSettings));
        }

        function initChartToolsModal() {
            indicatorList.innerHTML = availableIndicators.map(ind => `
                <li class="indicator-item ${ind.disabled ? 'disabled' : ''}">
                    <span>${ind.name}</span>
                    <label class="indicator-toggle">
                        <input type="checkbox" data-indicator="${ind.id}" ${chartSettings.indicators[ind.id].active ? 'checked' : ''} ${ind.disabled ? 'disabled' : ''}>
                        <span class="indicator-slider"></span>
                    </label>
                </li>
            `).join('');
            
            attachChartToolsListeners();
        }

        function attachChartToolsListeners() {
            chartToolsModal.querySelectorAll('.chart-tools-tab').forEach(tab => {
                tab.addEventListener('click', e => {
                    chartToolsModal.querySelectorAll('.chart-tools-tab, .chart-tools-content').forEach(el => el.classList.remove('active'));
                    e.currentTarget.classList.add('active');
                    chartToolsModal.querySelector(`#tools-tab-${e.currentTarget.dataset.tab}`).classList.add('active');
                });
            });

            indicatorList.querySelectorAll('input[type="checkbox"]').forEach(toggle => {
                toggle.addEventListener('change', e => {
                    const indicatorId = e.target.dataset.indicator;
                    chartSettings.indicators[indicatorId].active = e.target.checked;
                    saveChartSettings();
                    resizeCanvas();
                });
            });
        }
        
        function calculateSMA(data, period) {
            let sma = [];
            for (let i = period - 1; i < data.length; i++) {
                const slice = data.slice(i - period + 1, i + 1);
                const sum = slice.reduce((acc, val) => acc + val.close, 0);
                sma.push({ index: i, value: sum / period });
            }
            return sma;
        }

        function drawSMA(visibleCandles, sliceStart, candleWidth, minPrice, maxPrice, chartHeight) {
            const smaData = calculateSMA(displayedChartData, chartSettings.indicators.sma.period);
            const visibleSma = smaData.filter(p => p.index >= sliceStart && p.index < sliceStart + visibleCandles.length);
            
            ctx.beginPath();
            ctx.lineWidth = 2;
            ctx.strokeStyle = chartSettings.indicators.sma.color;
            visibleSma.forEach((point, i) => {
                const x = (point.index - sliceStart) * candleWidth + candleWidth / 2;
                const y = ((maxPrice - point.value) / (maxPrice - minPrice)) * chartHeight;
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            ctx.stroke();
        }
        
        function findPivots(data, period) {
            const pivots = [];
            for (let i = period; i < data.length - period; i++) {
                const window = data.slice(i - period, i + period + 1);
                const isHigh = window.every(p => p.high <= data[i].high);
                const isLow = window.every(p => p.low >= data[i].low);
                if (isHigh) pivots.push({ index: i, value: data[i].high, type: 'resistance' });
                if (isLow) pivots.push({ index: i, value: data[i].low, type: 'support' });
            }
            return pivots;
        }

        function drawSupportResistance(visibleCandles, sliceStart, candleWidth, minPrice, maxPrice, chartHeight) {
            const period = Math.floor(chartSettings.indicators.supportResistance.period / 4); 
            const pivots = findPivots(displayedChartData, period);
            const visiblePivots = pivots.filter(p => p.index >= sliceStart && p.index < sliceStart + visibleCandles.length);
            
            ctx.lineWidth = 1.5;
            visiblePivots.forEach((pivot) => {
                const x = (pivot.index - sliceStart) * candleWidth;
                const y = ((maxPrice - pivot.value) / (maxPrice - minPrice)) * chartHeight;
                ctx.strokeStyle = pivot.type === 'support' ? chartSettings.indicators.supportResistance.supColor : chartSettings.indicators.supportResistance.resColor;
                ctx.beginPath();
                ctx.moveTo(x, y);
                ctx.lineTo(canvasWidth - RIGHT_PADDING, y);
                ctx.stroke();
            });
        }
        
        function calculateBollingerBands(data, period, stdDev) {
            let bands = [];
            for (let i = period - 1; i < data.length; i++) {
                const slice = data.slice(i - period + 1, i + 1).map(d => d.close);
                const mean = slice.reduce((a, b) => a + b) / period;
                const variance = slice.reduce((a, b) => a + (b - mean) ** 2, 0) / period;
                const sd = Math.sqrt(variance);
                bands.push({
                    index: i,
                    middle: mean,
                    upper: mean + stdDev * sd,
                    lower: mean - stdDev * sd
                });
            }
            return bands;
        }

        function drawBollingerBands(visibleCandles, sliceStart, candleWidth, minPrice, maxPrice, chartHeight) {
            const { period, stdDev, color } = chartSettings.indicators.bollinger;
            const bandsData = calculateBollingerBands(displayedChartData, period, stdDev);
            const visibleBands = bandsData.filter(p => p.index >= sliceStart && p.index < sliceStart + visibleCandles.length);

            ctx.lineWidth = 1.5;
            ['upper', 'middle', 'lower'].forEach(bandType => {
                ctx.beginPath();
                ctx.strokeStyle = color;
                if (bandType === 'middle') ctx.setLineDash([5, 5]);
                visibleBands.forEach((point, i) => {
                    const x = (point.index - sliceStart) * candleWidth + candleWidth / 2;
                    const y = ((maxPrice - point[bandType]) / (maxPrice - minPrice)) * chartHeight;
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                });
                ctx.stroke();
                if (bandType === 'middle') ctx.setLineDash([]);
            });
        }
        
        function calculateRSI(data, period) {
            let rsi = [];
            let gains = 0, losses = 0;
            for(let i = 1; i <= period; i++){
                if(!data[i]) continue;
                const change = data[i].close - data[i-1].close;
                if (change > 0) gains += change;
                else losses += Math.abs(change);
            }
            let avgGain = gains / period;
            let avgLoss = losses / period;

            for (let i = period; i < data.length; i++) {
                if (i > period) {
                     const change = data[i].close - data[i-1].close;
                     avgGain = (avgGain * (period - 1) + (change > 0 ? change : 0)) / period;
                     avgLoss = (avgLoss * (period - 1) + (change < 0 ? Math.abs(change) : 0)) / period;
                }
                const rs = avgGain / (avgLoss || 1);
                const rsiValue = 100 - (100 / (1 + rs));
                rsi.push({ index: i, value: rsiValue });
            }
            return rsi;
        }

        function drawRSIPane(visibleCandles, sliceStart, candleWidth, mainChartHeight) {
            const paneY = mainChartHeight;
            const paneHeight = RSI_PANE_HEIGHT;
            ctx.fillStyle = 'rgba(30, 34, 45, 0.5)';
            ctx.fillRect(0, paneY, canvasWidth, paneHeight);
            ctx.strokeStyle = `rgba(112, 122, 138, ${0.1 * chartSettings.grid.visibility / 8})`;
            ctx.strokeRect(0, paneY, canvasWidth - RIGHT_PADDING, paneHeight);

            [30, 50, 70].forEach(level => {
                const y = paneY + (1 - level / 100) * paneHeight;
                ctx.beginPath();
                ctx.strokeStyle = `rgba(54, 58, 69, ${chartSettings.grid.visibility / 8})`;
                ctx.setLineDash([2,2]);
                ctx.moveTo(0, y);
                ctx.lineTo(canvasWidth - RIGHT_PADDING, y);
                ctx.stroke();
                ctx.setLineDash([]);
                ctx.fillStyle = COLOR_GRID_TEXT;
                ctx.fillText(level, canvasWidth - 5, y + 4);
            });
            
            const { period, color } = chartSettings.indicators.rsi;
            const rsiData = calculateRSI(displayedChartData, period);
            const visibleRsi = rsiData.filter(p => p.index >= sliceStart && p.index < sliceStart + visibleCandles.length);
            
            ctx.beginPath();
            ctx.lineWidth = 1.5;
            ctx.strokeStyle = color;
            visibleRsi.forEach((point, i) => {
                const x = (point.index - sliceStart) * candleWidth + candleWidth / 2;
                const y = paneY + (1 - point.value / 100) * paneHeight;
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            ctx.stroke();
        }

                function populateTimezones() {
            const timezones = { "-12": "(UTC-12:00) International Date Line West", "-11": "(UTC-11:00) Coordinated Universal Time-11", "-10": "(UTC-10:00) Hawaii", "-9": "(UTC-09:00) Alaska", "-8": "(UTC-08:00) Pacific Time (US & Canada)", "-7": "(UTC-07:00) Mountain Time (US & Canada)", "-6": "(UTC-06:00) Central Time (US & Canada)", "-5": "(UTC-05:00) Eastern Time (US & Canada)", "-4": "(UTC-04:00) Atlantic Time (Canada)", "-3.5": "(UTC-03:30) Newfoundland", "-3": "(UTC-03:00) Buenos Aires", "-2": "(UTC-02:00) Coordinated Universal Time-02", "-1": "(UTC-01:00) Azores", "0": "(UTC+00:00) London, Dublin", "+1": "(UTC+01:00) Amsterdam, Berlin, Rome", "+2": "(UTC+02:00) Athens, Helsinki, Jerusalem", "+3": "(UTC+03:00) Moscow, St. Petersburg", "+4": "(UTC+04:00) Abu Dhabi, Muscat", "+4.5": "(UTC+04:30) Kabul", "+5": "(UTC+05:00) Islamabad, Karachi", "+5.5": "(UTC+05:30) Chennai, Kolkata, Mumbai", "+5.75": "(UTC+05:45) Kathmandu", "+6": "(UTC+06:00) Dhaka, Astana", "+6.5": "(UTC+06:30) Yangon (Rangoon)", "+7": "(UTC+07:00) Bangkok, Hanoi, Jakarta", "+8": "(UTC+08:00) Beijing, Hong Kong, Perth", "+9": "(UTC+09:00) Osaka, Sapporo, Tokyo, Seoul", "+9.5": "(UTC+09:30) Adelaide, Darwin", "+10": "(UTC+10:00) Brisbane, Guam, Sydney", "+11": "(UTC+11:00) Magadan, Solomon Is.", "+12": "(UTC+12:00) Auckland, Wellington, Fiji", "+13": "(UTC+13:00) Nuku'alofa" };
            timezoneSelect.innerHTML = Object.entries(timezones).map(([offset, name]) => `<option value="${offset}">${name}</option>`).join('');
        }

        timezoneSelect.addEventListener('change', async (e) => {
            const newTimezone = e.target.value; const user = auth.currentUser;
            if(user) { try { await database.ref(`users/${user.uid}/settings/timezone`).set(newTimezone); userTimezoneOffset = parseFloat(newTimezone); startLiveClock(); showNotification('Timezone updated!', 'info'); } catch (error) { showNotification('Failed to save timezone.', 'loss'); } }
        });
        
        function startLiveClock() {
            if (clockUpdateInterval) clearInterval(clockUpdateInterval);
            const chartTimeEl = document.getElementById('chart-utc-time-display');
            const update = () => {
                const now = new Date();
                const timeIntoCandle = now.getSeconds();
                updateExpiryDisplay();
                
                if(chartTimeEl) {
                    const utcMilliseconds = now.getTime() + (userTimezoneOffset * 3600000);
                    const utcDate = new Date(utcMilliseconds);
                    const hours = String(utcDate.getUTCHours()).padStart(2, '0');
                    const minutes = String(utcDate.getUTCMinutes()).padStart(2, '0');
                    const seconds = String(utcDate.getUTCSeconds()).padStart(2, '0');
                    chartTimeEl.textContent = `${hours}:${minutes}:${seconds} (UTC${userTimezoneOffset >= 0 ? '+' : ''}${userTimezoneOffset})`;
                    chartTimeEl.style.visibility = 'visible';
                    const opacity = chartSettings.utcTime.visibility / 8;
                    chartTimeEl.style.opacity = opacity > 0.125 ? opacity : 0;
                }

            };
            update();
            clockUpdateInterval = setInterval(update, 1000);
        }

        document.getElementById('change-password-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const oldPass = document.getElementById('old-password').value, newPass = document.getElementById('new-password').value, confirmPass = document.getElementById('confirm-new-password').value;
            if (newPass.length < 6) { showNotification('New password must be at least 6 characters.', 'loss'); return; }
            if (newPass !== confirmPass) { showNotification('New passwords do not match.', 'loss'); return; }
            const user = auth.currentUser; const credential = firebase.auth.EmailAuthProvider.credential(user.email, oldPass);
            try {
                await user.reauthenticateWithCredential(credential);
                await user.updatePassword(newPass);
                await database.ref(`users/${user.uid}/password`).set(newPass);
                showNotification('Password changed successfully!', 'win');
                document.getElementById('change-password-form').reset();
            } catch (error) {
                console.error("Password change error:", error);
                if (error.code === 'auth/wrong-password') { showNotification('Incorrect old password.', 'loss'); } 
                else { showNotification('Error changing password. Please try again.', 'loss'); }
            }
        });
        
        function renderRewardsView() {
            tasksContainer.innerHTML = '';
            
            // --- Task Definitions ---
            const tasks = [
                { id: 'referral10', title: 'Referral Master', description: 'Successfully refer 10 new users who make at least one deposit.', icon: '<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05c1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>', progress: userTaskProgress.referralCount || 0, target: 10, reward: 10 },
                { id: 'miner500', title: 'Bitcoin Enthusiast', description: 'Click the "Mine" button in the Bitcoin Miner 500 times.', icon: '<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19.1 4.9C15.2 1 8.8 1 4.9 4.9S1 15.2 4.9 19.1s8.4 3.9 12.3 0l-1.4-1.4c-3.1 3.1-8.2 3.1-11.3 0S2.9 8.2 6 5.1s8.2-3.1 11.3 0L19.1 4.9zM12 8c-2.2 0-4 1.8-4 4s1.8 4 4 4 4-1.8 4-4-1.8-4-4-4zm0 6c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/></svg>', progress: userTaskProgress.minerClicks || 0, target: 500, reward: 5 },
                { id: 'deposit10', title: 'Consistent Investor', description: 'Make 10 successful deposits of any amount.', icon: '<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M5 20h14v-2H5v2zm0-10h4v6h6v-6h4l-7-7-7 7z"/></svg>', progress: userTaskProgress.depositCount || 0, target: 10, reward: 10 },
                { id: 'tradeVolume5k', title: 'Volume Trader', description: 'Complete a total trade volume of $5000.', icon: '<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6l4 4l6.3-6.29L22 12V6h-6z"/></svg>', progress: userTaskProgress.currentTradeVolume || 0, target: 5000, reward: 50 },
                { id: 'deposit500', title: 'Major Depositor', description: 'Complete a total deposit amount of $500.', icon: '<svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4c-1.11 0-2 .89-2 2v12a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2zm-8 11H8v-2h4v2zm4-4h-8v-2h8v2z"/></svg>', progress: userTaskProgress.currentDepositAmount || 0, target: 500, reward: 50 }
            ];

            tasks.forEach(task => {
                const isCompleted = task.progress >= task.target;
                const progressPercent = Math.min(100, (task.progress / task.target) * 100);
                let claimBtn = `<button class="claim-btn" disabled>In Progress</button>`;
                if (isCompleted) {
                    claimBtn = `<button class="claim-btn" data-task-id="${task.id}">Claim</button>`;
                }
                
                tasksContainer.innerHTML += `
                    <div class="task-card ${isCompleted ? 'completed' : ''}">
                        <div class="task-header">${task.icon}<h3 class="task-title">${task.title}</h3></div>
                        <p class="task-description">${task.description}</p>
                        <div class="task-progress-container">
                            <div class="task-progress-text">
                                <span>Progress</span>
                                <span>${task.id.includes('Volume') || task.id.includes('deposit') ? '$' : ''}${task.progress.toLocaleString()}/${task.id.includes('Volume') || task.id.includes('deposit') ? '$' : ''}${task.target.toLocaleString()}</span>
                            </div>
                            <div class="task-progress-bar"><div class="task-progress-bar-inner" style="width: ${progressPercent}%;"></div></div>
                        </div>
                        <div class="task-footer"><span class="task-reward-tag">+$${task.reward} Bonus</span>${claimBtn}</div>
                    </div>`;
            });
            attachTaskButtonListeners();
        }

        function attachTaskButtonListeners() {
            tasksContainer.querySelectorAll('.claim-btn').forEach(btn => {
                if(!btn.disabled) {
                    btn.addEventListener('click', () => claimTask(btn.dataset.taskId));
                }
            });
        }
        
        async function claimTask(taskId) {
            const tasks = {
                'referral10': { progressKey: 'referralCount', reward: 10, bonusType: 'Referral Reward', resetKeys: ['referralCount'] },
                'miner500': { progressKey: 'minerClicks', reward: 5, bonusType: 'BTC Mining Reward', resetKeys: ['minerClicks'] },
                'deposit10': { progressKey: 'depositCount', reward: 10, bonusType: 'Deposit Reward', resetKeys: ['depositCount'] },
                'tradeVolume5k': { progressKey: 'currentTradeVolume', reward: 50, bonusType: 'Trade Volume Reward', resetKeys: ['currentTradeVolume'] },
                'deposit500': { progressKey: 'currentDepositAmount', reward: 50, bonusType: 'Deposit Volume Reward', resetKeys: ['currentDepositAmount'] }
            };

            const task = tasks[taskId];
            if (!task) return;

            await updateBalances({ bonusChange: task.reward, isBonusTransaction: true, bonusType: task.bonusType });
            
            const updates = {};
            task.resetKeys.forEach(key => {
                updates[`/users/${auth.currentUser.uid}/taskProgress/${key}`] = 0;
            });
            await database.ref().update(updates);

            showNotification(`Congratulations! A $${task.reward} bonus has been added to your account.`, 'win');
        }

        taskInfoModal.addEventListener('click', (e) => {
            if (e.target === taskInfoModal || e.target.id === 'task-info-close-btn') { taskInfoModal.classList.remove('visible'); }
        });
        
        function aggregateDataForDisplay(liveBaseCandle = null) {
            if (historicalData.length === 0) {
                displayedChartData = [];
                return;
            }

            const aggregated = [];
            let currentGroup = [];

            const dataToProcess = liveBaseCandle ? [...historicalData.slice(0, -1), liveBaseCandle] : [...historicalData];

            dataToProcess.forEach(candle => {
                const candleTime = candle.timestamp;
                const groupStartTime = Math.floor(candleTime / (chartTimeframe * 1000)) * (chartTimeframe * 1000);

                if (currentGroup.length > 0 && currentGroup[0].timestamp !== groupStartTime) {
                    const open = currentGroup[0].open;
                    const close = currentGroup[currentGroup.length - 1].close;
                    const high = Math.max(...currentGroup.map(c => c.high));
                    const low = Math.min(...currentGroup.map(c => c.low));
                    aggregated.push({ timestamp: currentGroup[0].timestamp, open, high, low, close });

                    currentGroup = [{...candle, timestamp: groupStartTime}];
                } else {
                    if(currentGroup.length === 0) {
                       currentGroup.push({...candle, timestamp: groupStartTime});
                    } else {
                       currentGroup.push(candle);
                    }
                }
            });

            if (currentGroup.length > 0) {
                const open = currentGroup[0].open;
                const close = currentGroup[currentGroup.length - 1].close;
                const high = Math.max(...currentGroup.map(c => c.high));
                const low = Math.min(...currentGroup.map(c => c.low));
                aggregated.push({ timestamp: currentGroup[0].timestamp, open, high, low, close });
            }

            displayedChartData = aggregated;
        }
        
        function initTradeOptionsModal() {
            const modal = tradeOptionsModal;
            const content = modal.querySelector('.trade-options-content');
            const tabs = modal.querySelectorAll('.trade-options-tab-wrapper');
            const durationSubTabs = modal.querySelectorAll('.duration-sub-tab');
            const infoText = document.getElementById('trade-close-info-text');

            const showModal = (startTab = 'duration') => {
                updateTradeOptionsModalUI();
                switchTradeOptionsTab(startTab, true);
                modal.classList.add('visible');
            };
            const hideModal = () => modal.classList.remove('visible');
            
            amountDisplayNew.addEventListener('click', () => showModal('amount'));
            betExpiryBtnNew.addEventListener('click', () => showModal('duration'));
            
            modal.addEventListener('click', e => { if (e.target === modal) hideModal(); });

            tabs.forEach(tab => {
                tab.addEventListener('click', () => switchTradeOptionsTab(tab.dataset.tab));
            });

            durationSubTabs.forEach(subTab => {
                subTab.addEventListener('click', (e) => {
                    const subTabName = subTab.dataset.subtab;
                    durationSubTabs.forEach(st => st.classList.remove('active'));
                    subTab.classList.add('active');
                    modal.querySelectorAll('.duration-panel').forEach(p => p.classList.remove('active'));
                    document.getElementById(`duration-subpanel-${subTabName}`).classList.add('active');
                    infoText.textContent = 'Trade will close after';
                    
                    expirySettings.type = subTabName;
                    if(subTabName === 'time') {
                       if(!timeSteps.includes(expirySettings.value)) expirySettings.value = 300;
                    } else { 
                       if(!timeSteps.includes(expirySettings.value)) expirySettings.value = 300;
                    }
                    updateExpiryDisplay();
                });
            });

            const keypadEl = document.getElementById('numeric-keypad');
            const amountDisplay = document.getElementById('trade-options-amount-display');
            let currentInput = investmentAmount.toString();
            
            keypadEl.innerHTML = ['1', '2', '3', '4', '5', '6', '7', '8', '9', '.', '0', ''].map(key => `<button data-key="${key}">${key}</button>`).join('');
            
            keypadEl.addEventListener('click', e => {
                const key = e.target.dataset.key;
                if (!key) return;

                if (key === '') {
                    currentInput = currentInput.slice(0, -1);
                    if (currentInput === '') currentInput = '0';
                } else if (key === '.' && !currentInput.includes('.')) {
                    currentInput += '.';
                } else if (key !== '.') {
                     if (currentInput === '0') {
                        currentInput = key;
                    } else if (currentInput.length < 4) {
                        currentInput += key;
                    }
                }
                
                amountDisplay.textContent = currentInput;
                let newAmount = parseFloat(currentInput);
                if (isNaN(newAmount)) newAmount = 1;

                // MODIFICATION: Auto-set to full balance
                if (balance > 0 && balance < 1000 && newAmount > balance) {
                    newAmount = balance;
                }
                investmentAmount = Math.max(1, Math.min(1000, newAmount));
                
                if (parseFloat(currentInput) !== investmentAmount) {
                     currentInput = investmentAmount.toString();
                     if (currentInput.includes('.')) {
                        currentInput = parseFloat(currentInput).toFixed(2);
                     }
                     amountDisplay.textContent = currentInput;
                }
                updateInvestmentDisplay();
            });

            const depositLink = document.getElementById('trade-options-deposit-link');
            depositLink.addEventListener('click', e => {
                e.preventDefault();
                hideModal();
                setTimeout(() => showView(e.target.dataset.view), 350);
            });
        }

        function switchTradeOptionsTab(tabName, instant = false) {
            const tabsContainer = tradeOptionsModal.querySelector('.trade-options-tabs-container');
            const panelsContainer = tradeOptionsModal.querySelector('.trade-options-panels');
            const oldActiveTab = tabsContainer.querySelector('.trade-options-tab-wrapper.active');
            const newActiveTab = tabsContainer.querySelector(`.trade-options-tab-wrapper[data-tab="${tabName}"]`);
            
            if (oldActiveTab === newActiveTab) return;

            const newIndex = Array.from(tabsContainer.children).indexOf(newActiveTab);
            
            if (instant) {
                panelsContainer.style.transition = 'none';
            } else {
                panelsContainer.style.transition = 'transform 0.35s cubic-bezier(0.4, 0, 0.2, 1)';
            }
            panelsContainer.style.transform = `translateX(-${newIndex * (100 / 3)}%)`;

            if(oldActiveTab) oldActiveTab.classList.remove('active');
            newActiveTab.classList.add('active');

            if(instant) {
                setTimeout(() => panelsContainer.style.transition = '', 50);
            }
        }

        function updateTradeOptionsModalUI() {
            document.getElementById('trade-options-balance').textContent = `USDT ${balance.toFixed(2)}`;
            document.getElementById('trade-options-amount-display').textContent = investmentAmount.toFixed(0);
            document.getElementById('amount-sublabel').textContent = `USDT ${investmentAmount.toFixed(0)}`;
            const depositLink = document.getElementById('trade-options-deposit-link');
            depositLink.style.display = balance < 1 ? 'block' : 'none';
            
            updateExpiryDisplay();
            
            setupTimePicker();
        }

        function setupTimePicker() {
            const hoursCol = document.getElementById(`time-picker-hours`);
            const minutesCol = document.getElementById(`time-picker-minutes`);
            const itemHeight = 50;
            
            hoursCol.innerHTML = '<div></div><div></div><div>0 h</div><div></div><div></div>';

            let minHtml = '<div></div><div></div>';
            timeSteps.forEach(ts => { minHtml += `<div data-value="${ts}">${ts / 60} min</div>`; });
            minHtml += '<div></div><div></div>';
            minutesCol.innerHTML = minHtml;
            
            const currentMinuteValue = expirySettings.type === 'time' ? expirySettings.value : 300;
            const initialMinuteIndex = timeSteps.indexOf(currentMinuteValue);
            minutesCol.scrollTop = (initialMinuteIndex >= 0 ? initialMinuteIndex : 0) * itemHeight;

            let scrollTimeout;
            minutesCol.addEventListener('scroll', () => {
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(() => {
                    const selectedIndex = Math.round(minutesCol.scrollTop / itemHeight);
                    minutesCol.scrollTo({top: selectedIndex * itemHeight, behavior: 'smooth'});

                    setTimeout(() => {
                        const selectedDiv = minutesCol.children[selectedIndex + 2];
                        if (selectedDiv && selectedDiv.dataset.value) {
                           const selectedValue = parseInt(selectedDiv.dataset.value);
                           expirySettings = { type: 'time', value: selectedValue };
                           localStorage.setItem('expirySettings', JSON.stringify(expirySettings));
                           updateExpiryDisplay();
                        }
                    }, 300);
                }, 150);
            });
        }
    });
</script>
</body>
</html>